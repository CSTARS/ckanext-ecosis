<polymer-element name="esis-attribute-map">
	<template>
		<style>
			h4 {
				border-bottom: 1px solid #eee;
				padding-bottom: 5px;
			}
		</style>

    	<span>If your metadata attribute names do not match <a>this</a> list, you can download the attribute map file.  Fill out the file and then upload in the box to the right.  You can reuse this file, so you only have to fill it out once for your data.  Just make sure to set the attribute map for each dataset you add.</span>

    	<div horizontal layout style="margin-top:25px">
    		<div flex>
    			<a class="btn btn-default" target="_blank" href="/metadata_map">Download Map Template</a>
    		</div>
    		<div flex>
    			Upload Map: <input type="file" style="margin-top:5px" id="map" name="map" on-change="{{_processMap}}">
    		</div>
    	</div>

    	<template bind if="{{attrMapList.length > 0}}">
    		<h4 style="margin-top:50px">Current Attribute Mappings</h4>
    		<template repeat="{{item, i in attrMapList}}">
    			<div layout horizontal>
    				<div flex><b>{{item.c1[0]}}:</b> <span style="color:#888">{{item.c1[1]}}</span></div>
    				<div flex><b>{{item.c2[0]}}:</b> <span style="color:#888">{{item.c2[1]}}</span></div>
    			</div>
    		</template>
    	</template>
	</template>
	<script>
		Polymer('esis-attribute-map', {
			files : [],

			map : {},
			attrMapList : [],
			menuItem : null,

			observe : {
				files : '_updateVisibility',
				map   : '_updateAttrMapList'
			},

			ready : function() {
				 window.addEventListener('polymer-ready', function(e) {
				 	this.async(function(){
				 		this.files = document.querySelector('esis-datastore').files;
				 		this.map = document.querySelector('esis-datastore').attributeMap;
				 	});
				}.bind(this));
			},

			_updateVisibility : function() {
				if( this.files.length > 0 ) {
					this.menuItem.style.display = 'block';
				} else {
					this.menuItem.style.display = 'none';
				}
			},

			_processMap : function(e) {
				e.stopPropagation();
				e.preventDefault();

				var files = e.dataTransfer ? e.dataTransfer.files : e.target.files;
				if( files.length == 0 ) return;

				var reader = new FileReader();
				var contents, parts;

				reader.onload = function(e) {
					var newMap = {};
					contents = e.target.result.split('\n');

					for( var i = 0; i < contents.length; i++ ) {
						if( contents[i].indexOf('=') > -1 ) {
							parts = contents[i].split('=');
							newMap[parts[0]] = parts[1];
							//if( parts[1].length > 0 ) inverseMap[parts[1]] = parts[0];
						}
					}

					this.$.map.value = '';
					this._updateAttrMapList(newMap);
				}.bind(this);

				reader.readAsText(files[0]);
			},

			_updateAttrMapList : function(newMap) {
				this.attrMapList = [];

				var c = 0, item = {};
				var map = newMap || this.map;
				for( var key in map ) {
					if( map[key] && map[key].length > 0 ) {
						if( c % 2 != 0 ) {
							item['c2'] = [key, map[key]];
							this.attrMapList.push(item);
						} else {
							item = { c1 : [key, map[key]]};
						}
						c++;
					}
				}

				if( newMap ) document.querySelector('esis-datastore').attributeMap = newMap;
				this.menuItem.setSecondaryHtml(c+' Attributes Mapped');
			}

		});
	</script>
</polymer-element>