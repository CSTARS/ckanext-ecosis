<link rel="import" href="../../components/paper-checkbox/paper-checkbox.html" />
<link rel="import" href="../ui/esis-ui-file.html" />

<polymer-element name="esis-add-resource">
	<template>
		<link rel="stylesheet" href="../../components/animate-css/animate.min.css" no-shim>

		<style>
			paper-checkbox {
				padding: 20px;
			}
			#dropZone {
				border: 2px dashed #bbb;
				-moz-border-radius: 5px;
				-webkit-border-radius: 5px;
				border-radius: 5px;
				padding: 25px;
				text-align: center;
				font-size: 20pt;
				color: #bbb;
				background-color: white;
			}
			.processing-label {
				position: absolute;
				top: 0;
			}
			.fileinput.processing {
				visibility: hidden;
			}
		</style>

		<div horizontal layout>
		    <paper-checkbox checked="{{parseZip}}"></paper-checkbox>
		    <div vertical layout>
		     	<h4>Extract Zip Files</h4>
		     	<div>If a zip file is found, should its contents be imported as individual resources?  By default the spectra will be parsed, but the zip will be uploaded intact.</div>
		    </div>
		</div>

		<template bind if="{{processing}}">
	    	<div style="position:relative; text-align:center">
		    	<div class="processing-label">
		    		<h4>Processing Files...</h4>
		    	</div>
		    </div>
	    </template>

		<div class="fileinput {{processing ? 'processing' : ''}}">
			<div style="margin-left: 20px">
				<h4>Select a files to be imported</h4>
				<input type="file" style="margin:5px 0 0 33px" id="file" name="file" multiple="" on-change="{{_handleFileSelect}}">
			</div>

			<div class="file-select-group">
	        	<h4 style="text-align:center">- OR -</h4>
	        	<div id="dropZone">Drop files here</div>
	    	</div>
	    </div>

	    <template bind if="{{ds.files.length > 0}}">
	    	<div class="new-resources">
		    	<h2>New Files</h2>
		    	<template repeat="{{file in ds.files}}">
		    		<esis-ui-file file="{{file}}"></esis-ui-file>
		    	</template>
		    </div>
	    </template>
    	
		
	</template>
	<script>
		Polymer('esis-add-resource', {
			menuItem : null,
			ds : null,
			processing : false,
			parseZip : false,

			observe : {
				'ds.files' : '_updatePreview'
			},

			ready : function() {
				this.ds = document.querySelector('esis-datastore');
				this.$.dropZone.addEventListener('dragover', this._handleDragOver.bind(this), false);
				this.$.dropZone.addEventListener('drop', this._handleFileSelect.bind(this), false);
			},

			_handleDragOver : function (evt) {
		  		evt.stopPropagation();
		  		evt.preventDefault();
		  		evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
		  	},

		  	_handleFileSelect : function(evt) {
			    evt.stopPropagation();
			    evt.preventDefault();

			    this.processing = true;

			    var files = evt.dataTransfer ? evt.dataTransfer.files : evt.target.files; // FileList object.

			    setTimeout(function(){
				    for (var i = 0, f; f = files[i]; i++) {
				    	this.ds.addFile(f, this.parseZip);
			            //esis.structures.importer.addFile(f, $('#parseZip').is(':checked'));
				    }

				    setTimeout(function(){
			    		this.processing = false;
			    		this.$.file.value = '';
				    }.bind(this), 500);
			    }.bind(this), 150);

			    
			    // once they add spectra, we only want them to update the spectra.json file
			    // via the add resources button and not the special 'update group by' button.
			    //esis.app.groupBy.hideUpdateButton();
		  	},

		  	_updatePreview : function() {
		  		this.menuItem.setSecondaryHtml(this.ds.files.length+' File(s) Stagged');
		  	}
		});
	</script>
</polymer-element>