<link rel="import" href="esis-ui-card.html" />
<link rel="import" href="../../components/paper-button/paper-button.html" />
<link rel="import" href="../../components/core-collapse/core-collapse.html" />

<polymer-element name="esis-ui-datasheet" attributes="datasheet">
	<template>
		<style>
			esis-ui-card {
				margin: 10px 5px;
				padding: 5px;
			}
			table tr th {
				text-align: left;
			}
			h4 {
				margin: 5px;
			}
			.float-right {
				position: absolute;
				right: -20px;
				top: -10px;
			}
		</style>

		<esis-ui-card z="1">
			<h4><span style="color: #888">{{datasheet.title}}</span> <span style="float: right">Parser: {{datasheet.file.info.parser}}</span></h4>
			
			<template bind if="{{datasheet.file.error}}">
				<div style="color:red">Error {{datasheet.file.error}}</div>
			</template>
			<template bind if="{{datasheet.file.warning}}">
				<div style="color:orange">Warning: {{datasheet.file.warning}}</div>
			</template>



			<div>
				<paper-button on-tap="{{_toggle}}" label="More Info" style="color:blue"></paper-button>
				<core-collapse id="collapse">
					<template bind if="{{fileMetadata.length > 0}}">
						<h4>File Level Metadata</h4>
						<ul>
							<template repeat="{{item in fileMetadata}}">
								<li><b>{{item.key}}:</b> {{item.value}}</li>
							</template>
						</ul>
					</template>

					<template bind if="{{spectraMetadata.length > 0}}">
						<h4>Spectra Level Metadata Attributes</h4>
						<ul>
							<template repeat="{{key in spectraMetadata}}">
								<li>{{key}}</li>
							</template>
						</ul>
					</template>

					<template bind if="{{joinableMetadata.length > 0}}">
						<h4>Joinable Metadata Attributes</h4>
						<ul>
							<template repeat="{{key in joinableMetadata}}">
								<li>{{key}}</li>
							</template>
						</ul>
					</template>

					<template bind if="{{fileMetadata.length == 0 && spectraMetadata.length == 0 && joinableMetadata.length == 0}}">
						No spectra or metadata parsed from this file.
					</template>

					<div id="chart"></div>
				</core-collapse>
			</div>

		</esis-ui-card>
	</template>
	<script>
		Polymer('esis-ui-datasheet', {
			datasheet : {},

			open : false,

			fileMetadata : [],
			spectraMetadata : [],
			joinableMetadata : [],

			// chart vars
			dt : null,
			chart : null,
			maxLineCount : 30,

			observe : {
				datasheet : '_update'
			},

			_update : function() {
				this.joinableMetadata = [];
				this.spectraMetadata = [];
				this.fileMetadata = [];

				for( var key in this.datasheet.file.metadata ) {
					this.fileMetadata.push({key:key, value:this.datasheet.file.metadata[key]});
				}

				for( var i = 0; i < this.datasheet.spectra.length; i++ ) {
					var s = this.datasheet.spectra[0];
					for( var key in s.metadata ) {
						if( this.spectraMetadata.indexOf(key) == -1 ) {
							this.spectraMetadata.push(key);
						}
					}
				}

				if( this.datasheet.isMetadata && this.datasheet.metadata.metadata.length > 0 ) {
					for( var i = 0; i < this.datasheet.metadata.metadata[0].length; i++ ) {
						var key = this.datasheet.metadata.metadata[0][i];
						if( this.joinableMetadata.indexOf(key) == -1 ) {
							this.joinableMetadata.push(key);
						}
					}
				}
			},

			_toggle : function() {
				this.open = !this.open;

				if( this.open && this.datasheet.spectra.length > 0 ) {
					this.$.chart.style.height = '400px';
					setTimeout(function(){
						this._createChart();
					}.bind(this), 500);
				} else if( !this.open ) {
					this.chart = null;
					this.$.chart.innerHTML = '';
				}

				this.$.collapse.toggle();
			},

			_createChart : function() {
				if( !this.dt ) {
					this.dt = new google.visualization.DataTable();
			  		var rows = [];

					this.dt.addColumn('number', 'Wavelength');
					for( var i = 0; i < this.datasheet.spectra.length; i++ ) {
					  	if( i == this.maxLineCount ) break;
					    this.dt.addColumn('number', ''+i);
					}

					for( var i = 0; i < this.datasheet.spectra[0].data.length; i++ ) {

					  	// add the wavelength
					  	var row = [parseFloat(this.datasheet.spectra[0].data[i][0])];
					  	var addRow = true;

					  	for( var j = 0; j < this.datasheet.spectra.length; j++ ) {
					  		if( j == this.maxLineCount ) break;

					  		var f = parseFloat(this.datasheet.spectra[j].data[i][1]);
					  		if( isNaN(f) ) f = 0;
					  		if(  j == 0 && f == 0 ) {
					  			addRow = false;
					  			break;
					  		}

					  		row.push(f);
					  	}
					  	if( addRow ) rows.push(row);
					}

					rows.sort(function(a, b){
				    	if( a[0] > b[0] ) return 1;
				    	if( a[0] < b[0] ) return -1;
				    	return 0;
				    });

				    this.dt.addRows(rows);
				}
				this._draw();
			},

			_draw : function() {
				// Set chart options
			    var options = {
			        width : $(this.$.chart).width(),
			        height : 400,
			        legend : {
			          	position : 'none'
			        }
			    };

			      // Instantiate and draw our chart, passing in some options.
			    if( !this.chart ) this.chart = new google.visualization.LineChart(this.$.chart);
			    this.chart.draw(this.dt, options);
			}
		});
	</script>
<polymer-element>