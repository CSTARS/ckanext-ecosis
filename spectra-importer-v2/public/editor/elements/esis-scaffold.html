
<link rel="import" href="../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../components/core-header-panel/core-header-panel.html">
<link rel="import" href="../components/core-item/core-item.html">
<link rel="import" href="../components/core-menu/core-menu.html">
<link rel="import" href="../components/core-menu/core-submenu.html">
<link rel="import" href="../components/core-icon-button/core-icon-button.html">

<polymer-element name="esis-scaffold" attributes="label responsiveWidth">
<template>

  <link rel="stylesheet" href="esis-scaffold.css">

  <core-drawer-panel id="drawerPanel" narrow="{{narrow}}" responsiveWidth="{{responsiveWidth}}">

    <core-header-panel id="mainHeaderPanel" main mode="{{narrow ? 'waterfall' : 'cover'}}" shadow>

      <core-toolbar class="{{ {'medium-tall' : !narrow} | tokenList }}">
        <content select=".menuButton" on-tap="{{togglePanel}}">
          <core-icon-button class="menuButton fallback" icon="menu"></core-icon-button>
        </content>
        <div hidden?="{{!narrow}}">{{item.label}}</div>

        <content select=".sourceButton"></content>
      </core-toolbar>
      
      <div id="card" on-transitionend="{{cardTransitionDone}}" hidden?="{{!item}}">

        <div class="element-label" hidden?="{{narrow}}">{{item.label}}</div>

        <div id="frameContainer">
          <div id="elementRoot"></div>
        </div>
        
      </div>
      
    </core-header-panel>

    <core-header-panel drawer>

      <core-toolbar class="{{ {'medium-tall' : !narrow} | tokenList }}">
        <div class="bottom main-label fit">{{label}}</div>
      </core-toolbar>
      
      <core-menu id="menu" on-core-select="{{menuSelect}}">
        <content select="esis-item"></content>
      </core-menu>

    </core-header-panel>

  </core-drawer-panel>

</template>
<script>

  Polymer('esis-scaffold', {
    
    responsiveWidth: '860px',

    cEle : null,
    
    ready: function() {
      //this.boundResizeFrame = this.resizeFrame.bind(this);
      window.addEventListener('hashchange', this.parseLocationHash.bind(this));
    },
    
    domReady: function() {
      this.async(function() {
        this.parseLocationHash();
      }, null, 300);
    },
    
    parseLocationHash: function() {
      var route = window.location.hash.slice(1);
      for (var i = 0, item; item = this.$.menu.items[i]; i++) {
        if (item.getAttribute('tag') === route) {
          this.$.menu.selected = i;
          return;
        }
      }
      this.$.menu.selected = this.$.menu.selected || 0;
    },
    
    menuSelect: function(e, detail) {
      // check for back button
      if (detail.isSelected) {
        var tag = detail.item.getAttribute('tag');

        if( tag == 'back' ) {
          if( confirm('Are you sure you want to exit the dataset editor?') ) {
            var url = '/dataset';
            if( document.querySelector('esis-dataset-loader').pkgid ) {
              url += '/'+document.querySelector('esis-dataset-loader').pkgid;
            }
            window.location = url;
          } else {
            return;
          }
        }
      }

      if (detail.isSelected) {
        this.item = detail.item;

        if (this.item.children.length) {
          this.item.selected = 0;
        }
        this.item.tag = this.item.getAttribute('tag');
        
        if( this.cEle ) this.cEle.style.display = 'none';
        this.cEle = this.item.esisComponent;
        this.cEle.style.display = 'block';
        if( !this.cEle.isAttached ) {
          this.cEle.isAttached = true;
          this.$.elementRoot.appendChild(this.item.esisComponent);
        }
       
        
        if (this.narrow) {
          this.$.drawerPanel.closeDrawer();
        } else {
          this.animateCard();
        }
      }
    },
    
    animateCard: function() {
      this.$.card.classList.remove('move-up');
      this.$.card.style.display = 'none';
      this.async(function() {
        this.$.card.style.display = 'block';
        this.moveCard(this.$.mainHeaderPanel.offsetHeight);
        this.async(function() {
          this.$.card.classList.add('move-up');
          this.moveCard(null);
        }, null, 300);
      });
    },
    
    moveCard: function(y) {
      var s = this.$.card.style;
      s.webkitTransform = s.transform = 
          y ? 'translate3d(0, ' + y + 'px,0)' : '';
    },
    
    cardTransitionDone: function() {
      if (this.$.card.classList.contains('move-up')) {
        this.$.card.classList.remove('move-up');
        //this.updateFrameHeight();
      }
    },
    
    togglePanel: function() {
      this.$.drawerPanel.togglePanel();
    }
    
  });

</script>
</polymer-element>