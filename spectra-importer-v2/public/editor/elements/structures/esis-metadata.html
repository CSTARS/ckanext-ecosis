<polymer-element name="esis-metadata">
	<template></template>
	<script>
		Polymer('esis-metadata', {
			filename : '',
			metadata : [],
			joinId   : '',
			joinCol  : 0,

			filenameMatch : false,
			looseMatch : false,
			worksheetMatch : false,
			
			matchCount : null,
			resourceId : '',

			getJoinType : function() {
				if( this.filenameMatch ) {
					return {
						type : 'filename',
						loose : this.looseMatch
					};
				} else if ( this.worksheetMatch ) {
					return { type : 'worksheet' }
				} else {
					return { type : 'attribute' }
				}
			},

			_updateJoinRow : function() {
				if( this.metadata.length == 0 ) return;
		
				for( var i = 0; i < this.metadata[0].length; i++ ) {
					if( this.metadata[0][i] == this.joinId ) {
						this.joinCol = i;
						return;
					}
				}
			},

			join : function(spectra) {
				this._updateJoinRow();

				// set for existing data
				if( !spectra.metadata.joined ) spectra.metadata.joined = [];

				var row = this._getRow(spectra);
				if( row == -1 ) {
					// remove any known attribute from the join
					for( var j = 0; j < this.metadata[0].length; j++ ) {
						if( spectra.metadata.joined[this.metadata[0][j]] != null ) {
							delete spectra.metadata.joined[this.metadata[0][j]];
						}
					}
					return false;
				}

				for( var j = 0; j < this.metadata[0].length; j++ ) {
					if( j == this.joinCol && !(this.filenameMatch || this.worksheetMatch) ) continue;
					spectra.metadata.joined[this.metadata[0][j]] = this.metadata[row][j];
				}
				return true;
			},

			joinAttributes : function() {
				if( this.metadata.length == 0 ) return [];

				var list = [];
				for( var i = 0; i < this.metadata[0].length; i++ ) {
					list.push(this.metadata[0][i]);
				}
				return list;
			},

			_getRow : function(spectra) {
				if( this.filenameMatch || this.worksheetMatch ) {
					var regex, val, name;
					for( var i = 1; i < this.metadata.length; i++ ) {
						name = this.filenameMatch ? spectra.filename : spectra.sheetname;
						val = this.metadata[i][this.joinCol];

						// if the value doesn't have a period, assume we want to strip any extension on a filename match
						if( val.indexOf('.') == -1 && this.filenameMatch ) {
							name = name.replace(/\..*/,'');
						}

						// this can match too much
						if( this.looseMatch && name.indexOf(val) > -1 ) {
							return i;
						} else if( val == name ) {
							return i;
						}
					}
				} else {
					var spMetadata = spectra.metadata.spectra; // case for new metadata
					if( !spMetadata ) spMetadata = spectra.metadata; // case for existing spectra

					for( var i = 1; i < this.metadata.length; i++ ) {
						if( this.metadata[i][this.joinCol] == spMetadata[this.joinId] ) {
							return i;
						}
					}
				}
				return -1;
			}
		});
	</script>
</polymer-element>