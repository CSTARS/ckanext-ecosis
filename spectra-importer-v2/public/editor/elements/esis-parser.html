<link rel="import" href="esis-extractor.html">

<polymer-element name="esis-parser">
	<template>
		<esis-extractor id="extractor"></esis-extractor>
	</template>
	<script>
		Polymer('esis-parser',{
			parse : function(file, callback) {
				var arr = [];
				var info = file.info;
				var contents = file.contents;

				if( info.ext == 'xlsx' ) {
					try {

						var ref = this;
						function onXlsxComplete(wb){
							var count = 0;
							wb.SheetNames.forEach(function(sheetName) {
								var csv = XLSX.utils.sheet_to_csv(wb.Sheets[sheetName]);
								$.csv.toArrays(csv, {}, function(err, data){
									if( err ) {
										count++;
										ref.onComplete(err, null, info, count, wb.SheetNames.length, arr, callback);
										return;
									}

									ref.$.extractor.run(data, function(err, resp){
										count++;
										resp.sheetName = sheetName;
										ref.onComplete(null, resp, info, count, wb.SheetNames.length, arr, callback);
									});
								});
							});
						}

						var worker = new Worker('components/js-xlsx/xlsxworker.js');
						worker.onmessage = function(e) {
							switch(e.data.t) {
								case 'ready': break;
								case 'e': console.error(e.data.d); break;
								case 'xlsx': onXlsxComplete(JSON.parse(e.data.d)); break;
							}
						};
						worker.postMessage({d:contents,b:true});

					} catch(e) {
						debugger;
						this.onComplete(e, null, info, 1, 1, arr, callback);
					}
				} else if( info.ext == 'xls' ) {
					try {

						var ref = this;
						function onXlsComplete(wb){
							wb = XLS.read(contents, {type: 'binary'});

							var count = wb.SheetNames.length;
							wb.SheetNames.forEach(function(sheetName) {
								var csv = XLSX.utils.sheet_to_csv(wb.Sheets[sheetName]);
								$.csv.toArrays(csv, {}, function(err, data){
									if( err ) {
										count++;
										ref.onComplete(err, null, info, count, wb.SheetNames.length, arr, callback);
										return;
									}

									ref.$.extractor.run(data, function(err, resp){
										count++;
										resp.sheetName = sheetName;
										ref.onComplete(null, resp, info, count, wb.SheetNames.length, arr, callback);
									});
								});
							});
						}

						var worker = new Worker('components/js-xls/xlsworker.js');
						worker.onmessage = function(e) {
							switch(e.data.t) {
								case 'ready': break;
								case 'e': console.error(e.data.d); break;
								case 'xlsx': onXlsComplete(JSON.parse(e.data.d)); break;
							}
						};
						worker.postMessage({d:contents,b:true});

					} catch(e) {
						debugger;
						this.onComplete(e, null, info, 1, 1, arr, callback);
					}
				} else if ( info.hasData ) {
					try {
						var options = {};
						if( info.parser == 'csv-tab' ) options.separator = '\t';
						if( info.parser == 'csv-4spaces' ) options.separator = '    ';
						if( info.parser == 'csv-2spaces' ) options.separator = '  ';

						$.csv.toArrays(contents, options, function(err, data){
							if( err ) return onComplete(err, null, info, 1, 1, arr, callback);

							this.$.extractor.run(data, function(err, resp){
								if( err ) this.onComplete(err, null, info, 1, 1, arr, callback);
								else this.onComplete(null, resp, info, 1, 1, arr, callback);
							}.bind(this));
						}.bind(this));
					} catch(e) {
						debugger;
						this.onComplete(e, null, info, 1, 1, arr, callback);
					}
				} else {
					this.onComplete(null, null, info, 1, 1, arr, callback);
				}
			},

			onComplete : function(err, data, info, index, total, arr, callback) {
				if( err ) {
					data = {
						error : err
					}
				} else if( !data ) {
					data = {
						error : 'Unknown parse error'
					}
				} else if( data.spectra.length == 0 && 
					Object.keys(data.metadata).length == 0 &&
					!data.joindata ) {
					data.warning = 'No metadata or spectra found';
				}

				if( total > 1 ) {
					if( data.sheetName ) {
						data.name = info.name + ' - ' + data.sheetName;
					} else {
						data.name = info.name + ' - ' + index;
					}
				}

				data.info = {};
				for( key in info ) data.info[key] = info[key];

				// don't want to add datasheets as resources
				data.info.type = 'data';

				arr.push(data);

				if( index == total ) callback(arr);
			}
		});
	</script>
</polymer-element>