<link rel="import" href="structures/esis-file.html">
<link rel="import" href="structures/esis-datasheet.html">
<link rel="import" href="structures/esis-resource.html">

<polymer-element name="esis-datastore" attributes="files">
	<script>
		Polymer('esis-datastore', {
			// is this an existing dataset
			editMode : false,

			existing : {
				resources : [],
				dataset   : {}
			},

			data : {
				title : '',
				name : '',
				notes : '',
				author : '',
				author_email : '',
				license_id : '',
				license_title : '',
				maintainer : '',
				maintainer_email : '',
				version : '',
				owner_org : '',
				tags : [],
				private : false
			},
			owner_org_name : '',

			group : {
				by : '',
				sort_on : '',
				description : '',
			},

			// field that should be used to create uids for spectra
			spectraDisambiguator : '',

			// list of all new files
			files : [],
			// list of all new datasheets
			datasheets : [],
			// list of all new resources
			resources  : [],

			// list of current attribute map
			attributeMap : {},
			inverseAttributeMap : {},

			// list of currently known attributes for this dataset
			knownAttributes : [],

			// list of resources that are scheduled to be deleted
			deleted : [],

			observe : {
				attributeMap : '_onAttributeMapUpdate'
			},

			ready : function() {
				if( this.data.title == '' ) window.location.hash = '#basic-fields';
			},

			addFile : function(raw, parseZip) {
				var ele = document.createElement('esis-file');
				ele.raw = raw;
				ele.parseZip = parseZip;
				this.files.push(ele);
				return ele;
			},

			removeFile : function(file) {
				var index = this.files.indexOf(file);
				if( index > -1 ) {
					this.files.splice(index, 1);

					// remove anything from the datasheet or resource list
					for( var i = 0; i < file.datasheets.length; i++ ) {
						index = this.datasheets.indexOf(file.datasheets[i]);
						if( index > -1 ) this.datasheets.splice(index, 1);
					}

					for( var i = 0; i < file.resources.length; i++ ) {
						index = this.resources.indexOf(file.resources[i]);
						if( index > -1 ) this.resources.splice(index, 1);
					}
				}
			},

			addDatasheet : function(file, parsedContents) {
				var ele = document.createElement('esis-datasheet');

				// attach listener for when attributes have been aggregated
				// add to known list when done
				ele.addEventListener('spectra-updated', function(e){
					this._addKnownAttributes(e.detail);
				}.bind(this));

				ele.file = file;
				ele.contents = parsedContents;

				this.datasheets.push(ele);
				return ele;
			},

			addResource : function(resource, datasheets) {
				var ele = document.createElement('esis-resource');
				ele.filename = resource.name || resource.info.name;
				ele.mimetype = resource.file ? resource.file.type : resource.info.mime;
				ele.ext = resource.info.ext;
				ele.datasheets = datasheets;
				this.resources.push(ele);
				return ele;
			},

			removeResource : function(id) {
				// remove resource
				for( var i = 0; i < this.existing.resources.length; i++ ) {
					if( this.existing.resources[i].id == id ) {
						this.existing.resources.splice(i,1);
						break;
					}
				}

				// remove any spectra associated with this resource
				for( var i = this.existing.dataset.data.length-1; i >= 0; i-- ) {
					if( this.existing.dataset.data[i].resource_id == id ) {
						this.existing.dataset.data.splice(i,1);
					}
				}

				// remove any metadata associated with this resource
				for( var i = this.existing.dataset.join.length-1; i >= 0; i-- ) {
					if( this.existing.dataset.join[i].resource_id == id ) {
						this.existing.dataset.join.splice(i, 1);
					}
				}

				this.deleted.push(id);
			},

			join : function(metadata) {
				var count = 0;
				
				// join on new spectra
				for( var i = 0; i < this.datasheets.length; i++ ) {
					if( this.datasheets[i].isMetadata ) continue;

					for( var j = 0; j < this.datasheets[i].spectra.length; j++ ) {
						if( metadata.join(this.datasheets[i].spectra[j]) ) count++;
					}
				}

				// join on existing spectra
				if( this.existing.dataset.data ) {
					for( var i = 0; i < this.existing.dataset.data.length; i++ ) {
						if( metadata.join(this.existing.dataset.data[i]) ) count++;
					}
				}

				metadata.matchCount = count;

				// make sure to add new metadata attribute to known list
				this._addKnownAttributes(metadata.joinAttributes());
			},

			_addKnownAttributes : function(attrList) {
				for( var i = 0; i < attrList.length; i++ ) {
					if( this.knownAttributes.indexOf(attrList[i]) == -1 ) {
						this.knownAttributes.push(attrList[i]);
					}
				}
			},

			_onAttributeMapUpdate : function(oldMap, newMap) {
				this.inverseAttributeMap = {};
				for( var key in newMap ) {
					if( newMap[key] != '' ) this.inverseAttributeMap[newMap[key]] = key;
				}
			}
		});
	</script>
</polymer-element>