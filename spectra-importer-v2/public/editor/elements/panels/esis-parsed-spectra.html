<link rel="import" href="../../components/paper-tabs/paper-tabs.html" />
<link rel="import" href="../ui/esis-ui-spectra.html" />
<link rel="import" href="../ui/esis-ui-datasheet.html" />

<polymer-element name="esis-parsed-spectra">
	<template>
		<style>
			paper-tabs::shadow #selectionBar {
				background-color: rgb(47, 155, 69);
			}
			paper-tab::shadow #ink {
				color: rgb(47, 155, 69);
			}
			a {
				color : #2f9b45;
				cursor: pointer;
			}
			.next {
				margin-top: 10px;
				padding: 10px;
				background-color: #f8f8f8;
				border-radius: 6px;
			}
			.s-selector {
				margin: 25px 0 10px 0;
				padding: 5px;
			}
			ul li {
				padding: 3px;
			}
		</style>

		<div style="color:#888;font-size:14px;margin-bottom:40px">
			<div>This panel shows the current state of your newely added spectra.  Please verify your spectral data looks correct.</div>

			<div class="next">
				<h4>Possible next steps include:</h4>
				<ul>
					<li><a on-tap="{{_gotoAttrMap}}">Set Attribute Map</a> - If you have custom fields below (marked with an '*') that map to Ecosis metadata fields, please upload a attribute map file.</li>
					<li><a on-tap="{{_gotoJoin}}">Join Auxiliary Metadata</a> - If you uploaded your metadata in a separate file you will need to join the metadata to your spectra.</li>
					<li><a on-tap="{{_gotoGroup}}">Set Dataset Group</a> - If your dataset has logical groups users should know about (ex: time series, spatially related) you can define those groups here.</li>
				</ul>
			</div>
		</div>


		<esis-ui-card style="padding:15px">
	    	<paper-tabs selected="{{selectedTab}}">
			    <paper-tab>Spectra View</paper-tab>
			    <paper-tab>Datasheet View</paper-tab>
			</paper-tabs>


			<div hidden?="{{selectedTab == 0}}">
				<template repeat="{{datasheet in spectraDatasheets}}">
					<esis-ui-datasheet datasheet="{{datasheet}}"></esis-ui-datasheet>
				</template>
			</div>
			<div hidden?="{{selectedTab == 1}}">
				<h2>{{spectra.length}} Spectra Found</h2>
				<div>
					<span class="label success-label">File Level Metadata</span> 
					<span class="label info-label">Spectra Level Metadata</span> 
					<span class="label warning-label">Linked Metadata</span> <br>
					<div style="color:#888;padding:8px;font-size:14px">* Custom non-ecosis field</div>
				</div>

				<div class="s-selector">
					Select Spectra: 
					<select id="spectraSelector" on-change="{{_selectSpectra}}">
						<template repeat="{{sp,i in spectra}}">
							<option value="{{i}}">{{i+1}}</option>
						</template>
					</select>
				</div>

				<esis-ui-spectra id="spectraUI" spectra="{{selectedSpectra}}"></esis-ui-spectra>
			</div>
		</esis-ui-card>

	</template>
	<script>
		Polymer('esis-parsed-spectra', {
			
			menuItem : null,

			selectedTab : 0,

			spectraDatasheets : [],
			datasheets : [],
			spectra    : [],

			selectedSpectra : {},

			observe : {
				datasheets : '_update',
				selectedTab : '_onTabChange'
			},

			ready : function() {
				 window.addEventListener('polymer-ready', function(e) {
				 	this.async(function(){
				 		this.datasheets = document.querySelector('esis-datastore').datasheets;
				 	});
				}.bind(this));

				// see if we need to poke the spectra UI panel
				$(window).on('hashchange', function(){
					if( window.location.hash.replace(/#/g,'') == 'parsed-spectra' ) {
						this._onTabChange();
					}
				}.bind(this));
			},

			_update : function() {
				this.async(function(){
					this.spectra = [];
					this.spectraDatasheets = [];

					for( var i = 0; i < this.datasheets.length; i++ ) {
						var f = this.datasheets[i];
						if( !f.isMetadata ) {
							this.spectraDatasheets.push(f);
						}
						for( var j = 0; j < f.spectra.length; j++ ) {
							this.spectra.push(f.spectra[j]);
						}
					}

					if( this.spectra.length > 0 ) {
						this.selectedSpectra = this.spectra[0];
					}

					this._updateVisibility();
					this.menuItem.setSecondaryHtml(this.spectra.length+' Spectra Found');
				});
			},

			_updateVisibility : function() {
				if( this.datasheets.length > 0 ) {
					this.menuItem.style.display = 'block';
				} else {
					this.menuItem.style.display = 'none';
				}
			},

			_onTabChange : function() {
				if( this.selectedTab == 1 ) this.$.spectraUI.show();
			},

			_selectSpectra : function() {
				this.selectedSpectra = this.spectra[parseInt(this.$.spectraSelector.value)];
			},

			_gotoAttrMap : function() {
				window.location.hash = '#attribute-map';
			},

			_gotoJoin : function() {
				window.location.hash = '#join';
			},

			_gotoGroup : function() {
				window.location.hash = '#group-by';
			}

		});
	</script>
</polymer-element>