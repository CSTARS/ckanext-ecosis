<link rel="import" href="../../components/paper-input/paper-input.html"/>
<link rel="import" href="../ui/esis-ui-token-input.html"/>

<polymer-element name="esis-basic-fields">
	<template>
		<style>
			.form-wrap {
				padding: 15px 5px;
				margin: 15px 5px;
			}
			paper-input::shadow .focusedColor {
				background-color: #2f9b45;
				color: #2f9b45;
			}
			a {
				color : #2f9b45;
				cursor: pointer;
			}
		</style>

		<div style="font-size: 14px; color: #888">
			Fill out the basic information for your dataset.  Then you can add resource files such as metadata or spectra.
		</div>

		<div class="form-wrap">
			<div hidden?="{{!ds.editMode}}">
				<div><b>Title:</b> {{ds.data.title}}</div>
				<div style="font-size:12px;color:#888;font-style:italic">
					URL: {{baseUrl}}{{ds.data.name}}
				</div>
			</div>
			<div hidden?="{{ds.editMode}}" > 
				<paper-input floatingLabel label="Title" inputValue="{{ds.data.title}}"></paper-input>
				<div hidden?="{{!verifingName}}" style="color:#888;margin-left:20px;font-size:12px;padding:5px">
					Verifying name...
				</div>
				<div hidden?="{{validName || verifingName}}" style="color:red;margin-left:20px;font-size:12px;padding:5px">
					Invalid name.  A dataset with this name already exists.
				</div>
				<div style="margin-left:20px" hidden?="{{verifingName}}" >
					URL: {{baseUrl}}<span style="color: {{validName ? '#2f9b45' : 'red'}}">{{ds.data.name}}</span>
				</div>
				<div style="margin-left:20px" hidden?="{{!verifingName}}" >
					URL: {{baseUrl}}<span style="color: #888">{{ds.data.name}}</span>
				</div>
			</div>
		</div>

		<div class="form-wrap">
			<paper-input multiline rows="3" floatinglabel label="Description" value="{{ds.data.notes}}" ></paper-input>
		</div>

		<div class="form-wrap">
			<esis-ui-token-input id="keywords" on-update="{{_setKeywords}}"></esis-ui-token-input>
		</div>

		<div class="form-wrap">
			License: <br />
			<template bind if="{{licenses.length == 0}}">
				Loading...
			</template>
			<select id="license" hidden?="{{licenses.length == 0}}" value="{{ds.data.license_id}}">
       			<template repeat="{{item in licenses}}">
       				<option value="{{item.id}}">{{item.title}}</option>
       			</template>
    		</select>
		</div>

		<div class="form-wrap">
			Organization: <br />
			<template bind if="{{organizations.length == 0}}">
				Loading...
			</template>
			<select id="organizations" hidden?="{{organizations.length == 0}}" value="{{ds.data.owner_org}}">
       			<template repeat="{{item in organizations}}">
       				<option value="{{item.id}}">{{item.display_name}}</option>
       			</template>
    		</select>
		</div>

		<div class="form-wrap" >
			Visibility: <br />
			<select id="visible" on-change="{{_updateVisibility}}" disabled>
				<option value="false">Public</option>
				<option value="true">Private</option>
			</select>
		</div>

		<div class="form-wrap">
			<paper-input floatingLabel label="Version" value="{{ds.data.version}}"></paper-input>
		</div>

		<div class="form-wrap">
			<paper-input floatingLabel label="Author" value="{{ds.data.author}}"></paper-input>
			<paper-input floatingLabel label="Author Email" value="{{ds.data.author_email}}"></paper-input>
		</div>

		<div class="form-wrap">
			<paper-input floatingLabel label="Maintainer" value="{{ds.data.maintainer}}"></paper-input>
			<paper-input floatingLabel label="Maintainer Email" value="{{ds.data.maintainer_email}}"></paper-input>
		</div>

		<template bind if="{{ds.data.title != ''}}">
			Now <a on-tap="{{_addResources}}">add resources</a> to your dataset.
		</template>

	</template>
	<script>
		Polymer('esis-basic-fields', {
			ds : {},
			ckan : {},

			validName : true,
			verifingName : false,

			menuItem : null,
			baseUrl : '',

			visible : true,

			licenses : [],
			organizations : [],

			verifyNameTimer : -1,

			observe : {
				'ds.data.title' : '_cleanTitle',
				'ds.data.owner_org' : '_onOrgChange',
				'ds.data.name' : '_verifyName',
				'ds.data.license_id' : '_updateLicenseName',
				'ds.data.hidden' : '_setVisibility',
				'ds.data.tags' : '_updateTokens'
			},

			ready : function() {
				this.baseUrl = esis.host+'/dataset/';

				this.ds = document.querySelector('esis-datastore');
				this.ckan = document.querySelector('esis-ckan');

				$.get(esis.host+'/api/3/action/license_list', function(resp){
					this.licenses = resp.result;
				}.bind(this));

				$.get(esis.host+'/api/3/action/organization_list?all_fields=true', function(resp){
					this.organizations = resp.result;
					this.organizations.splice(0,0, {
						id : '',
						display_name : 'No Organization'
					});
				}.bind(this));
			},

			_verifyName : function() {
				if( this.ds.data.name == '' || this.ds.editMode ) return;

				if( this.verifyNameTimer != -1 ) clearTimeout(this.verifyNameTimer);
				this.verifingName = true;

				this.verifyNameTimer = setTimeout(function(){
					this.ckan.getPackage(this.ds.data.name, function(err, resp){
						this.verifingName = false;
						if( err && err.error && err.error.message == "Not found" ) {
							this.validName = true;
						} else {
							this.validName = false;
						}
					}.bind(this));
				}.bind(this), 500);
			},

			_cleanTitle : function() {
				this.ds.data.name = this.ds.data.title.toLowerCase().replace(/[^a-z0-9]/g,'-');
				if( this.ds.data.title == '' ) return;
				this.menuItem.setSecondaryHtml('<b>Dataset:</b> '+this.ds.data.title);
			},

			_onOrgChange : function() {
				if( this.ds.data.owner_org == '' ) {
					this.ds.owner_org_name = '';
					this.ds.data.private = false;
					this.$.visible.setAttribute('disabled','disabled');
				} else {
					this.$.visible.removeAttribute('disabled');

					var opt = this.$.organizations.querySelector('option:checked');
					if( opt ) this.ds.owner_org_name = opt.innerHTML;	
				}
			},

			_addResources : function() {
				window.location.hash = "#new-resources";
			},

			_setKeywords : function(e) {
				this.ds.data.tags = e.detail;
			},

			_updateTokens : function() {
				//this.$.keywords.tokens = [];
				for( var i = 0; i < this.ds.data.tags.length; i++ ) {
					this.$.keywords.addToken({value:this.ds.data.tags[i].display_name});
				}
			},

			_updateLicenseName : function() {
				var opt = this.$.license.querySelector('option:checked');
				if( opt ) this.ds.data.license_title = opt.innerHTML;
			},

			_updateVisibility : function() {
				if( this.$.visible.value == 'false' ) this.ds.data.hidden = true;
				else this.ds.data.hidden = false;
			},

			_setVisibility : function() {
				this.$.visible.value = (this.ds.hidden)+'';
			}

		});
	</script>
</polymer-element>