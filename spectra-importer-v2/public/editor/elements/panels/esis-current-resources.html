<polymer-element name="esis-current-resources">
	<template>
		<template repeat="{{res in resources}}">
			<div>{{res.id}} {{res.name}} {{res.type}} {{res.count}}</div>
		</template>
	</template>
	<script>
		Polymer('esis-current-resources',{
			menuItem : null,
			ds : {},
			loader : {},

			resources : [],

			observe : {
				'ds.existing.dataset' : '_update',
				'ds.editMode' : '_updateVisibility'
			},

			ready : function() {
				this.ds = document.querySelector('esis-datastore');
				this.loader = document.querySelector('esis-dataset-loader');
				this.loader.addEventListener('get-spectral-resource-progress', function(e){
					this._updatePreview(e.detail);
				}.bind(this));
			},

			_update : function() {
				this._updateVisibility();

				this.async(function(){
					this._updateUI();
				});
			},

			_updateUI : function() {
				this.resources = [];

				for( var i = 0; i < this.ds.existing.resources.length; i++ ) {
					this.resources.push(this._groupData(this.ds.existing.resources[i]));
				}
			},

			_groupData : function(res) {
				var ui = {
					name : res.name,
					id   : res.id
				};

				for( var i = 0; i < this.ds.existing.dataset.join.length; i++ ) {
					var join = this.ds.existing.dataset.join[i];
					if( res.id == join.resource_id ) {
						ui.type = 'Metadata';
						return ui;
					}
				}


				for( var i = 0; i < this.ds.existing.dataset.data.length; i++ ) {
					if( this.ds.existing.dataset.data[i].resource_id == res.id ) {
						ui.type = 'Spectra';
						if( ui.count == null ) ui.count = 1;
						else ui.count++;
					}
				}
				return ui;
			},

			_updateVisibility : function() {
				this._updatePreview();
				if( !this.ds.editMode ) {
					this.menuItem.style.display = 'none';
					return;
				}

				if( Object.keys(this.ds.existing.dataset).length > 0 ) {
					this.menuItem.style.display = 'block';
				} else {
					this.menuItem.style.display = 'none';
				}
			},

			_updatePreview : function(progress) {
				var html = this.ds.existing.resources.length+' Resource(s)';
				if( progress != null ) {
					html += '<br />Loading spectra package... '+progress+'%';
				}

		  		this.menuItem.setSecondaryHtml(html);
		  	}
		});
	</script>
<polymer-element>