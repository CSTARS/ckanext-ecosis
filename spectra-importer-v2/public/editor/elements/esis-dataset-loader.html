<link rel="import" href="../components/paper-dialog/paper-dialog.html">

<polymer-element name="esis-dataset-loader">
	<template>
		<paper-dialog id="dialog" transition="paper-transition-bottom" backdrop layered autoCloseDisabled>
			Loading Dataset...
		</paper-dialog>
	</template>
	<script>
		Polymer('esis-dataset-loader', {
			data : {},
			ds : {},
			ckan : {},
			pkgid : '',

			spectraPackageLoaded : false,

			ready : function() {
				this.pkgid = this._getVar('id');
				if( this.pkgid == null ) return;

				this.ds = document.querySelector('esis-datastore');
				this.ckan = document.querySelector('esis-ckan');

				this.$.dialog.toggle();
				window.addEventListener('polymer-ready', function(e) {
				var ckan = document.querySelector('esis-ckan');
				ckan.getPackage(this.pkgid, function(err, pkg){
					this.$.dialog.toggle();
					if( err || pkg.error ) return alert('Error loading dataset.');

					this.data = pkg;
					this._setData();
					
				}.bind(this));
				}.bind(this));
			},

			_setData : function() {
				this.ds.editMode = true;
				for( var key in this.ds.data ) {
					if( this.data[key] ) this.ds.data[key] = this.data[key];
				}

				this._getSpectraPackage(this.data.name);

				if( !this.data.resources ) return;

				for( var i = 0; i < this.data.resources.length; i++ ) {
            		this.ds.existing.resources.push(this.data.resources[i]);
            	}
			},

			_getSpectraPackage: function(id) {
				this.fire('get-spectral-resource-progress', 0);
				this.ckan.getSpectraResource(
					id, 
					function(err, dataset){
						if( err ) return alert('Failed to load Ecosis spectra resource package');
						this.ds.existing.dataset = dataset;

						// set existing metadata
						this._setExistingMetadata();

						this.fire('get-spectral-resource-complete');
						this.spectraPackageLoaded = true;
					}.bind(this),
					function(progress){
						this.fire('get-spectral-resource-progress', progress);
					}.bind(this)
				);
			},

			// create metadata elements for the resources that already exist
			_setExistingMetadata : function() {
				if( !this.ds.existing.dataset ) return;
				if( !this.ds.existing.dataset.join ) return;

				for( var i = 0; i < this.ds.existing.dataset.join.length; i++ ) {
					var mdObj = this.ds.existing.dataset.join[i];

					var datasheet = document.createElement('esis-datasheet');
					datasheet.isMetadata = true;
					datasheet.isExisting = true;

					var metadata = document.createElement('esis-metadata');
					metadata.metadata = mdObj.metadata;
					metadata.joinId = mdObj.join_id;
					metadata.resourceId = mdObj.resource_id;
					metadata.isExisting = true;

					// set filename
					if( this.data.resources ) {
						for( var i = 0; i < this.data.resources.length; i++ ) {
							if( this.data.resources[i].id = metadata.resourceId ) {
								metadata.filename = this.data.resources[i].name;
								break;
							}
						}
					}

					// set join information
					if( mdObj.join_on.type == 'filename' ) {
						metadata.filenameMatch = true;
						if( mdObj.join_on.loose ) metadata.looseMatch = true;
					} else if ( mdObj.join_on.type == 'worksheet' ) {
						metadata.worksheetMatch = true;
					}

					datasheet.metadata = metadata;
					this.ds.datasheets.push(datasheet);
				}
			},

			_getVar : function(variable) {
       			var query = window.location.search.substring(1);
       			var vars = query.split("&");
       			for (var i = 0; i < vars.length; i++) {
               		var pair = vars[i].split("=");
               		if( pair[0] == variable ) return pair[1];
       			}
       			return null;
			}
		});
	</script>
</polymer-element>