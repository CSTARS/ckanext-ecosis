<!--<script src="http://192.168.1.128:3000/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="http://192.168.1.128:3000/js/main.js"></script>-->

<script type="text/javascript">
var ie = (function(){
    var undef,
        v = 3,
        div = document.createElement('div'),
        all = div.getElementsByTagName('i');
    while (
        div.innerHTML = '<!--[if gt IE ' + (++v) + ']><i></i><![endif]-->',
        all[0]
    );
    return v > 4 ? v : undef;
}());

esis = {};

esis.jslib = [
	'/lib/bootstrap2/js/bootstrap.min.js',
	'/lib/jszip.js',
	'/lib/xlsx.js',
	//'/components/js-xlsx/dist/xlsx.min.js',
	'/components/js-xls/dist/xls.min.js',
	'/components/jquery-csv/src/jquery.csv.js',
	'/components/js-md5/js/md5.min.js'
];

esis.js = [
	'/js/main.js',
	'/js/uploader.js',
	'/js/extension.js',
	'/js/extractor.js',
	'/js/parser.js',
	'/js/structures/datasheet.js',
	'/js/structures/file.js',
	'/js/structures/import.js',
	'/js/structures/joinableMetadata.js',
	'/js/structures/resource.js',
	'/js/structures/spectra.js',
	'/metadata.js'
];


esis.css = [
	'/components/font-awesome/css/font-awesome.min.css'
];

esis.jquery = "//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js";
//esis.html = "html/main.js";
esis.host = "{{host}}";
esis.root = "#anchor";


esis.load = function() {

    // verify load location
    if( esis.host == "{{host}}" ) esis.host = "";

	var head = document.getElementsByTagName("head")[0];
	
	// add visualization api
	var google = document.createElement("script");
	google.src = 'https://www.google.com/jsapi';
	
	if( ie ) {
		var done = false;
		google.onreadystatechange = function() {
		    if ( !done && (!this.readyState ||
		            this.readyState === "loaded" || this.readyState === "complete") ) {
		    	done = true;
		    	esis.onGoogleLoad();
		    }
		};
	} else {
		google.onload = esis.onGoogleLoad;
	}
	head.appendChild(google);

	esis.onJqueryLoad();
};


esis.onGoogleLoad = function() {
	// callback is a dumby function that prevents loader from using document.write()
	google.load('visualization', '1.0', {callback: function(){},'packages':['corechart']});
}

esis.onJqueryLoad = function() {

	// IE cross-site for jquery
	// add ajax transport method for cross domain requests when using IE9
	if('XDomainRequest' in window && window.XDomainRequest !== null) {
	   $.ajaxTransport("+*", function( options, originalOptions, jqXHR ) {

	        var xdr;

	        return {
	            send: function( headers, completeCallback ) {
	                // Use Microsoft XDR
	                xdr = new XDomainRequest();
	                xdr.open(options.type, options.url); // NOTE: make sure protocols are the same otherwise this will fail silently
	                xdr.onload = function() {
	                    if(this.contentType.match(/\/xml/)){
	                        var dom = new ActiveXObject("Microsoft.XMLDOM");
	                        dom.async = false;
	                        dom.loadXML(this.responseText);
	                        completeCallback(200, "success", [dom]);
	                    } else {
	                    	var resp = this.responseText;
	                    	try {
	                    		resp = eval('('+resp+')');
	                    	} catch (e) {
	                    		esis.error = e;
	                    	}
	                    	
	                        completeCallback(200, "success", [resp]);
	                    }
	                };

	                xdr.onprogress = function() {};

	                xdr.ontimeout = function(){
	                    completeCallback(408, "error", ["The request timed out."]);
	                };

	                xdr.onerror = function(){
	                    completeCallback(404, "error", ["The requested resource could not be found."]);
	                };

	                if( options.data != null ) xdr.send(options.data);
	                else xdr.send();
	            },
	            abort: function() {
	                if(xdr) xdr.abort();
	            }
	        };
	    });
	}
	
	
	
	var head = $('head');
	
	// add css
	for( var i = 0; i < esis.css.length; i++ ) {
		head.append($('<link href="'+esis.host+esis.css[i]+'" rel="stylesheet" />'));
	}
	
	// inject root

	//$.getScript(esis.host+"/"+esis.html, function(){
	//	$(esis.root).html(esis.mainhtml);
	//});
	
	esis.loadScripts(0, esis.jslib, function(){
		esis.onLibsReady();
	});
}

esis.onLibsReady = function() {
	console.log(3);

	esis.loadScripts(0, esis.js, function(){
		esis.onReady();
	});
}

esis.loadScripts = function(index, scripts, callback) {
	if( index == scripts.length ) {
		callback();
	} else {
		$.getScript(esis.host+scripts[index], function(){
			index++;
			esis.loadScripts(index, scripts, callback);
		});
	}
}

esis.onReady = function() {
	$('#loading').hide();
	$('#spectra-start').show('slow');
	esis.app.init();
}

// if IE prototype out indexOf
if (!Array.prototype.indexOf) {
  Array.prototype.indexOf = function(elt /*, from*/) {
    var len = this.length >>> 0;

    var from = Number(arguments[1]) || 0;
    from = (from < 0)
         ? Math.ceil(from)
         : Math.floor(from);
    if (from < 0)
      from += len;

    for (; from < len; from++)
    {
      if (from in this &&
          this[from] === elt)
        return from;
    }
    return -1;
  };
}

</script>

<style>
.drop-zone-container {
  text-align: center;
}

#drop_zone {
  border: 2px dashed #bbb;
  -moz-border-radius: 5px;
  -webkit-border-radius: 5px;
  border-radius: 5px;
  padding: 25px;
  text-align: center;
  font-size: 20pt;
  color: #bbb;
  background-color: white;
}

.help-block {
	font-size: 12px;
	margin-top: 0px !important;
	color: #999;
}

.card {
	margin: 10px;
	padding: 10px;
	background-color: white;
	border: 1px solid #ccc;
	overflow: hidden
}
</style>

<div id="loading">
	<h4>Loading...</h4>
</div>

<div id="spectra-start" style="display:none">

		<div class="well" style="color:#666">
			<div class="form-horizontal">
			  <div class="control-group">
			    <label class="control-label" for="parseZip">Zip Files</label>
			    <div class="controls">
			      <label class="checkbox">
			      	<input type="checkbox" id="parseZip"> Extract
			  	  </label>
			      <span class="help-block">If a zip file is found, should its contents be imported as individual resources?  By default the spectra will be parsed, but the zip will be uploaded intact.</span>
			    </div>
			  </div>
			  <div class="control-group">
			    <label class="control-label" for="inputEmail"><i class="fa fa-file"></i> Select File</label>
			    <div class="controls">
			      <input type="file" id="file" name="file" multiple>
			      <span class="help-block">Select a files to be imported.</span>
			    </div>
			  </div>
			  
			</div>
		    
	        <h4 style="text-align:center">- OR -</h4>
	        <div id="drop_zone">Drop files here</div>

 			<div style="border-top:1px solid #ccc;padding-top:15px;margin-top:15px">
	        	<h4>Metadata Map</h4>
	        	<span class="help-block">If your metadata attribute names do not match <a>this</a> list, you can download this metadata map file.  Fill it out and upload in the box to the right.  You can reuse this file, so you only have to do it once for your data.</span>

	        	<div class="row-fluid">
	        		<div class="span6">
	        			<a class="btn btn-default" target="_blank" href="/metadata_map">Download Map Template</a>
	        		</div>
	        		<div class="span6">
	        			Upload Map: <input type="file" style="margin-top:5px" id="map" name="map">
	        		</div>
	        	</div>


        	</div>
		</div>

</div>

<div id="stats" style="display:none;text-align:center"></div>

<div id="spectra-modify" style="display:none">
	<h3 class="panel-title">Parsed Spectral Data and Joinable Data
		<a class="btn btn-default pull-right" id="show-status">Inspect</a>
	</h3>
	<div class="well panel-body" id="data-body" style="max-height:400px;overflow:auto"></div>

	<h3 class="panel-title">Resource Files</h3>
	<div class="well panel-body" id="resources-body" style="max-height:400px;overflow:auto"></div>

	<button class="btn btn-primary" id="addResources">Add Resources</button>
</div>

<div id="spectra-status" style="display:none">
	<a class="btn btn-default pull-right back">Back</a>
	<div id="spectra-status-content"></div>
	<a class="btn btn-default back">Back</a>
</div>

<div class="modal fade" id="Modal">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h4 class="modal-title">File Info</h4>
  </div>
  <div class="modal-body" ></div>
  <div class="modal-footer">
    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
  </div>
</div><!-- /.modal -->

<script>
	esis.load();
</script>
