<!--<script src="http://192.168.1.128:3000/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="http://192.168.1.128:3000/js/main.js"></script>-->

<script type="text/javascript">
var ie = (function(){
    var undef,
        v = 3,
        div = document.createElement('div'),
        all = div.getElementsByTagName('i');
    while (
        div.innerHTML = '<!--[if gt IE ' + (++v) + ']><i></i><![endif]-->',
        all[0]
    );
    return v > 4 ? v : undef;
}());

esis = {};

esis.jslib = [
	'/lib/bootstrap2/js/bootstrap.min.js',
	'/lib/jszip.js',
	'/lib/xlsx.js',
	//'/components/js-xlsx/dist/xlsx.min.js',
	'/components/js-xls/dist/xls.min.js',
	'/components/jquery-csv/src/jquery.csv.js',
	'/components/js-md5/js/md5.min.js'
];

esis.js = [
	'/js/main.js',
	'/js/uploader.js',
	'/js/extension.js',
	'/js/extractor.js',
	'/js/parser.js',
	'/js/existingData.js',
	'/js/groupBy.js',
	'/js/structures/datasheet.js',
	'/js/structures/file.js',
	'/js/structures/import.js',
	'/js/structures/joinableMetadata.js',
	'/js/structures/resource.js',
	'/js/structures/spectra.js',
	'/metadata.js'
];


esis.css = [
	'/components/font-awesome/css/font-awesome.min.css'
];

esis.jquery = "//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js";
//esis.html = "html/main.js";
esis.host = "{{host}}";
esis.root = "#anchor";


esis.load = function() {

    // verify load location
    if( esis.host == "{{host}}" ) esis.host = "";

	var head = document.getElementsByTagName("head")[0];
	
	// add visualization api
	var google = document.createElement("script");
	google.src = 'https://www.google.com/jsapi';
	
	if( ie ) {
		var done = false;
		google.onreadystatechange = function() {
		    if ( !done && (!this.readyState ||
		            this.readyState === "loaded" || this.readyState === "complete") ) {
		    	done = true;
		    	esis.onGoogleLoad();
		    }
		};
	} else {
		google.onload = esis.onGoogleLoad;
	}
	head.appendChild(google);

	esis.onJqueryLoad();
};


esis.onGoogleLoad = function() {
	// callback is a dumby function that prevents loader from using document.write()
	google.load('visualization', '1.0', {callback: function(){},'packages':['corechart']});
}

esis.onJqueryLoad = function() {

	// IE cross-site for jquery
	// add ajax transport method for cross domain requests when using IE9
	if('XDomainRequest' in window && window.XDomainRequest !== null) {
	   $.ajaxTransport("+*", function( options, originalOptions, jqXHR ) {

	        var xdr;

	        return {
	            send: function( headers, completeCallback ) {
	                // Use Microsoft XDR
	                xdr = new XDomainRequest();
	                xdr.open(options.type, options.url); // NOTE: make sure protocols are the same otherwise this will fail silently
	                xdr.onload = function() {
	                    if(this.contentType.match(/\/xml/)){
	                        var dom = new ActiveXObject("Microsoft.XMLDOM");
	                        dom.async = false;
	                        dom.loadXML(this.responseText);
	                        completeCallback(200, "success", [dom]);
	                    } else {
	                    	var resp = this.responseText;
	                    	try {
	                    		resp = eval('('+resp+')');
	                    	} catch (e) {
	                    		esis.error = e;
	                    	}
	                    	
	                        completeCallback(200, "success", [resp]);
	                    }
	                };

	                xdr.onprogress = function() {};

	                xdr.ontimeout = function(){
	                    completeCallback(408, "error", ["The request timed out."]);
	                };

	                xdr.onerror = function(){
	                    completeCallback(404, "error", ["The requested resource could not be found."]);
	                };

	                if( options.data != null ) xdr.send(options.data);
	                else xdr.send();
	            },
	            abort: function() {
	                if(xdr) xdr.abort();
	            }
	        };
	    });
	}
	
	
	
	var head = $('head');
	
	// add css
	for( var i = 0; i < esis.css.length; i++ ) {
		head.append($('<link href="'+esis.host+esis.css[i]+'" rel="stylesheet" />'));
	}
	
	// inject root

	//$.getScript(esis.host+"/"+esis.html, function(){
	//	$(esis.root).html(esis.mainhtml);
	//});
	
	esis.loadScripts(0, esis.jslib, function(){
		esis.onLibsReady();
	});
}

esis.onLibsReady = function() {
	console.log(3);

	esis.loadScripts(0, esis.js, function(){
		esis.onReady();
	});
}

esis.loadScripts = function(index, scripts, callback) {
	if( index == scripts.length ) {
		callback();
	} else {
		$.getScript(esis.host+scripts[index], function(){
			index++;
			esis.loadScripts(index, scripts, callback);
		});
	}
}

esis.onReady = function() {
	$('#loading').hide();
	$('#spectra-start').show('slow');
	$('#upload-nav').show();
	esis.app.init();
}

// if IE prototype out indexOf
if (!Array.prototype.indexOf) {
  Array.prototype.indexOf = function(elt /*, from*/) {
    var len = this.length >>> 0;

    var from = Number(arguments[1]) || 0;
    from = (from < 0)
         ? Math.ceil(from)
         : Math.floor(from);
    if (from < 0)
      from += len;

    for (; from < len; from++)
    {
      if (from in this &&
          this[from] === elt)
        return from;
    }
    return -1;
  };
}

</script>

<style>
.drop-zone-container {
  text-align: center;
}

#drop_zone {
  border: 2px dashed #bbb;
  -moz-border-radius: 5px;
  -webkit-border-radius: 5px;
  border-radius: 5px;
  padding: 25px;
  text-align: center;
  font-size: 20pt;
  color: #bbb;
  background-color: white;
}

.help-block {
	font-size: 12px;
	margin-top: 0px !important;
	color: #999;
}

.card {
	margin: 10px;
	padding: 10px;
	background-color: white;
	border: 1px solid #ccc;
	overflow: hidden
}

.nav-panel {
	display: none;
}
</style>

<ul class="nav nav-pills" id="upload-nav" style="display:none">
  <li class="active"><a id="nav-spectra-start">Upload</a></li>
  <li>
  	<a id="nav-existing-spectra">Current Resources<span id="existing-count"></span></a>
  </li>
  <li><a id="nav-groupby-body">Group By</a></li>
  <li style="display:none"><a id="nav-data-body">Parsed Spectra<span id="parsed-count"></span></a></li>
  <li style="display:none"><a id="nav-join-body">Join Data<span id="join-count"></span></a></li>
  <li style="display:none"><a id="nav-resources-body">New Resources<span id="resource-count"></span></a></li>
</ul>

<div id="loading">
	<h4>Loading...</h4>
</div>

<div class="nav-panel" id="existing-spectra"></div>

<div class="nav-panel" id="spectra-start">

	<div class="well" style="color:#666">
		<div class="form-horizontal">
		  <div class="control-group">
		    <label class="control-label" for="parseZip">Zip Files</label>
		    <div class="controls">
		      <label class="checkbox">
		      	<input type="checkbox" style="margin-top:5px" id="parseZip"> Extract
		  	  </label>
		      <span class="help-block">If a zip file is found, should its contents be imported as individual resources?  By default the spectra will be parsed, but the zip will be uploaded intact.</span>
		    </div>
		  </div>
		  <div class="control-group file-select-group">
		    <label class="control-label" for="inputEmail"><i class="fa fa-file"></i> Select File</label>
		    <div class="controls">
		      <input type="file" style="margin-top:5px" id="file" name="file" multiple>
		      <span class="help-block">Select a files to be imported.</span>
		    </div>
		  </div>
		  
		</div>
	    
	    <div class="file-select-group">
        	<h4 style="text-align:center">- OR -</h4>
        	<div id="drop_zone">Drop files here</div>
    	</div>

    	<h2 style="display:none;text-align:center" id="processing">Parsing... <br /><small>Please wait, this may take a moment.</small></h2>

        <div style="border-top:1px solid #ccc;padding-top:15px;margin-top:15px">
        	<h4>Metadata Map</h4>
        	<span class="help-block" id="metadata-map-block-help" style="display:none">If your metadata attribute names do not match <a>this</a> list, you can download this metadata map file.  Fill it out and upload in the box to the right.  You can reuse this file, so you only have to do it once for your data.</span>

        	<div class="row-fluid" id="metadata-map-block" style="display:none">
        		<div class="span6">
        			<a class="btn btn-default" target="_blank" href="/metadata_map">Download Map Template</a>
        		</div>
        		<div class="span6">
        			Upload Map: <input type="file" style="margin-top:5px" id="map" name="map">
        		</div>
        	</div>
	       	<div id="current-metadata-map"></div>

        </div>

        <div style="border-top:1px solid #ccc;padding-top:15px;margin-top:15px;display:none" id="unique-id">
        	<h4>Unique Identifier</h4>
        	<span class="help-block">Your spectra signatures for this dataset are not inherently unique.  Please provide a metadata field that can serve as a unique identifier.</span>

			<div class="form-horizontal">
			  <div class="control-group">
			    <label class="control-label" for="unique-id-input">Unique ID</label>
			    <div class="controls">
			      <select style="form-control" id="unique-id-input"></select>
			    </div>
			  </div>			  
			</div>
        </div>

	</div>

	<a class="btn btn-primary" id="addResources" style="display:none">Add Resources</div>
</div>

<div id="spectra-status" class="nav-panel">
	<a class="btn btn-default pull-right back">Back</a>
	<div id="spectra-status-content"></div>
	<a class="btn btn-default back">Back</a>
</div>


<div id="data-body" class="nav-panel">
	<div><a id="show-status" class="btn btn-default">Inspect</a></div>
	<div id="data-body-inner"></div>
</div>

<div id="join-body" class="nav-panel">
	<div id="join-body-inner"></div>
</div>

<div id="groupby-body" class="nav-panel">
	<div id="groupby-body-inner">
		<h4>Group Data</h4>
		<div class="help-block">
			Group your data by a certain attribute so related spectra can easily be found in search.  Examples for this grouping include time series data, or data that is spatially related.  To group, first select the attribute in your dataset to group on.  This attribute should have the same value for all spectra in that group.  Next, provide a sort attribute.  For time, this would be the time attribute the spectra was taken at.  Finally, you can provide a description of this group to let others know what this grouping is.  Ex: "Spectra time series at 1 minute intervals"
		</div>

		<div class="form">
			<div class="form-horizontal">
				  <div class="control-group">
				    <label class="control-label" for="groupby-attr-input">By: </label>
				    <div class="controls">
				      <select style="form-control" id="groupby-attr-input"></select>
				    </div>
				  </div>
				<div class="control-group">
				    <label class="control-label" for="groupby-sort-input">Sort On: </label>
				    <div class="controls">
				      <select style="form-control" id="groupby-sort-input"></select>
				    </div>		  
				</div>
				<div class="control-group">
				    <label class="control-label" for="groupby-description-input">Description: </label>
				    <div class="controls">
				     	<textarea id="groupby-description-input"></textarea>
				    </div>			  
				</div>
			</div>
		</div>

		<div id="groupby-info"></div>
		<a id="groupby-update-btn" class="btn btn-default" style="display:none">Update</a>
	</div>
</div>

<div id="resources-body" class="nav-panel"></div>




<div class="modal fade" id="Modal">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h4 class="modal-title">File Info</h4>
  </div>
  <div class="modal-body" ></div>
  <div class="modal-footer">
    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
  </div>
</div><!-- /.modal -->

<script>
	esis.load();
</script>
