<dom-module id="ecosis-page-current-resources">
  <style>
    :host {
      display : block;
      padding: 0 5%;
    }
    #legend {
      padding: 20px 0;
    }
  </style>

  <template>

    <h4 class="page-header">Current Resources</h4>

    <div id="removeAll" style="margin-bottom: 20px">
      <a class="btn btn-link" on-click="selectAll">Select All</a>
      <a class="btn btn-link" on-click="unselectAll">Unselect All</a>

      <a class="btn btn-danger pull-right" id="deleteAll" on-click="deleteAll" style="display:none">Delete All Selected</a>
    </div>
    <div id="resourceRoot"></div>

    <div id="noResources" id="alert alert-warning" style="display:none">
      Your dataset does not contain any resource files.  Click <a id="addLink">here</a> to upload resources.
    </div>

    <div id="legend">
      <div style="float:right">
        Click the <i class="fa fa-pencil"></i> icon to inspect or edit a resource.
      </div>

      <h6 style="margin-bottom:0">Resource List Legend</h6>
      <span class="label label-success">Data Sheet</span>
      <span class="label label-primary">Metadata Sheet</span>
      <span class="label label-warning">Zip Package</span>
      <span class="label label-info">Multi-Sheet File</span>
      <span class="label label-default">Ignored</span>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ecosis-page-current-resources',

    ready : function() {
      if( ecosis.ds.loaded ) this.render();
      else ecosis.ds.on('load', this.render.bind(this));

      this.$.addLink.setAttribute('href', '#add-resources');
    },

    onShow : function() {
      this.render();
    },

    render : function() {
      if( ecosis.ds.resources.length == 0 ) {
        this.$.noResources.style.display = 'block';
        this.$.legend.style.display = 'none';
        this.$.removeAll.style.display = 'none';
        return;
      } else {
        this.$.noResources.style.display = 'none';
        this.$.legend.style.display = 'block';
        this.$.removeAll.style.display = 'block';
      }

      var html = '';


      for( var i = 0; i < ecosis.ds.resources.length; i++ ) {
        var resource = ecosis.ds.resources[i];
        if( resource.fromZip ) continue;

        html += '<ecosis-resource-panel resourceid="'+resource.id+'"></ecosis-resource-panel>';
      }

      this.$.resourceRoot.innerHTML = html;

      // listen for all update events
      $(this.$.resourceRoot)
        .find('ecosis-resource-panel')
        .on('update', this.onResourceUpdate.bind(this))
        .on('resource-select', this.onResourceSelect.bind(this));
    },

    // make sure all resource panel css classes are correct
    verifyPanelCss : function() {
      var eles = this.querySelectorAll('ecosis-resource-panel');
      for( var i = 0; i < eles.length; i++ ) {
        eles[i].setClass();
      }
    },

    onResourceSelect : function() {
      this.updateSelectState();
    },

    deleteAll : function() {
      if( !confirm('Are you sure you want to delete all selected resources?') ) return;

      var eles = this.querySelectorAll('ecosis-resource-panel');
      var ids = [], usedEles = [];
      for( var i = 0; i < eles.length; i++ ) {
        if( !eles[i].isSelected() || eles[i].resource.fromZip ) continue;
        eles[i].querySelector('#deletePanel').style.display = 'inline-block';
        ids.push(eles[i].resource.id);
        usedEles.push(eles[i]);
      }

      ecosis.ckan.deleteResources(ids, function(resp){
        if( resp.error ) {
          // ERROR 11
          resp.code = 11;
          return ecosis.errorPopup.show(resp);
        }

        for( var i = 0; i < usedEles.length; i++ ) {
          $(usedEles[i]).remove();
        }

        for( var i = ecosis.ds.resources.length - 1; i >= 0; i-- ) {
          if( ids.indexOf(ecosis.ds.resources[i].id) > -1 ) {
            ecosis.ds.resources.splice(i, 1);
          }
        }

        ecosis.ds.fireUpdate();

        if( ecosis.ds.resources.length == 0 ) {
          this.$.noResources.style.display = 'block';
          this.$.legend.style.display = 'none';
          this.$.removeAll.style.display = 'none';
        }

      }.bind(this));
    },

    selectAll : function() {
      var eles = this.querySelectorAll('ecosis-resource-panel');
      for( var i = 0; i < eles.length; i++ ) eles[i].select(true);
      this.updateSelectState();
    },

    unselectAll : function() {
      var eles = this.querySelectorAll('ecosis-resource-panel');
      for( var i = 0; i < eles.length; i++ ) eles[i].select(false);
      this.updateSelectState();
    },

    updateSelectState : function() {
      var eles = this.querySelectorAll('ecosis-resource-panel');
      for( var i = 0; i < eles.length; i++ ) {
        if( eles[i].isSelected() ) {
          this.$.deleteAll.style.display = 'block';
          return;
        }
      }
      this.$.deleteAll.style.display = 'none';
    },

    onResourceUpdate : function(e) {
      var id = e.originalEvent.detail;

      var panels = this.$.resourceRoot.querySelectorAll('ecosis-resource-panel');
      for( var i = 0; i < panels.length; i++ ) {
        if( panels[i].edit && panels[i].resourceid != id ) {
          var panel = panels[i]
          // hide resource
          panel.toggleEdit();
          // clear cached 'full' datasheet
          if( panel.$.datasheetUI ) {
            panel.$.datasheetUI.datasheet = null;
          }
        }
      }

      if( ecosis.ds.resources.length == 0 ) {
        this.$.noResources.style.display = 'block';
        this.$.legend.style.display = 'none';
        this.$.removeAll.style.display = 'none';
      }

    }


  });
</script>
