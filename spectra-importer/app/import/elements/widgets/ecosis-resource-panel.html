<link rel="import" href="ecosis-datasheet-select-panel.html" >
<link rel="import" href="ecosis-datasheet-panel.html" >

<dom-module id="ecosis-resource-panel">
  <style>
    :host {
      display: block;
    }
    a.btn-link {
      padding-top: 0;
    }
    span.label-danger {
      box-shadow: 0 0 5px white;
      border: 1px solid white;
    }
    input[type="checkbox"]:after {
      border: 2px solid white !important;
    }
    .alert-primary {
      background-color: #2196f3;
    }
    .alert-default {
      background-color: #888;
    }
  </style>

  <template>
    <div class="alert alert-default" id="root">


          <div class="layout horizontal">
            <div class="flex">
              <input type="checkbox" id="select" on-click="fireSelectEvent"/>
              <span id="titleLabel"></span>
              <a class="btn btn-link" style="color:white" on-click="delete" id="trashBtn"><i class="fa fa-trash"></i></a>
              <span class="label label-danger" id="deletePanel" style="display:none">
                <i class="fa fa-spinner fa-spin"></i> Deleting Resource...
              </span>
            </div>
            <div>
              <a class="btn btn-link" style="color:white" id="downloadBtn" target="_blank"><i class="fa fa-download"></i></a>

              <a class="btn btn-link" style="color:white" id="editLink" on-click="toggleEdit">
                <i class="fa fa-pencil" id="editLinkIcon"></i>
              </a>
            </div>
          </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ecosis-resource-panel',

    properties : {
      resourceid : {
        type : String
      }
    },

    ready : function() {
      this.datatypes = ['xls','xlsx','csv','tsv','spectra'];
      this.edit = false;
    },

    attached : function() {
      this.resource = null;

      for( var i = 0; i < ecosis.ds.resources.length; i++ ) {
        var resource = ecosis.ds.resources[i];
        if( this.resourceid == resource.id ) {
          this.resource = resource;
          break;
        }
      }

      this.update();
    },

    update : function() {
      this.$.titleLabel.innerHTML = this.resource.name +
        (this.resource.fromZip ? ' <i>from '+this.resource.zip.name+'</i>' : '');
      this.setClass();


      if( !this.resource.datasheets ) {
        this.$.trashBtn.style.color = '#333';
      }

      var url = ecosis.ckan.host+'/dataset/'+this.resource.package_id+'/resource/'+this.resource.id+'/download/'+this.resource.name;

      this.$.downloadBtn.setAttribute('href', url);
    },


    setClass : function() {
      var type = this.getResourceType();

      // update icons as well;
      if( this.resource.fromZip ) {
        this.$.trashBtn.style.display = 'none';
        this.$.downloadBtn.style.display = 'none';
      } else {
        this.$.trashBtn.style.display = 'inline-block';
        this.$.downloadBtn.style.display = 'inline-block';
      }

      if( type == 'zip' ) {
        this.$.editLink.style.display = 'none';
      } else {
        this.$.editLink.style.display = 'inline-block';
      }

      // update css class
      var className = this.getPanelClass(type);
      this.$.root.className = 'style-scope ecosis-resource-panel alert alert-'+className;
    },

    getPanelClass : function(type) {
      if( type == 'data' ) return 'success';
      if( type == 'metadata' ) return 'primary';
      if( type == 'zip' ) return 'info';
      return 'default';
    },

    getResourceType : function() {
      if( this.resource.datasheets && this.resource.datasheets.length == 1 ) {
        if( this.resource.datasheets[0].ignore ) {
          return 'ignored';
        } else if( this.resource.datasheets[0].metadata ) {
          return 'metadata';
        }
      }

      var type = this.resource.name.replace(/.*\./,'').toLowerCase();
      if( type == 'zip' ) {
        return 'zip';
      } else if( this.datatypes.indexOf(type) > -1 ) {
        return 'data';
      }

      return 'ignored';
    },

    toggleEdit : function() {
      var resourcePopup = document.querySelector('#resourcePopup');
      resourcePopup.show(this.resource,{
        onDatasheetUpdate : this.setClass.bind(this)
      });

      this.edit = !this.edit;

      this.fire('editing', this.resourceid);
    },

    fireSelectEvent : function() {
      this.fire('resource-select');
    },

    select : function(select) {
      if( select ) $(this.$.select).prop('checked', true);
      else $(this.$.select).prop('checked', false);
    },

    isSelected : function() {
      return $(this.$.select).is(':checked');
    },

    delete : function() {
      if( !confirm("Are you sure you want to remove: "+this.resource.name+"?") ) return;
      this.forceDelete();
    },

    forceDelete : function() {
      this.$.deletePanel.style.display = 'inline-block';

      ecosis.ckan.removeResource(this.resource.id,
        function(resp){
          this.$.deletePanel.style.display = 'block';

          if( resp.error ) return alert("Server error deleting resource");

          for( var i = 0; i < ecosis.ds.resources.length; i++ ) {
            if( ecosis.ds.resources[i] == this.resource ) {
              ecosis.ds.resources.splice(i, 1);
              ecosis.ds.fireUpdate();
              break;
            }
          }

          $(this).hide('slow', function(){
            $(this).remove();
          });

          this.fire('update', this.resourceid);
        }.bind(this)
      );
    }
  });
</script>
