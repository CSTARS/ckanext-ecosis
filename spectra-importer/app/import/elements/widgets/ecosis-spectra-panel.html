<link rel="import" href="ecosis-chart.html" >

<dom-module id="ecosis-spectra-panel">
  <style>
    :host {
      display: block;
    }
  </style>

  <template>
    <h6 id="loadingPanel" >
      <i class="fa fa-spinner fa-spin"></i> Loading Spectra #<span id="spectraIndexLabel"></span>...</div>
    </h6>

    <div id="mainPanel" style="display:none">
        <div style="text-align:right" id="spectraSelectPanel">
            Spectra #
            <select on-change="setIndex" class="form-control" style="width:100px; display:inline-block" id="select"></select>
        </div>

        <ecosis-chart id="chart"></ecosis-chart>
        <!--
        <esis-ui-chart data="{{data}}" options="{{chartOptions}}" height="500"></esis-ui-chart>
      -->

        <div id="tableRoot"></div>

    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ecosis-spectra-panel',

    ready : function() {
      this.$.chart.options = {
          explorer : {}
      }
    },

    update : function(resource, datasheet) {
      this.resource = resource;
      this.datasheet = datasheet;

      this.spectraCache = {};

      this.index = 0;

      var options = '';
      for( var i = 0; i < this.datasheet.spectra_count; i++ ) {
          options += '<option value="'+i+'">'+(i+1)+'</option>';
      }
      this.$.select.innerHTML = options;

      if( this.datasheet.spectra_count <= 1 ) {
        this.$.spectraSelectPanel.style.display = 'none';
      } else {
        this.$.spectraSelectPanel.style.display = 'block';
      }

      this.load();
    },

    clearCache : function() {
        this.spectraCache = {};
    },

    load : function() {
        this.$.spectraIndexLabel.innerText = this.index+1;

        if( this.spectraCache[this.index] ) {
            this.renderSpectra(this.spectraCache[this.index]);
            return;
        }

        this.setLoading(true);

        ecosis.ckan.getSpectra(
            ecosis.ds.package_id,
            this.resource.id,
            this.datasheet.id,
            this.index,
            function(resp) {

              this.setLoading(false);
              if( resp.error ) return alert('Error loading spectra: '+this.index);

              this.spectraCache[this.index] = resp;
              this.renderSpectra(resp);
            }.bind(this)
        )
    },

    setLoading : function(loading) {
      this.$.loadingPanel.style.display = loading ? 'block' : 'none';
      this.$.mainPanel.style.display = !loading ? 'block' : 'none';
    },

    renderSpectra : function(spectra) {
        this.currentSpectra = spectra;

        var re1Wave = /^-?\d+\.?\d*/;
        var re2Wave = /^-?\d*\.\d+/;

        this.data = [];
        for( var i = 0; i < spectra.datapoints.length; i++ ) {
            if( re1Wave.test(spectra.datapoints[i].key) || re2Wave.test(spectra.datapoints[i].key) ) {
                this.data.push([
                    parseFloat(spectra.datapoints[i].key),
                    parseFloat(spectra.datapoints[i].value)
                ])
            }
        }

        this.data.sort(function(a, b){
            if( a[0] > b[0] ) return 1;
            if( a[0] < b[0] ) return -1;
            return 0;
        });

        this.data.splice(0, 0, ['Wavelength', '']);
        this.$.chart.setData(this.data);

        this.attrs = [];

        for( var attrName in spectra ) {
            if( attrName == 'datapoints') continue;
            this.attrs.push({
                name: attrName,
                value: spectra[attrName],
                isEcosis : ( ecosis.ds.isEcosisMetadata(attrName) ) ? true : false
            });
        }

        this.attrs.sort(function(a, b){
            if( a.name > b.name ) return 1;
            if( a.name < b.name ) return -1;
            return 0;
        });

        this.renderTable();
    },

    renderTable : function() {
      var table = '<table class="table">';
      for( var i = 0; i < this.attrs.length; i++ ) {
        var attr = this.attrs[i];

        table +=
          '<tr class="'+(attr.isEcosis ? 'success' : '')+'" >'+
            '<td>'+attr.name+'</td>'+
            '<td>'+attr.value+'</td>'+
          '</tr>'
      }
      table += '</table>';

      this.$.tableRoot.innerHTML = table;
    },

    setIndex : function(e) {
        this.index = parseInt(e.currentTarget.value);
        this.load();
    }
  })
</script>
