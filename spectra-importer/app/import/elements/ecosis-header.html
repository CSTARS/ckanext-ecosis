<dom-module id="ecosis-header">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#ecosis-header-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <span class="navbar-brand">EcoSIS Importer <span id="score2" class="visible-xs-inline"></span></span>
        </div>

        <div class="collapse navbar-collapse" id="ecosis-header-collapse">
          <ul class="nav navbar-nav">

            <li class="active"><a  id="basicInfo"><i class="fa fa-info-circle"></i> Basic Information</a></li>

            <li class="dropdown" id="resourcesDropdown" style="display:none">
              <a class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                <i class="fa fa-files-o"></i> Resources <span class="caret"></span>
              </a>
              <ul class="dropdown-menu" role="menu">
                <li><a id="addResources"><i class="fa fa-plus"></i> Add Resources</a></li>
                <li><a id="currentResources"><i class="fa fa-list"></i> Current Resources</a></li>
              </ul>
            </li>

            <li><a id="advanced" style="display:none"><i class="fa fa-cog"></i> Advanced</a></li>
            <li><a id="push" style="display:none"><i class="fa fa-check-circle-o"></i> Publish</a></li>
            <li id="score" class="hidden-xs" style="padding-top:18px"></li>
          </ul>

          <ul class="nav navbar-nav navbar-right">
            <li><a href="http://tutorial.ecospectra.org" target="_blank"><i class="fa fa-question-circle"></i> Help</a></li>
            <li><a id="exit"><i class="fa fa-sign-in"></i> Exit</a></li>
          </ul>
        </div>
      </div>
    </nav>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ecosis-header',

    properties : {
      hack : {
        type : String,
        value : ''
      }
    },

    ready : function() {
      // such BS polymer!
      this.$.basicInfo.setAttribute('href', '#basic-info');
      this.$.addResources.setAttribute('href', '#add-resources');
      this.$.currentResources.setAttribute('href', '#current-resources');
      this.$.advanced.setAttribute('href', '#advanced');
      this.$.push.setAttribute('href', '#push');

      $(window).on('hashchange', this.updateActiveTab.bind(this));
      this.updateActiveTab();

      if( ecosis.ds.editMode ) {
        ecosis.ds.on('load', function(){
          if( ecosis.ds.editMode ) this.setBackBtn(ecosis.ds.package.getName());
        }.bind(this));
      } else {
        this.$.exit.setAttribute('href', '/dataset/');
      }

      var fn = new ecosis.app.UiBuffer(this.onScoreUpdated, 100, this);
      ecosis.ds.on('update', fn);
    },

    attached : function() {
      if( ecosis.ds.editMode ) {
        this.$.resourcesDropdown.style.display = 'block';
        this.$.advanced.style.display = 'block';
        this.$.push.style.display = 'block';
      }
    },

    setBackBtn : function(name) {
      this.$.exit.setAttribute('href', '/dataset/'+name);
    },

    updateActiveTab : function() {
      $('li').removeClass('active');

      var loc = window.location.hash.replace(/#/,'');
      var ele = $(this).find('a[href="#'+loc+'"]');

      if( ele.length > 0 && (loc == 'add-resources' || loc == 'current-resources') ) {
        $(this.$.resourcesDropdown).addClass('active');
      } else if ( ele.length > 0 ) {
        ele.parent().addClass('active');
      } else {
        $(this.$.basicInfo).parent().addClass('active');
      }
    },

    onScoreUpdated : function() {

      var result = ecosis.ds.getScore();

      var label = 'success';
      if( result.score < 3 ) label = 'danger';
      else if( result.score < 8 ) label = 'warning';

      this.$.score.innerHTML = '<span class="label label-'+label+'">'+result.score+'/'+result.total+'</span>';
      this.$.score2.innerHTML = '<span class="label label-'+label+'">'+result.score+'/'+result.total+'</span>';
    }

  });
</script>
