<dom-module id="ecosis-location-input">
  <style>
    :host {
      display : block;
    }
  </style>
  <template>
    <div class="well">
      <div id="map" style="height: 400px"></div>
      <div class="help-block">Draw bounding box for dataset.  If you provide latitude and
      longitude or geojson field(s) in your spectra, a bounding box for your dataset will
      be automatically calculated for search.</div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ecosis-location-input',

    attached : function() {
      this.drawing = false;

      this.map = L.map(this.$.map, {
          center: [0, 0],
          zoom: 2
      });

      L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(this.map);

      this.map.on('click', this.onClick.bind(this));
      this.map.on('mousemove', this.onMouseMove.bind(this));

      ecosis.ds.on('load', this.onLoad.bind(this));
    },

    onLoad : function() {
      var geojson = ecosis.ds.getDatasetExtra('geojson').value;
      if( !geojson ) return;

      var geojsonFeature = {
          "type": "Feature",
          "properties": {},
          "geometry": JSON.parse(geojson)
      };

      try {
        this.polygon = L.geoJson(geojsonFeature);
        this.polygon.addTo(this.map);
        this.polygon.on('click', this.onFeatureClick.bind(this));
      } catch(e) {}
    },

    onShow : function() {
      this.drawing = false;

      setTimeout(function(){
        this.map.invalidateSize();
      }.bind(this), 50);
    },

    onClick : function(e) {
      if( this.drawing ) {
        this.drawing = false;
        this.setPolygon(e.latlng);
        return;
      }

      this.drawing = true;
      this.p1 = e.latlng;
    },

    onFeatureClick : function(e) {
      if( this.drawing ) {
        return this.onClick(e);
      }

      // else clear
      if( this.polygon ) {
        this.map.removeLayer(this.polygon);
      }
      ecosis.ds.setDatasetExtra('geojson', null);
      this.fire('update', {
        attribute : 'geojson',
        value : null
      });
    },

    onMouseMove : function(e) {
      if( !this.drawing ) return;

      if( this.polygon ) {
        this.map.removeLayer(this.polygon);
      }
      var p2 = e.latlng;

      var coordinates = [[
          [this.p1.lng, this.p1.lat],
          [this.p1.lng, p2.lat],
          [p2.lng, p2.lat],
          [p2.lng, this.p1.lat],
          [this.p1.lng, this.p1.lat]
      ]];

      var geojsonFeature = {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type" : "Polygon",
            "coordinates" : coordinates
          }
      };

      this.polygon = L.geoJson(geojsonFeature);
      this.polygon.on('click', this.onFeatureClick.bind(this));
      this.polygon.addTo(this.map);
    },

    setPolygon : function(p2) {
      var geojson = {
        "type" : "Polygon",
        "coordinates" : [[
            [this.p1.lng, this.p1.lat],
            [this.p1.lng, p2.lat],
            [p2.lng, p2.lat],
            [p2.lng, this.p1.lat],
            [this.p1.lng, this.p1.lat]
        ]]
      }
      geojson = JSON.stringify(geojson);

      ecosis.ds.setDatasetExtra('geojson', geojson);
      this.fire('update', {
        attribute : 'geojson',
        value : geojson
      });
    }

  })
</script>
