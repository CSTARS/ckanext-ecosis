<polymer-element name="esis-ckan">
	<template></template>
	<script>
		Polymer('esis-ckan', {

			/**
			 * Create a ckan package
			 *
			 * pkg: object respresenting the package to be uploaded
			 * callback: callback handler
			 **/
			createPackage : function(pkg, callback) {
				$.ajax({
					url : esis.host+'/api/3/action/package_create',
					type : 'POST',
					data : JSON.stringify(pkg),
					xhrFields: {
				      withCredentials: true
				    },
					success : function(resp) {
						if( !resp.success ) return callback(resp);						
						callback(null, resp.result);
					},
					error : function() {
						callback({error:true, message:'Request Error'});
					}
				});
			},

			deletePackage : function(pkgid, callback) {
				$.ajax({
					url : esis.host+'/api/3/action/package_delete',
					type : 'POST',
					data : JSON.stringify({id: pkgid}),
					xhrFields: {
				      withCredentials: true
				    },
					success : function(resp) {
						if( !resp.success ) return callback(resp);						
						callback(null, resp.result);
					},
					error : function() {
						callback({error:true, message:'Request Error'});
					}
				});
			},

			updatePackage : function(pkg, callback) {
				$.ajax({
					url : esis.host+'/api/3/action/package_update',
					type : 'POST',
					data : JSON.stringify(pkg),
					xhrFields: {
				      withCredentials: true
				    },
					success : function(resp) {
						if( !resp.success ) return callback(resp);						
						callback(null, resp.result);
					},
					error : function() {
						callback({error:true, message:'Request Error'});
					}
				});
			},

			/**
			 * Get a ckan package by id
			 *
			 * pkgid: package id
			 * callback: callback handler
			 **/
			getPackage : function(pkgid, callback) {
				$.ajax({
		            url: esis.host + '/api/action/package_show?id='+pkgid,
		            xhrFields: {
				      withCredentials: true
				    },
		            success: function(response) {
		            	console.log(response);
		            	
		                if( !response.success ) return callback(response);
		                callback(null, response.result);
		            },
		            error: function(response) {
		            	if( response && response.responseJSON ) return callback(response.responseJSON);
		            	callback({error:true, message:'Request Error'});
		            }
		        });
			},

			processWorkspace : function(pkgid, callback) {
				$.ajax({
		            url: esis.host + '/workspace/process?package_id='+pkgid,
		            xhrFields: {
				      withCredentials: true
				    },
		            success: function(response) {
		                callback(null, response);
		            },
		            error: function(response) {
		            	if( response && response.responseJSON ) return callback(response.responseJSON);
		            	callback({error:true, message:'Request Error'});
		            }
		        });
			},

			processResource : function(pkgid, rid, callback) {
				$.ajax({
		            url: esis.host + '/workspace/processResource?package_id='+pkgid+'&resource_id='+rid,
		            xhrFields: {
				      withCredentials: true
				    },
		            success: function(response) {
		                callback(null, response);
		            },
		            error: function(response) {
		            	if( response && response.responseJSON ) return callback(response.responseJSON);
		            	callback({error:true, message:'Request Error'});
		            }
		        });
			},

			setParseInfo : function(pkgid, resource, callback) {
				$.ajax({
		            url: esis.host + '/workspace/setParseInfo',
		            type : 'POST',
		            xhrFields: {
				      withCredentials: true
				    },
				    data : {
				    	package_id : pkgid,
				    	resource : JSON.stringify(resource)
				    },
		            success: function(response) {
		                callback(null, response);
		            },
		            error: function(response) {
		            	if( response && response.responseJSON ) return callback(response.responseJSON);
		            	callback({error:true, message:'Request Error'});
		            }
		        });
			},

			// very similar to setParseInfo
			updateJoin : function(pkgid, rid, metadata, callback) {
				$.ajax({
		            url: esis.host + '/workspace/updateJoin',
		            type : 'POST',
		            xhrFields: {
				      withCredentials: true
				    },
				    data : {
				    	package_id : pkgid,
				    	resource_id : rid,
				    	metadata : JSON.stringify(metadata)
				    },
		            success: function(response) {
		                callback(null, response);
		            },
		            error: function(response) {
		            	if( response && response.responseJSON ) return callback(response.responseJSON);
		            	callback({error:true, message:'Request Error'});
		            }
		        });
			},

			setDefaultLayout : function(pkgid, resourceList, layout, callback) {
				$.ajax({
		            url: esis.host + '/workspace/setDefaultLayout',
		            type : 'POST',
		            xhrFields: {
				      withCredentials: true
				    },
				    data : {
				    	package_id : pkgid,
				    	resources : JSON.stringify(resourceList),
				    	layout : layout
				    },
		            success: function(response) {
		                callback(null, response);
		            },
		            error: function(response) {
		            	if( response && response.responseJSON ) return callback(response.responseJSON);
		            	callback({error:true, message:'Request Error'});
		            }
		        });
			},

			getUsdaCommonName : function(codes, callback) {
				$.ajax({
		            url: esis.host + '/spectra/getUsdaCommonName?codes='+codes,
		            xhrFields: {
				      withCredentials: true
				    },
		            success: function(response) {
		                if( !response.success ) return callback(response);
		                callback(null, response.result);
		            },
		            error: function(response) {
		            	if( response && response.responseJSON ) return callback(response.responseJSON);
		            	callback({error:true, message:'Request Error'});
		            }
		        });
			},

			/**
			 * Add a resource to a package using the browsers FormData object
			 *
			 * pkgid: id of the package to add to 
			 * file: object representing the to resource to upload
			 * callback: callback handler
			 * progress: callback for progress update
			 **/
			addResource : function(pkgid, file, callback, progress) {

		        // TODO: if this fails, we have an issue on our hands
		    	var formData = new FormData();

		    	formData.append('package_id', pkgid);
		    	formData.append('mimetype',file.mimetype);
		    	formData.append('name', file.filename);
		    	formData.append('upload', new Blob([file.contents], {type: file.mimetype}), file.filename);

		        var xhr = $.ajaxSettings.xhr();
		        // attach progress handler to the XMLHttpRequest Object
		        try {
		            if( progress ) {
		                xhr.upload.addEventListener("progress", function(evt){
		                    if (evt.lengthComputable) {  
		                        progress(((evt.loaded / evt.total)*100).toFixed(0));
		                    }
		                }, false); 
		            }
		        } catch(e) {}

		    	$.ajax({
				    url: esis.host + '/api/action/resource_create',
				    type: "POST",
				    data: formData,
				    processData: false,
				    contentType: false,
				    xhrFields: {
				      withCredentials: true
				    },
		            xhr : function() {
		                return xhr;
		            },
				    success: function(response, status) {
		                if( response.success || !response.error ) {
				            callback(null, response);
		                } else {
		                    callback(response);
		                }
				    },
				    error : function() {
				        callback({error:true,message:'Request Error'});
				    }
				});
			},

			addUrlResource : function(resource, callback) {
		    	$.ajax({
				    url: esis.host + '/api/action/resource_create',
				    type: "POST",
				    data: JSON.stringify(resource),
				    contentType: 'application/json',
				    xhrFields: {
				      withCredentials: true
				    },
				    success: function(response, status) {
		                if( response.success || !response.error ) {
				            callback(null, response);
		                } else {
		                    callback(response);
		                }
				    },
				    error : function() {
				        callback({error:true,message:'Request Error'});
				    }
				});
			},

			addSpectraInfo : function(info, callback) {
				$.ajax({
				    url: esis.host + '/spectra/addInfo',
				    type: "POST",
				    data: {
				    	info : JSON.stringify(info)
				    },
				    xhrFields: {
				      withCredentials: true
				    },
				    success: function(response, status) {
		                if( response.success || !response.error ) {
				            callback(null, response);
		                } else {
		                    callback(response);
		                }
				    },
				    error : function(err) {
				    	//debugger;
				        callback({error:true,message:'Request Error'});
				    }
				});
			},

			addUpdateSpectraPackage : function(pkgInfo, rebuildIndex, callback) {
				$.ajax({
				    url: esis.host + '/spectra/addUpdatePackage',
				    type: "POST",
				    data: {
				    	'package' : JSON.stringify(pkgInfo),
				    	'updateIndex' : rebuildIndex+''
				    },
				    xhrFields: {
				      withCredentials: true
				    },
				    success: function(response, status) {
		                if( response.success || !response.error ) {
				            callback(null, response);
		                } else {
		                    callback(response);
		                }
				    },
				    error : function(err) {
				    	//debugger;
				        callback({error:true,message:'Request Error'});
				    }
				});
			},

			getSpectraPackage : function(pkgname, callback) {
				$.ajax({
				    url: esis.host + '/spectra/getPackage?id='+pkgname,
				    type: "GET",
				    xhrFields: {
				      withCredentials: true
				    },
				    success: function(response, status) {
		                if( response.success || !response.error ) {
				            callback(null, response);
		                } else {
		                    callback(response);
		                }
				    },
				    error : function(err) {
				    	debugger;
				        callback({error:true,message:'Request Error'});
				    }
				});
			},

			getMetadataResource : function(resourceId, callback) {
				$.ajax({
				    url: esis.host + '/spectra/getMetadata?id='+resourceId,
				    type: "GET",
				    xhrFields: {
				      withCredentials: true
				    },
				    success: function(response, status) {
		                if( response.success || !response.error ) {
				            callback(null, response);
		                } else {
		                    callback(response);
		                }
				    },
				    error : function(err) {
				    	//debugger;
				        callback({error:true,message:'Request Error'});
				    }
				});
			},

			addSpectra : function(spectra, updateIndex, callback) {
				$.ajax({
				    url: esis.host + '/spectra/addSpectra',
				    type: "POST",
				    data: {
				    	spectra : JSON.stringify(spectra),
				    	updateIndex : updateIndex === true ? 'true' : 'false' 
				    },
				    xhrFields: {
				      withCredentials: true
				    },
				    success: function(response, status) {
				    	//debugger;
		                if( response.success || !response.error ) {
				            callback(null, response);
		                } else {
		                    callback(response);
		                }
				    },
				    error : function() {
				        callback({error:true,message:'Request Error'});
				    }
				});
			},

			/**
			 * Get the ecosis resource
			 **/
			getSpectraResource : function(id, callback, progress) { 
				var xhr = $.ajaxSettings.xhr();

		        // attach progress handler to the XMLHttpRequest Object
		        if( progress ) {
			        try {
			            xhr.addEventListener("progress", function(evt){
			                if (evt.lengthComputable) {  
			                	if( progress ) progress(((evt.loaded / evt.total)*100).toFixed(0));
			                }
			            }.bind(this), false); 
			        } catch(e) {}
		    	}

				$.ajax({
		            url: esis.host + '/spectra/get?metadataOnly=true&id='+id,
		            xhr : function() {
		                return xhr;
		            },
		            xhrFields: {
				      withCredentials: true
				    },
				    // don't let jquery muck with response
		            mimeType:'text/plain; charset=x-user-defined',
		            success: function(response) {
		            	callback(null, JSON.parse(response));
		            },
		            error: function() {
		            	callback({error:true,message:'failed to load resource'});
		            }
		        });
		    },

			removeResource: function(resourceId, callback) {
		        $.ajax({
	                type: 'POST',
	                url: esis.host + '/api/action/resource_delete',
	                data : JSON.stringify({id : resourceId }),
	                xhrFields: {
				      withCredentials: true
				    },
	                success: function(response) {
	                    if( !response.success ) return callback(response);
	                    callback(null, response);
	                },
	                error : function(){
	                	callback({error:true,message:'Request Error'});
	                }
		        });
		    }
		});
	</script>
</polymer-element>	