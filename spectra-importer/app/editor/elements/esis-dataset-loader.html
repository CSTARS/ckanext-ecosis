<link rel="import" href="../components/paper-dialog/paper-dialog.html">

<polymer-element name="esis-dataset-loader">
	<template>
		<paper-dialog id="dialog" transition="paper-transition-bottom" backdrop layered autoCloseDisabled>
			Loading Dataset...
		</paper-dialog>
	</template>
	<script>
		Polymer('esis-dataset-loader', {
			data : {},
			ds : {},
			ckan : {},
			pkgid : '',

			dataPackageLoaded : false,

			ready : function() {
				this.pkgid = this._getVar('id');
				if( this.pkgid == null ) return;

				this.ds = document.querySelector('esis-datastore');
				this.ckan = document.querySelector('esis-ckan');

				
				window.addEventListener('polymer-ready', function(e) {
					this.$.dialog.toggle();

					var ckan = document.querySelector('esis-ckan');
					ckan.initWorkspace(this.pkgid, function(err, result){
						this.$.dialog.toggle();

						if( err || result.error ) return alert('Error loading dataset.');

						this.data = result;
						this._setData();
					}.bind(this));
				}.bind(this));
			},

			_setData : function() {
				this.ds.editMode = true;
				this.ds.package_id = this.data.package.id;

				// set the default attirbutes for this dataset
				for( var key in this.ds.data ) {
					if( this.data.package[key] ) this.ds.data[key] = this.data.package[key];
				}


				if( this.data.ecosis ) {
					var ecosis = this.data.ecosis;

					// set the existing user modifications
					if( ecosis.attributes ) {
						this.ds.attributeModifications = ecosis.attributes.modifications;

						// set the known attribute name mappings
						this.ds.inverseAttributeMap = ecosis.attributes.map;
						for( var key in ecosis.attributes.map ) {
							this.ds.attributeMap[ecosis.attributes.map[key]] = key;
						}
						this.async(function(){
							this.ds.fire('attribute-map-update');
						});
						

						// set the known attribute types
						// add the wavelengths back into the types array
						for( var i = 0; i < ecosis.attributes.wavelengths.length; i++ ) {
							ecosis.attributes.types.push({
								type : 'data',
								flag : this.ds.ATTR_FLAGS.IS_WAVELENGTH,
								name : ecosis.attributes.wavelengths[i]
							});
						}
						this.ds.existingAttributeTypes = ecosis.attributes.types;

						// set the dataset attributes
						for( var key in this.ds.datasetAttributes ) {
							if( ecosis.attributes.dataset[key] ) {
								this.ds.datasetAttributes[key] = ecosis.attributes.dataset[key];
							}
						}
					}
				}

				this.ds.resources = this.data.resources;

				//if( !this.data.resources ) return;

				//for( var i = 0; i < this.data.resources.length; i++ ) {
            	//	this.ds.resources.push(this.data.resources[i]);
            	//}

           		//this.ds.existing.metadata = ecosis.metadata;
           		//this.ds.existing.data = ecosis.data;

            	//this._getExistingMetadata(0);
			},

			_getExistingMetadata : function(index) {
				var len = this.data.ecosis.metadata.length;

				if( len > 0 ) {
					this.fire('get-data-resource-progress', index / len );
				}

				if( index == len ) {
					this.fire('get-data-resource-complete');
					this.dataPackageLoaded = true;
				} else {
					this.ckan.getMetadataResource(
						this.data.ecosis.metadata[index].resource_id, 
						function(err, resp) {
							if( err ) return;
							
							var mdObj = resp.ecosis;

							var datasheet = document.createElement('esis-datasheet');
							datasheet.isMetadata = true;
							datasheet.isExisting = true;

							var metadata = document.createElement('esis-metadata');
							metadata.metadata = mdObj.metadata;
							metadata.joinId = mdObj.join_id;
							metadata.resourceId = mdObj.resource_id;
							metadata.isExisting = true;
							metadata.filename = resp.name;

							// set join information
							if( mdObj.join_on.type == 'filename' ) {
								metadata.filenameMatch = true;
								if( mdObj.join_on.loose ) metadata.looseMatch = true;
							} else if ( mdObj.join_on.type == 'worksheet' ) {
								metadata.worksheetMatch = true;
							}

							datasheet.metadata = metadata;
							this.ds.datasheets.push(datasheet);

							index++;
							this._getExistingMetadata(index);
					}.bind(this));
				}
			},

			_getVar : function(variable) {
       			var query = window.location.search.substring(1);
       			var vars = query.split("&");
       			for (var i = 0; i < vars.length; i++) {
               		var pair = vars[i].split("=");
               		if( pair[0] == variable ) return pair[1];
       			}
       			return null;
			}
		});
	</script>
</polymer-element>