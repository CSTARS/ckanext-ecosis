<polymer-element name="esis-dataset-loader">
	<template>
		<paper-dialog id="dialog" transition="paper-transition-bottom" backdrop layered autoCloseDisabled>
			Initializing Workspace & Loading Dataset...
		</paper-dialog>
	</template>
	<script>
		Polymer('esis-dataset-loader', {
			data : {},
			ds : {},
			ckan : {},
			pkgid : '',

			dataPackageLoaded : false,

			ready : function() {
				this.pkgid = this._getVar('id');
				
				this.ds = document.querySelector('esis-datastore');
				this.ckan = document.querySelector('esis-ckan');

				if( this.pkgid == null ) return;

				Polymer.whenPolymerReady(function() {
					this.$.dialog.toggle();

					this.async(function(){
						this.run(true);
					});
				}.bind(this));
			},

			run : function(toggle) {
				var ckan = document.querySelector('esis-ckan');
				ckan.processWorkspace(this.pkgid, function(err, result){
					if( toggle ) this.$.dialog.toggle();

					if( err || result.error ) return alert('Error loading dataset.');

					this.data = result;
					this._setData();

					setTimeout(function(){
						this.ds.loaded = true;
					}.bind(this), 1000);
				}.bind(this));
			},

			runAfterResourceAdd : function(workspaceData) {
				this.data = workspaceData;
				this._setData();
			},

			_setData : function() {
				this.ds.editMode = true;
				this.ds.package_id = this.data.package.id;

				// set the default attirbutes for this dataset
				for( var key in this.ds.data ) {
					if( this.data.package[key] ) this.ds.data[key] = this.data.package[key];
				}

				this.ds.schema = [];
				for( var attrName in this.data.attributes ) {
					var attr = this.data.attributes[attrName];
					attr.name = attrName;
					this.ds.schema.push(attr);
				}

				this.ds.wavelengths = this.data.wavelengths;

				if( this.data.datasetAttributes ) {
					this.ds.datasetAttributes = this.data.datasetAttributes;
				}

				if( this.data.attributeMap ) {
					this.ds.inverseAttributeMap = this.data.attributeMap;
					for( var key in this.data.attributeMap ) {
						this.ds.attributeMap[this.data.attributeMap[key]] = key;
					}
				}

				this.data.resources.sort(function(a, b){
					if( a.name > b.name ) return 1;
					if( a.name < b.name ) return -1;
					return 0;
				});
				this.ds.resources = this.data.resources;
			},

			_getVar : function(variable) {
       			var query = window.location.search.substring(1);
       			var vars = query.split("&");
       			for (var i = 0; i < vars.length; i++) {
               		var pair = vars[i].split("=");
               		if( pair[0] == variable ) return pair[1];
       			}
       			return null;
			}
		});
	</script>
</polymer-element>