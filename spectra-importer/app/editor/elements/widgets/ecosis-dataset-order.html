<dom-module id="ecosis-dataset-order">
  <style>
    :host {
      display : block;
    }
    .save-label {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        text-align: center;
        z-index: 1000;
        display: none;
    }
  </style>

  <template>
    <div class="save-label" id="saveLabel">
      <span class="label label-primary"><i></i> Saving...</span>
    </div>

    <div class="well">
      <div>
          Is this a time series dataset or a dataset that has any other form of ordering?
          If so, select the attribute to order by as well as the type of sort that should
          be performed.  You can also provide a textual description of what this ordering is.
      </div>

      <div class="form-horizontal">
        <div class="form-group">
          <label for="orderByInput" class="col-md-2 control-label">Order By</label>
          <div class="col-md-10">
            <select id="orderByInput" class="form-control" on-change="onChange"></select>
          </div>
        </div>

        <div class="form-group" style="display:none" id="secondaryPanel">
          <label for="orderTypeInput" class="col-md-2 control-label">Order Type</label>
          <div class="col-md-10">

            <select id="orderTypeInput" class="form-control" on-change="onChange">
                <option value="string">Default (String)</option>
                <option value="datetime">Date</option>
                <option value="numeric">Numeric</option>
            </select>

            <div class="help-block" id="dateHelp" style="display:none">
                Use <a href="http://www.w3.org/TR/NOTE-datetime" target="_blank">ISO-8601</a>
                for which the format is: YYYY-MM-DDTHH:mm:ss.sssZ.
                <a href="http://xkcd.com/1179/" target="_blank">Why?</a>
            </div>


            <input type="text" id="descriptionInput" class="form-control" on-change="onChange" placeholder="Description"/>

          </div>
        </div>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ecosis-dataset-order',

    ready : function() {
      ecosis.ds.on('load', this.update.bind(this));
    },

    onShow : function() {
      this.update();
    },

    update : function() {
      this.attributeArray = [];

      for( var i = 0; i < ecosis.ds.schema.length; i++ ) {
          var attr = ecosis.ds.schema[i];
          if( attr.type == 'metadata' ) this.attributeArray.push(attr);
      }

      this.attributeArray.sort(function(a, b){
          if( a.name > b.name ) return 1;
          if( a.name < b.name ) return -1;
          return 0;
      });

      var options = '<option></option>';
      for( var i = 0; i < this.attributeArray.length; i++ ) {
        options += '<option value="'+this.attributeArray[i].name+'">'+this.attributeArray[i].name+'</option>';
      }

      this.$.orderByInput.innerHTML = options;

      var sort_description = ecosis.ds.getDatasetExtra('sort_description').value || '';
      var sort_type = ecosis.ds.getDatasetExtra('sort_type').value || '';
      var sort_on = ecosis.ds.getDatasetExtra('sort_on').value || '';

      this.$.orderByInput.value = sort_on;
      this.$.orderTypeInput.value = sort_type;
      this.$.descriptionInput.value = sort_description;

      if( sort_on && sort_on != '' ) {
        this.$.secondaryPanel.style.display = 'block';
      } else {
        this.$.secondaryPanel.style.display = 'none';
      }

      if( sort_type == 'datetime' ) {
        this.$.dateHelp.style.display = 'block';
      } else {
        this.$.dateHelp.style.display = 'none';
      }
    },

    onChange : function() {
      var sort_on = this.$.orderByInput.value;
      var sort_type = this.$.orderTypeInput.value;

      ecosis.ds.setDatasetExtra('sort_description', this.$.descriptionInput.value);
      ecosis.ds.setDatasetExtra('sort_type', sort_type);
      ecosis.ds.setDatasetExtra('sort_on', sort_on);


      if( sort_on && sort_on != '' ) {
        this.$.secondaryPanel.style.display = 'block';
      } else {
        this.$.secondaryPanel.style.display = 'none';
      }

      if( sort_type == 'datetime' ) {
        this.$.dateHelp.style.display = 'block';
      } else {
        this.$.dateHelp.style.display = 'none';
      }

      if( this.timer != -1 ) clearTimeout(this.timer);

      this.timer = setTimeout(function() {
          this.timer = -1;
          this.save();
      }.bind(this), 2000);
    },

    save : function() {
        this.$.saveLabel.style.display = 'block';

        // make sure we have the correct package state
        // all resources need to be included when you make a updatePackage call
        ecosis.ckan.getPackage(ecosis.ds.package_id,
          function(resp) {
            if( resp.error ) {
              this.$.saveLabel.style.display = 'none';
              return alert('Failed to fetch for dataset update :(');
            }

            var metadata = resp.result;
            for( var key in ecosis.ds.data ) {
              metadata[key] = ecosis.ds.data[key];
            }

            ecosis.ckan.updatePackage(metadata,
              function(resp) {
                this.$.saveLabel.style.display = 'none';

                if( resp.error ) return alert('Failed to update dataset :(');
                if( !resp.result.id ) return alert('Failed to update dataset :(');

              }.bind(this)
            );
          }.bind(this)
        );
    }
  });
</script>
