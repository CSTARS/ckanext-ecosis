<link rel="import" href="esis-ui-card.html" />
<link rel="import" href="esis-ui-metadata.html" />
<link rel="import" href="../../components/paper-button/paper-button.html" />
<link rel="import" href="../../components/core-collapse/core-collapse.html" />

<polymer-element name="esis-ui-datasheet" attributes="resourceId datasheet showName">
	<template>
		<style>
            :host{
                display: block;
            }
            .static-info {
                color: #888;
                padding: 3px;
                font-size: 12px;
                margin-left: 15px;
            }
            h6 {
                margin: 15px 0 3px 0;
            }
            .options {
                border-top: 1px solid #eee;
                margin: 0 5px 30px 5px;
                padding: 0 5px 5px 5px;
            }
            a {
                color: #2f9b45;
                cursor: pointer;
            }
            .toggle-btn {
                margin: 0 0 0 12px;
            }
            .toggle-label {
                display: inline-block;
                padding-top: 12px;
                vertical-align: top;
            }
            #wavelengths {
                color: #888;
                font-size: 12px;
            }
		</style>


        <h6 hidden?="{{!showName}}">
            {{datasheet.name}}
            <span hidden?="{{!datasheet.sheet}}">({{datasheet.sheet}})</span>
        </h6>
            

        <div horizontal layout style="margin: 20px 0 20px 20px" hidden?="{{datasheet.ignore}}">
            <paper-checkbox checked="{{datasheet.metadata}}" style="margin-right:15px" disabled?="{{datasheet.ignore}}"></paper-checkbox>
            <div>
                <div>Joinable Metadata</div>
                <div style="color:#888; font-size: 13px">This datasheet only contains metadata to be joined on given data.</div>
                
                <template bind if="{{datasheet.metadata}}">
                    <esis-ui-metadata 
                        metadata="{{datasheet}}"
                        resourceId="{{resourceId}}">
                    </esis-ui-metadata>
                </template>
            </div>
        </div>

        <div horizontal layout style="margin: 10px 0 7px 20px" hidden?="{{datasheet.metadata}}">
            <paper-checkbox checked="{{datasheet.ignore}}" style="margin-right:15px" on-tap="{{save}}"></paper-checkbox>
            <div>
                <div>Ignore</div>
                <div style="color:#888; font-size: 13px">This datasheet should not be parsed.</div>
            </div>
        </div>


        <div class="options" hidden?="{{datasheet.metadata || datasheet.ignore}}">
            <paper-radio-group 
                selected="{{datasheet.layout}}" 
                role="radiogroup">
                <paper-radio-button 
                    name="row" 
                    label="Row Format" 
                    role="radio" 
                    tabindex="0" 
                    aria-checked="true" 
                    aria-label="Row Format" 
                    class="core-selected"
                    on-tap="{{save}}">
                </paper-radio-button>
                <paper-radio-button 
                    name="column" 
                    label="Column Format" 
                    role="radio" 
                    tabindex="0" 
                    aria-checked="false" 
                    aria-label="Column Format"
                    on-tap="{{save}}">
                </paper-radio-button>
            </paper-radio-group>

            <a on-tap="{{_toggleHelp}}" style="float:right;display:inline-block;padding-top:10px">Format Help.</a>

            <core-collapse opened="{{showHelp}}" hidden?="{{datasheet.metadata || datasheet.ignore}}">
                <div style="margin: 30px 0 0 20px; padding-top: 10px; border-top: 1px solid #eee">
                    <esis-dataformat-help type="{{datasheet.layout}}"></esis-dataformat-help>
                </div>
            </core-collapse>
        </div>

        <template bind if="{{saving}}">
            <div>Updating...</div>
            <paper-progress indeterminate></paper-progress>
        </template>

        <div hidden?="{{datasheet.ignore}}">
            <div>
                <paper-icon-button 
                    icon="hardware:{{showAttrs ? 'keyboard-arrow-down' : 'keyboard-arrow-right'}}" 
                    on-tap="{{_toggleAttrs}}"
                    class="toggle-btn"
                    disabled?="{{parsedAttributes.length == 0}}">
                </paper-icon-button>
                <div class="toggle-label">Attributes: {{parsedAttributes.length}}</div>
            </div>
            <core-collapse opened="{{showAttrs}}" style="margin-bottom: 30px">
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Units</th>
                        <th>Type</th>
                    </tr>
                    <tr template repeat="{{info in parsedAttributes}}">
                        <td class="{{info.class}}">
                            <esis-attribute-name 
                                name="{{info.name}}" 
                                esisName="{{ds.metadataDefinitions[info.name]}}"
                                mappedName="{{ds.inverseAttributeMap[info.name]}}">
                            </esis-attribute-name>
                        </td>
                        <td class="{{info.class}}">{{info.units}}</td>
                        <td class="{{info.class}}">{{info.type}}</td>
                    </tr>
                </table>
            </core-collapse>

            <div hidden?="{{datasheet.metadata}}">
                <paper-icon-button 
                    icon="hardware:{{showWavelengths ? 'keyboard-arrow-down' : 'keyboard-arrow-right'}}" 
                    on-tap="{{_toggleWavelengths}}"
                    class="toggle-btn"
                    disabled?="{{wavelengths.length == 0}}">
                </paper-icon-button>
                <div class="toggle-label">Wavelengths: {{wavelengths.length}}</div>
            <div id="wavelengths" hidden?="{{!showWavelengths}}"></div>
        </div>

        <div hidden?="{{!datasheet.ignore}}" class="ignored">
            Ignored
        </div>


	</template>
	<script>
		Polymer('esis-ui-datasheet', {
			datasheet : null,

            showName : false,

			open : false,
            edit: false,

            showHelp : false,

            parsedAttributes : [],
            wavelengths : [],

            showWavelengths : false,
            showAttrs : false,

            ds : null,

			// chart vars
			dt : null,
			chart : null,
			maxLineCount : 30,

            saving : false,

			observe : {
                'datasheet' : 'update',
				'datasheet.attributes' : 'update'
			},

            ready : function() {
                this.ds = document.querySelector('esis-datastore');
            },

			update : function() {
                if( !this.datasheet ) return;

                if( !this.datasheet.attributes ) this.datasheet.attributes = [];

                this._setAttributes();
                this.showWavelengths = false;
                //this.datasheet.addEventListener('datasheet-updated', this._setAttributes.bind(this));
			},

            save : function() {
                this.saving = true;
                var resource = {
                    id : this.resourceId,
                    datasheets : [{
                        id : this.datasheet.id,
                        layout : this.datasheet.layout,
                        ignore : this.datasheet.ignore ? true : false
                    }]
                };

                document.querySelector('esis-ckan').setParseInfo(
                    this.ds.package_id, 
                    resource,
                    function(err, resp){
                        this.saving = false;
                        if( err ) alert("Error updating datasheet :(");

                        for( var i = 0; i < resp.datasheets.length; i++ ) {
                            if( resp.datasheets[i].id == this.datasheet.id ) {
                                for( var key in resp.datasheets[i] ) {
                                    this.datasheet[key] = resp.datasheets[i][key];
                                }
                                return;
                            }
                        }
                    }.bind(this)
                ); 
            },

            _setAttributes : function() {

                this.parsedAttributes = [];
                this.wavelengths = [];

                for( var i = 0; i < this.datasheet.attributes.length; i++ ) {
                    var attr = this.datasheet.attributes[i];

                    if( attr.type == 'wavelength' ) {
                        this.wavelengths.push(attr.name+(attr.label ? ' <span style="color:#888">('+attr.label+')</span>' : '') )
                    } else if ( attr.type == 'metadata' ) {
                        this.parsedAttributes.push({
                            name : attr.name,
                            units : attr.units || '',
                            type : 'Spectra Metadata',
                            class : 'spectra'
                        });
                    }
                }

                /*var info;
                for( var key in this.datasheet.attributeTypes ) {
                    info = this.datasheet.attributeTypes[key];

                    switch(info.flag) {
                        case this.ds.ATTR_FLAGS.FROM_METADATA:
                            this.parsedAttributes.push({
                                name : key,
                                units : info.units || '',
                                type : 'Joinable Metadata',
                                class : '',
                            });
                            break;

                        case this.ds.ATTR_FLAGS.FROM_MIXED_FILE:
                            var type = info.type;
                            if( this.ds.attributeModifications[key] ) type = this.ds.attributeModifications[key];

                            if( type == 'metadata' ) {
                                this.parsedAttributes.push({
                                    name : key,
                                    units : info.units || '',
                                    type : 'Spectra Metadata',
                                    class : 'spectra'
                                });
                            } else {
                                this.parsedAttributes.push({
                                    name : key,
                                    units : info.units || '',
                                    type : 'Data',
                                    class : 'data'
                                });
                            }
                            break;

                        case this.ds.ATTR_FLAGS.IS_WAVELENGTH:
                            this.wavelengths.push(key+(info.label ? ' <span style="color:#888">('+info.label+')</span>' : '') );
                            break;

                        case this.ds.ATTR_FLAGS.IS_FILE_METADATA:
                            this.parsedAttributes.push({
                                name : key,
                                units : info.units || '',
                                type : 'File Metadata',
                                class : 'file'
                            });
                            break;

                        case this.ds.ATTR_FLAGS.IS_MEASUREMENT_METADATA:
                            this.parsedAttributes.push({
                                name : key,
                                units : info.units || '',
                                type : 'Spectra Metadata',
                                class : 'spectra'
                            });
                            break;

                        case this.ds.ATTR_FLAGS.IS_FILE_DATA:
                            this.parsedAttributes.push({
                                name : key,
                                units : info.units || '',
                                type : 'Derived Data',
                                class : 'data'
                            });
                            break;

                        default:
                            break;
                    }
                }*/

                this.$.wavelengths.innerHTML = this.wavelengths.join(', ');

                if( this.datasheet.isMetadata ){
                    this.async(function(){
                        this.shadowRoot.querySelector('esis-ui-metadata').update();
                    });
                }

            },

			_toggle : function() {
				this.open = !this.open;

				if( this.open && this.datasheet.measurements.length > 0 ) {
					this.$.chart.style.height = '400px';
					setTimeout(function(){
						this._createChart();
					}.bind(this), 500);
				} else if( !this.open ) {
					this.chart = null;
					this.$.chart.innerHTML = '';
				}

				this.$.collapse.toggle();
			},

            _toggleWavelengths : function() {
                this.showWavelengths = !this.showWavelengths;
            },

            _toggleAttrs : function() {
                this.showAttrs = !this.showAttrs;
            },

			_createChart : function() {
				if( !this.dt ) {
					this.dt = new google.visualization.DataTable();
			  		var rows = [];

					this.dt.addColumn('number', 'Wavelength');
					for( var i = 0; i < this.datasheet.measurements.length; i++ ) {
					  	if( i == this.maxLineCount ) break;
					    this.dt.addColumn('number', ''+i);
					}

					for( var i = 0; i < this.datasheet.measurements[0].data.length; i++ ) {

					  	// add the wavelength
					  	var row = [parseFloat(this.datasheet.measurements[0].data[i][0])];
					  	var addRow = true;

					  	for( var j = 0; j < this.datasheet.measurements.length; j++ ) {
					  		if( j == this.maxLineCount ) break;

					  		var f = parseFloat(this.datasheet.measurements[j].data[i][1]);
					  		if( isNaN(f) ) f = 0;
					  		if(  j == 0 && f == 0 ) {
					  			addRow = false;
					  			break;
					  		}

					  		row.push(f);
					  	}
					  	if( addRow ) rows.push(row);
					}

					rows.sort(function(a, b){
				    	if( a[0] > b[0] ) return 1;
				    	if( a[0] < b[0] ) return -1;
				    	return 0;
				    });

				    this.dt.addRows(rows);
				}
				this._draw();
			},

			_draw : function() {
				// Set chart options
			    var options = {
			        width : $(this.$.chart).width(),
			        height : 400,
			        legend : {
			          	position : 'none'
			        }
			    };

			      // Instantiate and draw our chart, passing in some options.
			    if( !this.chart ) this.chart = new google.visualization.LineChart(this.$.chart);
			    this.chart.draw(this.dt, options);
			},

            _toggleHelp : function() {
                this.showHelp = !this.showHelp;
            },

            goToAttrSettings : function() {
                window.location.hash = 'schema-settings';
            },

            _goToJoin : function() {
                window.location.hash = 'join';
            }
		});
	</script>
<polymer-element>