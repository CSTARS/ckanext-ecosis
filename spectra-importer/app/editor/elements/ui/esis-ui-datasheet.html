<link rel="import" href="esis-ui-card.html" />
<link rel="import" href="esis-ui-metadata.html" />
<link rel="import" href="../../components/paper-button/paper-button.html" />
<link rel="import" href="../../components/core-collapse/core-collapse.html" />

<polymer-element name="esis-ui-datasheet" attributes="datasheet">
	<template>
		<style>

            table {
                width: 100%;
                border-spacing: 0px;
                border-collapse: separate;
                border-top: 1px solid #ddd;
                border-left: 1px solid #ddd;
                background-color: white;
            }
            table td {
                padding: 10px;
                border-right: 1px solid #ddd;
                border-bottom: 1px solid #ddd;
            }
            table th {
                padding: 10px;
                border-right: 1px solid #ddd;
                border-bottom: 1px solid #ddd;
            }

            .file {
                background-color: #dff0d8;
            }
            .spectra {
                background-color: #fcf8e3;
            }
            .data {
                background-color: #d9edf7;
            }

			table tr th {
				text-align: left;
			}
			h4 {
				margin: 5px;
			}
			.float-right {
				position: absolute;
				right: -20px;
				top: -10px;
			}
			paper-radio-button[disabled] {
                color: #888;
            }
            paper-radio-group[disabled] {
                opacity: .5;
            }
            .attribute-panel {
                border-top: 1px dashed #eee;
                padding: 10px 10px 0 20px;
                font-size: 13px;
            }
            a {
                color: #2f9b45;
                cursor: pointer;
            }
            .note {
                color: #777;
                font-size: 13px;
            }

            .options {
                background-color: #eee;
                border-radius: 4px;
                padding: 15px 10px;
            }

            esis-ui-card {
                position: relative;
            }
            paper-icon-button {
                color: #2f9b45;
            }

            .processing {
                z-index: 100;
                position: absolute;
                width:100%;
                height: 100%;
                text-align: center;
                padding-top: 100px;
                font-size: 20px;
                color: #333;
                background-color: rgba(255,255,255,.7);
            }
            .ignored {
                text-align: center;
                padding: 35px;
                color: #888;
                font-size: 32px;
            }
		</style>

		<esis-ui-card style="padding:10px"  class="{{datasheet.updating ? 'updating' : ''}}">
            <div class="processing" hidden?="{{!datasheet.updating}}">Processing...</div>
			<h4 style="border-bottom: 1px solid #eee;margin-bottom:25px;padding-bottom:5px">
                {{datasheet.label}}
                <!--<div>{{datasheet.contents.name}}</div>
                <div style="font-size:14px; color: #888" hidden?="{{!datasheet.contents.sheetName || datasheet.contents.sheetName == ''}}">
                    {{datasheet.contents.sheetName}}
                </div>-->
            </h4>

            <div class="options">
                <span style="float: right">Parser: {{datasheet.contents.info.parser}}</span>
    			
    			<template bind if="{{datasheet.contents.error}}">
    				<div style="color:red">Error: {{datasheet.contents.error}}</div>
    			</template>
    			<template bind if="{{datasheet.contents.warning}}">
    				<div style="color:orange">Warning: {{datasheet.contents.warning}}</div>
    			</template>

                <div horizontal layout style="margin: 10px 0 20px 20px">
                    <paper-checkbox checked="{{datasheet.isMetadata}}" style="margin-right:10px" disabled?="{{datasheet.ignore}}"></paper-checkbox>
                    <div>
                        <div>Joinable Metadata File</div>
                        <div style="color:#888; font-size: 13px">This datasheet only contains metadata to be joined on given data.</div>
                        
                        <template bind if="{{datasheet.isMetadata}}">
                            <esis-ui-metadata 
                                metadata="{{datasheet.metadata}}"
                                attributeTypes="{{datasheet.attributeTypes}}">
                            </esis-ui-metadata>
                        </template>
                    </div>
                </div>

                <div horizontal layout style="margin: 10px 0 20px 20px">
                    <paper-checkbox checked="{{datasheet.ignore}}" style="margin-right:10px" disabled?="{{datasheet.isMetadata}}"></paper-checkbox>
                    <div>
                        <div>Ignore</div>
                        <div style="color:#888; font-size: 13px">This datasheet should not be parsed.</div>
                    </div>
                </div>


                <div>
                    <paper-radio-group selected="{{datasheet.dataType}}" role="radiogroup" style="margin-left: 10px" disabled?="{{datasheet.isMetadata}}">
                        <paper-radio-button 
                            name="spectra" 
                            label="Spectra Data Format" 
                            role="radio" 
                            tabindex="0" 
                            aria-checked="true" 
                            aria-label="Spectra Data Format" 
                            class="core-selected" 
                            disabled?="{{datasheet.isMetadata || datasheet.ignore}}">
                        </paper-radio-button>
                        <paper-radio-button 
                            name="timeseries" 
                            label="Time Series Data Format" 
                            role="radio" 
                            tabindex="0" 
                            aria-checked="false" 
                            aria-label="Time Series Data Format"
                            disabled?="{{datasheet.isMetadata || datasheet.ignore}}">
                        </paper-radio-button>
                    </paper-radio-group>

                    <div style="margin-left:55px" hidden?="{{datasheet.isMetadata || datasheet.ignore}}">
                        <div class="note" hidden?="{{datasheet.dataType != 'spectra'}}">
                            View datasheet per spectra measurement. <a on-tap="{{_toggleHelp}}">Help.</a>
                        </div>
                        <div class="note" hidden?="{{datasheet.dataType != 'timeseries'}}">
                            View datasheet data per time measurement. <a on-tap="{{_toggleHelp}}">Help.</a>
                        </div>
                    </div>

                    <core-collapse opened="{{showHelp}}" hidden?="{{datasheet.isMetadata || datasheet.ignore}}">
                        <div style="margin: 30px 0 0 20px; padding-top: 10px; border-top: 1px solid #eee">
                            <esis-dataformat-help type="{{datasheet.dataType}}"></esis-dataformat-help>
                        </div>
                    </core-collapse>
                </div>
            </div>

            <div hidden?="{{datasheet.ignore}}">
                <h4>
                    <div layout horizontal>
                        <div>
                            <paper-icon-button 
                                icon="hardware:{{showAttrs ? 'keyboard-arrow-down' : 'keyboard-arrow-right'}}" 
                                on-tap="{{_toggleAttrs}}">
                            </paper-icon-button>
                            Parsed Attributes: {{parsedAttributes.length}}
                        </div>
                        <div flex style="text-align:right">
                            <a on-tap="{{goToAttrSettings}}" style="display:block;margin-top:10px">
                                <core-icon icon="settings"></core-icon> Configure Dataset Schema
                            </a>
                        </div>
                    </div>
                </h4>
                <core-collapse opened="{{showAttrs}}" style="margin-bottom: 30px">
                    <table>
                        <tr>
                            <th>Name</th>
                            <th>Units</th>
                            <th>Type</th>
                        </tr>
                        <tr template repeat="{{info in parsedAttributes}}">
                            <td class="{{info.class}}">
                                <esis-attribute-name 
                                    name="{{info.name}}" 
                                    esisName="{{ds.metadataDefinitions[info.name]}}"
                                    mappedName="{{ds.inverseAttributeMap[info.name]}}">
                                </esis-attribute-name>
                            </td>
                            <td class="{{info.class}}">{{info.units}}</td>
                            <td class="{{info.class}}">{{info.type}}</td>
                        </tr>
                    </table>
                </core-collapse>

                <h4>Wavelengths: {{wavelengths.length}} <small><a on-tap="{{_toggleWavelengths}}">show</a></small></h4>
                <div id="wavelengths" hidden?="{{!showWavelengths}}">
                    
                </div>
            </div>

            <div hidden?="{{!datasheet.ignore}}" class="ignored">
                Ignored
            </div>


		</esis-ui-card>
	</template>
	<script>
		Polymer('esis-ui-datasheet', {
			datasheet : null,

			open : false,

            showHelp : false,

            parsedAttributes : [],
            wavelengths : [],

            showWavelengths : false,
            showAttrs : true,

            ds : null,

			// chart vars
			dt : null,
			chart : null,
			maxLineCount : 30,

			observe : {
				datasheet : 'update'
			},

            ready : function() {
                this.ds = document.querySelector('esis-datastore');
            },

			update : function() {
                if( !this.datasheet ) return;

                this._setAttributes();
                this.showWavelengths = false;
                this.datasheet.addEventListener('datasheet-updated', this._setAttributes.bind(this));
			},

            _setAttributes : function() {

                this.parsedAttributes = [];
                this.wavelengths = [];

                var info;
                for( var key in this.datasheet.attributeTypes ) {
                    info = this.datasheet.attributeTypes[key];

                    switch(info.flag) {
                        case this.ds.ATTR_FLAGS.FROM_METADATA:
                            this.parsedAttributes.push({
                                name : key,
                                units : info.units || '',
                                type : 'Joinable Metadata',
                                class : '',
                            });
                            break;

                        case this.ds.ATTR_FLAGS.FROM_MIXED_FILE:
                            var type = info.type;
                            if( this.ds.attributeModifications[key] ) type = this.ds.attributeModifications[key];

                            if( type == 'metadata' ) {
                                this.parsedAttributes.push({
                                    name : key,
                                    units : info.units || '',
                                    type : 'Spectra Metadata',
                                    class : 'spectra'
                                });
                            } else {
                                this.parsedAttributes.push({
                                    name : key,
                                    units : info.units || '',
                                    type : 'Data',
                                    class : 'data'
                                });
                            }
                            break;

                        case this.ds.ATTR_FLAGS.IS_WAVELENGTH:
                            this.wavelengths.push(key+(info.label ? ' <span style="color:#888">('+info.label+')</span>' : '') );
                            break;

                        case this.ds.ATTR_FLAGS.IS_FILE_METADATA:
                            this.parsedAttributes.push({
                                name : key,
                                units : info.units || '',
                                type : 'File Metadata',
                                class : 'file'
                            });
                            break;

                        case this.ds.ATTR_FLAGS.IS_MEASUREMENT_METADATA:
                            this.parsedAttributes.push({
                                name : key,
                                units : info.units || '',
                                type : 'Spectra Metadata',
                                class : 'spectra'
                            });
                            break;

                        case this.ds.ATTR_FLAGS.IS_FILE_DATA:
                            this.parsedAttributes.push({
                                name : key,
                                units : info.units || '',
                                type : 'Derived Data',
                                class : 'data'
                            });
                            break;

                        default:
                            break;
                    }
                }

                this.$.wavelengths.innerHTML = this.wavelengths.join(', ');

                if( this.datasheet.isMetadata ){
                    this.async(function(){
                        this.shadowRoot.querySelector('esis-ui-metadata').update();
                    });
                }

            },

			_toggle : function() {
				this.open = !this.open;

				if( this.open && this.datasheet.measurements.length > 0 ) {
					this.$.chart.style.height = '400px';
					setTimeout(function(){
						this._createChart();
					}.bind(this), 500);
				} else if( !this.open ) {
					this.chart = null;
					this.$.chart.innerHTML = '';
				}

				this.$.collapse.toggle();
			},

            _toggleWavelengths : function() {
                this.showWavelengths = !this.showWavelengths;
            },

            _toggleAttrs : function() {
                this.showAttrs = !this.showAttrs;
            },

			_createChart : function() {
				if( !this.dt ) {
					this.dt = new google.visualization.DataTable();
			  		var rows = [];

					this.dt.addColumn('number', 'Wavelength');
					for( var i = 0; i < this.datasheet.measurements.length; i++ ) {
					  	if( i == this.maxLineCount ) break;
					    this.dt.addColumn('number', ''+i);
					}

					for( var i = 0; i < this.datasheet.measurements[0].data.length; i++ ) {

					  	// add the wavelength
					  	var row = [parseFloat(this.datasheet.measurements[0].data[i][0])];
					  	var addRow = true;

					  	for( var j = 0; j < this.datasheet.measurements.length; j++ ) {
					  		if( j == this.maxLineCount ) break;

					  		var f = parseFloat(this.datasheet.measurements[j].data[i][1]);
					  		if( isNaN(f) ) f = 0;
					  		if(  j == 0 && f == 0 ) {
					  			addRow = false;
					  			break;
					  		}

					  		row.push(f);
					  	}
					  	if( addRow ) rows.push(row);
					}

					rows.sort(function(a, b){
				    	if( a[0] > b[0] ) return 1;
				    	if( a[0] < b[0] ) return -1;
				    	return 0;
				    });

				    this.dt.addRows(rows);
				}
				this._draw();
			},

			_draw : function() {
				// Set chart options
			    var options = {
			        width : $(this.$.chart).width(),
			        height : 400,
			        legend : {
			          	position : 'none'
			        }
			    };

			      // Instantiate and draw our chart, passing in some options.
			    if( !this.chart ) this.chart = new google.visualization.LineChart(this.$.chart);
			    this.chart.draw(this.dt, options);
			},

            _toggleHelp : function() {
                this.showHelp = !this.showHelp;
            },

            goToAttrSettings : function() {
                window.location.hash = 'schema-settings';
            },

            _goToJoin : function() {
                window.location.hash = 'join';
            }
		});
	</script>
<polymer-element>