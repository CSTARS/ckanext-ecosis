<link rel="import" href="esis-ui-card.html" />

<polymer-element name="esis-ui-measurement" attributes="measurement attrTypes">
	<template>
		<style>
			.card {
				margin: 10px 5px;
				padding: 5px;
				border: 1px solid #ccc;
				border-radius: 3px;
			}
			
			h4 {
				margin: 5px;
			}

			table {
                width: 100%;
                border-spacing: 0px;
                border-collapse: separate;
                border-top: 1px solid #ddd;
                border-left: 1px solid #ddd;
                background-color: white;
            }
            table td {
                padding: 10px;
                border-right: 1px solid #ddd;
                border-bottom: 1px solid #ddd;
            }
            table th {
                padding: 10px;
                border-right: 1px solid #ddd;
                border-bottom: 1px solid #ddd;
            }

            paper-icon-button {
                color: #2f9b45;
            }

			.file {
                background-color: #dff0d8;
            }
            .spectra {
                background-color: #fcf8e3;
            }
            .data {
                background-color: #d9edf7;
            }
		</style>

		<div class="card" hidden?="{{hide}}">
			<h4 style="color: #888">From - {{measurement.filename}}</h4>

			<h4>
				<paper-icon-button 
                	icon="hardware:{{showMetadata ? 'keyboard-arrow-down' : 'keyboard-arrow-right'}}" 
                	on-tap="{{_toggleMetadata}}">
            	</paper-icon-button>
				Metadata
			</h4>
			<core-collapse opened="{{showMetadata}}">
				<table>
					<tr>
						<th>Attribute</th>
						<th>Value</th>
						<th>Type</th>
					</tr>
					<tr template repeat="{{item in metadata.file}}">
						<td class="file">
							<esis-attribute-name 
								name="{{item.key}}" 
								esisName="{{ds.metadataDefinitions[item.key]}}"
								mappedName="{{ds.inverseAttributeMap[item.key]}}">
							</esis-attribute-name>
						</td>
						<td class="file">{{item.value}} <span hidden?="{{item.units == ''}}">({{item.units}})</span></td>
						<td class="file">File Metadata</td>
					</tr>
					<tr template repeat="{{item in metadata.joined}}">
						<td>
							<esis-attribute-name 
								name="{{item.key}}" 
								esisName="{{ds.metadataDefinitions[item.key]}}"
								mappedName="{{ds.inverseAttributeMap[item.key]}}">
							</esis-attribute-name>
						</td>
						<td>{{item.value}} <span hidden?="{{item.units == ''}}">({{item.units}})</span></td>
						<td>Joined Metadata</td>
					</tr>
					<tr template repeat="{{item in metadata.measurement}}">
						<td class="spectra">
							<esis-attribute-name 
								name="{{item.key}}" 
								esisName="{{ds.metadataDefinitions[item.key]}}"
								mappedName="{{ds.inverseAttributeMap[item.key]}}">
							</esis-attribute-name>
						</td>
						<td class="spectra">{{item.value}} <span hidden?="{{item.units == ''}}">({{item.units}})</span></td>
						<td class="spectra">Measurement Metadata</td>
					</tr>
				</table>
			</core-collapse>

			<template bind if="{{data.length > 0}}">
				<h4>
					<paper-icon-button 
                		icon="hardware:{{showData ? 'keyboard-arrow-down' : 'keyboard-arrow-right'}}" 
                		on-tap="{{_toggleData}}">
            		</paper-icon-button>
					Data
				</h4>
				<core-collapse opened="{{showData}}">
					<table style="width:100%">
						<tr template repeat="{{p in data}}">
							<td class="data"><b>{{p.key}}</b></td>
							<td class="data">{{p.value}} <span hidden?="{{p.units == ''}}">({{p.units}})</span></td>
						</tr>
					</table>
				</core-collapse>
			</template>

			<h4>Wavelengths: {{wavelengthCount}}</h4>
			<div id="chart" style="height:400px" hidden?="{{wavelengthCount == 0}}"></div>
		</div>
	</template>
	<script>
		Polymer('esis-ui-measurement', {
			measurement : {},

			hide : true,

			metadata : {
				file : [],
				joined : [],
				measurement : []
			},
			data : [],
		
			wavelengthCount : 0,

			ds : null,

			showMetadata : true,
			showData : true,

			dt : null,
			chart : null,

			observe : {
				measurement : '_update',
			},

			ready : function() {
				this.chart = new google.visualization.LineChart(this.$.chart);
				this.ds = document.querySelector('esis-datastore');

				$(window).on('resize', function(){
					this._drawChart();
				}.bind(this));
			},

			_update : function() {
				this.metadata = {
					file : [],
					joined : [],
					measurement : []
				}

				this.data = [];
				this.wavelengthCount = 0;

				if( !this.measurement ) {
					this.hide = true;
					return;
				}
				if( !this.measurement.metadata || !this.measurement.datapoints ) {
					this.hide = true;
					return;
				}

				this.hide = false;

				var attrMap = document.querySelector('esis-datastore').attributeMap;
				var flipMap = {};

				// flip the map;
				//for( var key in attrMap ) {
				//	if( attrMap[key] != '' ) flipMap[attrMap[key]] = key;
				//}

				var key;
				for( key in this.measurement.metadata.file ) {
					this.metadata.file.push({
						key : key, 
						value : this.measurement.metadata.file[key],
						units : this.attrTypes[key] ? this.attrTypes[key].units || '' : ''
					});
				}
				for( key in this.measurement.metadata.joined ) {
					this.metadata.joined.push({
						key : key, 
						value : this.measurement.metadata.joined[key],
						units : this.attrTypes[key] ? this.attrTypes[key].units || '' : ''
					});
				}
				for( key in this.measurement.metadata.measurement ) {
					this.metadata.measurement.push({
						key : key, 
						value : this.measurement.metadata.measurement[key],
						units : this.attrTypes[key] ? this.attrTypes[key].units || '' : ''
					});
				}

				this.dt = new google.visualization.DataTable();
				var rows = [], point;

				this.dt.addColumn('number', 'Wavelength');
				this.dt.addColumn('number', '');

				var re1 = /^-?\d+\.?\d*$/;
                var re2 = /^-?\d*\.\d+$/;

				for( var i = 0; i < this.measurement.datapoints.length; i++ ) {
					point = this.measurement.datapoints[i];

					if( re1.exec(point.key) || re1.exec(point.key) ) {
						rows.push([
				  			parseFloat(point.key),
				  			parseFloat(point.value)
				  		]);
					} else {
						this.data.push({
							key : point.key,
							value : point.value,
							units : this.attrTypes[point.key] ? this.attrTypes[point.key].units || '' : ''
						}); 
					}
				}

				rows.sort(function(a, b){
		       		if( a[0] > b[0] ) return 1;
		       		if( a[0] < b[0] ) return -1;
		       		return 0;
		    	});

				this.wavelengthCount = rows.length;
		      	this.dt.addRows(rows);

		      	setTimeout(function(){
		      		this._drawChart();
		      	}.bind(this), 200);
			},

			_getLabel : function(key, attrMap) {
				if( attrMap[key] ) {
					 return (esis.metadata[attrMap[key]] ? attrMap[key] : '*'+attrMap[key]) + ' (' +
					 		(esis.metadata[key] ? key : '*'+key) + ')';
				}
				return esis.metadata[key] ? key : '*'+key;
			},

			show : function() {
				this._update();
			},

			_drawChart : function() {
				if( !this.dt || !this.chart ) return;

		    	// Set chart options
		    	var options = {
		            width : $(this.$.chart).width(),
		            height : 400,
		            legend : {
		            	position : 'none'
		            },
		            animation:{
				        duration: 1000,
				        easing: 'out'
				    }
		    	};

		    	// Instantiate and draw our chart, passing in some options.
		    	this.chart.draw(this.dt, options);
			},

			_toggleMetadata : function() {
				this.showMetadata = !this.showMetadata;
			},

			_toggleData : function() {
				this.showData = !this.showData;
			}
		});
	</script>
</polymer-element>