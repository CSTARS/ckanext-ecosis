<polymer-element name="esis-current-resources">
	<template>
		<style>
			table {
				width: 100%;
				border-spacing: 0px;
			}
			table th {
				text-align: left;
				border-bottom: 1px solid #ccc;
			}
			table tr:nth-child(even) {
				background-color: #eee;
			}
			table td {
				padding: 5px;
			}
			/*paper-button {
				margin-top: 100px;
				background-color: rgb(210, 63, 49) !important;
				color: white;
			}*/

			.card {
				padding: 10px;
				margin: 10px;
				box-shadow: 0 0 5px #888;
			}
			.card[metadata] {
				box-shadow: 0 0 5px #2196F3;
			}
		</style>

		<div hidden?="{{!loading}}" style="margin-bottom:25px">
			Loading spectral package...<br />
			<span style="font-size:12px;color:#888">Resource Type and Parsed Spectra below will be incomplete till package is loaded.</span>
		</div>

		<template repeat="{{r, i in resourceList}}">
			<div class="card" metadata?="{{r.isSingleSheetMetadata}}">
				<template bind if="{{r.resource.type == 'datafile' || r.resource.type == 'zip'}}">
					<esis-ui-dataresource 
						isSingleSheetMetadata="{{r.isSingleSheetMetadata}}"
						index="{{i}}"
						resource="{{r.resource}}"
						on-remove="{{_deleteResource}}"
						on-datasheet-updated="{{clearMetadata}}">
					</esis-ui-dataresource>
				</template>
				<template bind if="{{r.resource.type != 'datafile' && r.resource.type != 'zip'}}">
					<span>{{r.resource.name}}</span>
					<esis-ui-delete-button index="{{i}}"
		                on-delete="{{_deleteGenericResource}}">
		            </esis-ui-delete-button>
		            <template bind if="{{r.resource.removing}}">
		            	<div>
			            	<span style="color:red">Removing...</span>
	            			<paper-progress indeterminate class="red"></paper-progress>
	            		</div>
		            </template>
				</template>
			</div>	
		</template>

		<template bind if="{{resourceList.length == 0}}">
			<div style="padding: 10px">
				Your dataset does not contain any resource files.  Click the 'Add' tab to upload resources.
			</div>
		</template>
		<template bind if="{{resourceList.length > 0}}">
			<div style="padding: 50px 10px 10px 10px">
				Click the <core-icon icon="create" class="blue"></core-icon> icon to edit or inspect your resources.
			</div>
		</template>

	</template>
	<script>
		Polymer('esis-current-resources',{
			ds : {},
			loader : {},

			loading : false,

			resoucesList : [],

			observe : {
				'ds.deleted' : '_update',
				'ds.existing.dataset' : '_update',
				'ds.existing.resources' : '_update',
				'ds.editMode' : '_updateVisibility',
				'ds.resources' : 'updateResourceList'
			},

			ready : function() {
				this.ds = document.querySelector('esis-datastore');
				this.loader = document.querySelector('esis-dataset-loader');


				if( !this.loader.spectraPackageLoaded ) {
					this.loader.addEventListener('get-spectral-resource-progress', function(e){
						this.loading = true;
					}.bind(this));

					this.loader.addEventListener('get-spectral-resource-complete', function(e){
						this.loading = false;
					}.bind(this));
				}
			},

			updateResourceList : function() {
				this.resourceList = [];
				for( var i = 0; i < this.ds.resources.length; i++ ) {
					var isSingleSheetMetadata = false;

					if( this.ds.resources[i].datasheets.length == 1 && this.ds.resources[i].datasheets[0].metadata ) {
						isSingleSheetMetadata = true;
					}

					this.resourceList.push({
						resource : this.ds.resources[i],
						isSingleSheetMetadata : isSingleSheetMetadata
					});
				}

				this.resourceList.sort(function(a, b){
					if( a.isSingleSheetMetadata && !b.isSingleSheetMetadata) return 1;
					if( !a.isSingleSheetMetadata && b.isSingleSheetMetadata) return -1;
					return 0;
				});
			},

			clearMetadata : function(e) {
				var id = e.detail;
				for( var i = 0; i < this.ds.resources.length; i++ ) {
					if( this.ds.resources[i].id != id ) {
						var ele = this.shadowRoot.querySelector('esis-ui-dataresource[index="'+i+'"]');
						ele.uncacheMetadata(true);
					}
				}
			},

			_update : function() {
				this.async(function(){
					this._updateUI();
				});
			},

			_updateUI : function() {
				this.resources = [];

				for( var i = 0; i < this.ds.existing.resources.length; i++ ) {
					this.resources.push(this._groupData(this.ds.existing.resources[i]));
				}
			},

			_groupData : function(res) {

				var ui = {
					name : res.name,
					id   : res.id,
					type : 'Generic',
					count : 'NA'
				};

				var spCount = this._isData(res.id) 

				if( spCount > -1 ) {
					ui.count = spCount;
					ui.type = 'Spectra';
				} else if( this._isMetdata(res.id) ) {
					ui.type = 'Metadata';
				}

				return ui;
			},

			_isMetdata : function(id) {
				for( var i = 0; i < this.ds.existing.metadata.length; i++ ) {
					if( this.ds.existing.metadata[i].resource_id == id ) return true;
				}
				return false;
			},

			_isData : function(id) {
				for( var i = 0; i < this.ds.existing.data.length; i++ ) {
					if( this.ds.existing.data[i].resource_id == id ) return this.ds.existing.data[i].spectra_count;
				}
				return -1;
			},

			_deleteGenericResource : function(e) {
				var index = parseInt(e.currentTarget.getAttribute('index'));
				var r = this.ds.resources[index];

				if( !confirm("Are you sure you want to remove: "+r.name+"?") ) return;

                r.removing = true;

                document.querySelector('esis-ckan').removeResource(
                    r.id,
                    function(err, resp){
                        r.removing = false;

                        if( err ) return alert("Server error deleting resource");
                        this.ds.resources.splice(index, 1);
                    }.bind(this)
                );
			},

		  	_deleteResource : function(e) {
		  		var id = e.detail;
		  		for( var i = 0; i < this.ds.resources.length; i++ ) {
		  			if( this.ds.resources[i].id == id ) {
		  				this.ds.resources.splice(i, 1);
		  				return;
		  			}
		  		}
		  	},
		});
	</script>
<polymer-element>