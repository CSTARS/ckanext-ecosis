<polymer-element name="esis-ui-dataresource" attributes="resource">
    <template>
        <style>
            :host{
                display:block;
            }
            h4 {
                margin: 0;
                padding: 16px 8px;
            }
            .nav {
                text-align: center;
                background-color: #f8f8f8
            }
            table {
                border: none; 
                width: 100%;
                font-size: 14px;
            }
            table td {
                padding: 3px;
                border-bottom: 1px solid #eee;
            }
            table td.name {
                font-size: 12px;
            }
            table td.name[ignore] {
                color: #888;
                font-style: italic;
            }
            .break {
                margin-top: 40px;
                border-bottom: 1px solid #ccc;
            }
            .toggle-btn {
                margin: 0 0 0 12px;
            }
            .toggle-label {
                display: inline-block;
                padding-top: 12px;
                vertical-align: top;
            }
        </style>

        <paper-button style="float:right" on-tap="{{toggleEdit}}" raised?="{{edit}}">
            <core-icon icon="create" class="blue" hidden?="{{edit}}"></core-icon>
            <core-icon icon="check" class="green" hidden?="{{!edit}}"></core-icon>
        </paper-button>
        <h4>{{resource.name}}
            <template bind if="{{removing}}"><span style="color:red">Removing...</span></template>
            <template bind if="{{loading}}"><span class="blue">Loading...</span></template>
        </h4>


        <template bind if="{{resource.datasheets.length > 1 && edit && !loading}}">
            <div layout horizontal>
                <div flex>
                    <div horizontal layout style="margin: 10px 0 20px 20px" hidden?="{{resource.metadata}}">
                        <paper-checkbox checked="{{resource.ignore}}" style="margin-right:10px"></paper-checkbox>
                        <div>
                            <div>Ignore Entire Resource</div>
                            <div style="color:#888; font-size: 13px">No datasheets in the resourse will be parsed.</div>
                        </div>
                    </div>
                </div>
                <div flex hidden?="{{resource.ignore}}">
                    <paper-button on-tap="{{toggleChangeAll}}">
                        <core-icon icon="hardware:{{showChangeAll ? 'keyboard-arrow-down' : 'keyboard-arrow-right'}}">
                        </core-icon>
                        Change All Layouts
                    </paper-button>
                    <core-collapse opened="{{showChangeAll}}">
                        <paper-button raised on-tap="{{setAllToRow}}" style="margin:10px 0px 10px 50px">Set to Row Layout</paper-button>
                        <paper-button raised on-tap="{{setAllToColumn}}" style="margin:10px 0px 10px 50px">Set to Column Layout</paper-button>
                    </core-collapse>
                </div>
            </div>

            <div class="break" hidden?="{{resource.ignore}}"></div>
        </template>

        <template bind if="{{resource.datasheets.length == 1 && !resource.ignore}}">
            <core-collapse opened="{{!edit}}">
                <table class="table">
                    <tr template repeat="{{file in resource.datasheets}}">
                        <td class="name" ignore?="{{file.ignore}}">
                            <span hidden?="{{!file.ignore}}" class="orange">Ignored</span>
                            <span hidden?="{{!file.metadata || file.ignore}}" class="blue">Metadata</span>
                        </td>
                        <td><span hidden?="{{!file.spectra_count || file.ignore || file.metadata}}">Spectra: {{file.spectra_count}}</span></td>
                        <td><span hidden?="{{file.ignore}}">Layout: {{file.layout}}</span></td>
                    </tr>
                </table>
            </core-collapse>
            <core-collapse opened="{{edit && !loading}}">
                <esis-ui-datasheet datasheet="{{resource.datasheets[0]}}" edit></esis-ui-datasheet>
            </core-collapse>
        </template>

        <template bind if="{{resource.datasheets.length > 1 && !resource.ignore}}">
            <core-collapse opened="{{!edit}}">
                <table class="table">
                    <tr>
                        <td>Name</td>
                        <td>Spectra</td>
                        <td>Format</td>
                    </tr>
                    <tr template repeat="{{file in resource.datasheets}}">
                        <td class="name" ignore?="{{file.ignore}}">
                            {{file.name}}
                            <span hidden?="{{!file.sheet}}">({{file.sheet}})</span>
                            <span hidden?="{{!file.ignore}}" class="orange"> - Ignored</span>
                            <span hidden?="{{!file.metadata || file.ignore}}" class="blue"> - Metadata</span>
                        </td>
                        <td><span hidden?="{{!file.spectra_count || file.ignore || file.metadata}}">{{file.spectra_count}}</span></td>
                        <td><span hidden?="{{file.ignore}}">{{file.layout}}</span></td>
                    </tr>
                </table>
            </core-collapse>

            <core-collapse opened="{{edit && !loading}}"> 
                <div layout horizontal class="nav">
                    <div>
                        <paper-button style="float:right" on-tap="{{back}}">
                            <core-icon icon="arrow-back"></core-icon>
                        </paper-button>
                    </div>
                    <div flex style="text-align:center">
                        <select value="{{datasheetIndex}}" style="margin-top: 15px">
                            <template repeat="{{file,i in resource.datasheets}}">
                                <option value="{{i}}">
                                    {{file.name}}
                                    <span hidden?="{{!file.sheet}}"> {{file.sheet}}</span>
                                </option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <paper-button style="float:right" on-tap="{{forward}}">
                            <core-icon icon="arrow-forward"></core-icon>
                        </paper-button>
                    </div>
                </div>

                <esis-ui-datasheet datasheet="{{currentFile}}" edit showName></esis-ui-datasheet>
            </core-collapse>
        </template>

        <div hidden?="{{!resource.ignore || edit}}">
            <span style="font-style:italic;color:#888">Ignored</span>
        </div>

        <paper-button 
            raised 
            class="red-button" 
            hidden?="{{!edit}}" 
            style="margin-top:30px"
            on-tap="{{remove}}">
            Remove {{resource.name}}</paper-button>

    </template>
    <script>
        Polymer('esis-ui-dataresource',{
            edit : false,

            // is this the summary resource or full resource
            full : false,
            ds : null,

            showChangeAll : false,

            datasheetIndex : 0,
            currentFile : null,
            observe : {
                datasheetIndex : 'updateSelected',
                edit : 'load'
            },

            editMd5 : '',
            saving : false,

            ready : function() {
                this.ds = document.querySelector('esis-datastore');
            },

            toggleEdit : function() {
                this.edit = !this.edit;

                if( this.edit ) {
                    this.editMd5 = md5(JSON.stringify(this.resource));
                } else {
                    var cmd5 = md5(JSON.stringify(this.resource));
                    if( cmd5 != this.editMd5 ) {
                        this.save();
                    }
                }
            },

            updateSelected : function() {
                var index = parseInt(this.datasheetIndex);
                this.currentFile = this.resource.datasheets[index];
            },

            back : function() {
                this.datasheetIndex = parseInt(this.datasheetIndex) - 1;
                this.currentFile = this.resource.datasheets[this.datasheetIndex];
            },

            forward : function() {
                this.datasheetIndex = parseInt(this.datasheetIndex) + 1;
                this.currentFile = this.resource.datasheets[this.datasheetIndex];
            },

            toggleChangeAll : function() {
                this.showChangeAll = !this.showChangeAll;
            },

            setAllToRow : function() {
                for( var i = 0; i < this.resource.datasheets.length; i++ ) {
                    this.resource.datasheets[i].layout = 'row'
                }
                this.showChangeAll = false;
            },

            setAllToColumn : function() {
                for( var i = 0; i < this.resource.datasheets.length; i++ ) {
                    this.resource.datasheets[i].layout = 'column'
                }
                this.showChangeAll = false;
            },

            remove : function() {
                if( !confirm("Are you sure you want to remove: "+this.resource.name+"?") ) return;

                this.removing = true;

                document.querySelector('esis-ckan').removeResource(
                    this.resource.id,
                    function(err, resp){
                        this.remove = false;

                        if( err ) return alert("Server error deleting resource");
                        this.fire('remove', this.resource.id);
                    }.bind(this)
                );
            },

            save : function() {
                var datasheets = [];
                for( var i = 0; i < this.resource.datasheets; i++ ) {
                    var sheet = this.resource.datasheets[i];
                    var info = { layout : sheet.layout };

                    if( sheet.metadata ) {
                        info.metadata = true;

                    }
                }
            },

            load : function() {
                if( !this.edit || this.full ) return;

                this.loading = true;

                document.querySelector('esis-ckan').processResource(
                    this.ds.package_id,
                    this.resource.id,
                    function(err, resp){
                        if( err ) return alert("Server error fetching resource");

                        for( var key in resp ) {
                            this.resource[key] = resp[key];
                        }

                        this.updateSelected()

                        this.full = true;

                        this.loading = false;
                    }.bind(this)
                );
            }

        })
    </script>
</polymer-element>