<polymer-element name="esis-ui-dataresource" attributes="resource isSingleSheetMetadata">
    <template>
        <style>
            :host{
                display:block;
            }
            h4 {
                margin: 0;
                padding: 16px 8px;
            }
            h4 span {
                display: inline-block;
                vertical-align: top;
                padding-top: 2px;
            }
            .nav {
                text-align: center;
                background-color: #f8f8f8
            }
            table {
                border: none; 
                width: 100%;
                font-size: 14px;
            }
            table td {
                padding: 3px;
                border-bottom: 1px solid #eee;
            }
            table td.name {
                font-size: 12px;
            }
            table td.name[ignore] {
                color: #888;
                font-style: italic;
            }
            .break {
                margin-top: 40px;
                border-bottom: 1px solid #ccc;
            }
            .toggle-btn {
                margin: 0 0 0 12px;
            }
            .toggle-label {
                display: inline-block;
                padding-top: 12px;
                vertical-align: top;
            }
            .menu .item {
                padding: 10px;
            }
            paper-progress {
                width: 100%
            }
            esis-ui-delete-button /deep/ paper-icon-button {
                padding: 0 8px !important;
            }
            .metadata-label {
                font-size: 80%;
                padding: 3px;
                margin: 3px;
                color: white;
                background-color: #2196F3;
                border-radius: 3px;
            }
        </style>

        <paper-button style="float:right" on-tap="{{toggleEdit}}" raised?="{{edit}}">
            <core-icon icon="create" class="blue" hidden?="{{edit}}"></core-icon>
            <core-icon icon="check" class="green" hidden?="{{!edit}}"></core-icon>
        </paper-button>
        <h4>
            <span>
                {{resource.name}}
                <span hidden?="{{!isSingleSheetMetadata}}" class="metadata-label">Metadata</span>
            </span>
            <paper-icon-button
                icon="more-vert" 
                style="padding: 0 8px"
                on-tap="{{toggleResourceMenu}}"
                hidden?="{{!edit || loading || (resource.datasheets.length < 2 && !resource.ignore)}}">
            </paper-icon-button>
            <esis-ui-delete-button 
                hidden?="{{!edit}}" 
                on-delete="{{remove}}">
            </esis-ui-delete-button>
        </h4>

        <template bind if="{{loading || saving}}">
            <span class="green" hidden?="{{saving}}">Loading...</span>
            <span class="green" hidden?="{{loading}}">Updating...</span>
            <paper-progress indeterminate></paper-progress>
        </template>

        <template bind if="{{removing}}">
            <span style="color:red">Removing...</span>
            <paper-progress indeterminate class="red"></paper-progress>
        </template>

        <!-- RESOURCE POPUP MENU -->
        <paper-dropdown id="resourceMenu">
            <div class="menu">
                <div>
                    <paper-icon-button icon="close" on-tap="{{toggleResourceMenu}}" style="float:right"><paper-icon-button>
                </div>
                <div class="item">
                    <div horizontal layout style="margin: 10px 0 20px 20px" hidden?="{{resource.metadata}}">
                        <paper-checkbox checked="{{resource.ignore}}" style="margin-right:10px" on-tap="{{updateIgnore}}"></paper-checkbox>
                        <div>
                            <div>Ignore Entire Resource</div>
                            <div style="color:#888; font-size: 13px">No datasheets in the resourse will be parsed.</div>
                        </div>
                    </div>
                </div>
                <div hidden?="{{resource.ignore}}" class="item">
                    <div style="margin-left:20px">Change All Layouts</div>
                    <paper-button raised on-tap="{{setAllToRow}}" style="margin:10px 0px 10px 50px">Set to Row Layout</paper-button>
                    <paper-button raised on-tap="{{setAllToColumn}}" style="margin:10px 0px 10px 50px">Set to Column Layout</paper-button>
                </div>
            </div>
        </paper-dropdown>

        <div style="padding:5px; color: #888" hidden?="{{edit || resource.datasheets.length == 0}}">
            <a class="green" style="cursor:pointer" on-click="{{toggleDetails}}">Details</a>
            <span hidden?="{{resource.datasheets.length < 2}}" style="float:right;margin-left:10px">Datasheets: <b>{{resource.datasheets.length}}</b></span>
            <span hidden?="{{totalSpectra == 0}}" style="float:right">Spectra: <b>{{totalSpectra}}</b></span>
        </div>

        <!-- DATASHEET, SINGLE SHEET -->
        <template bind if="{{resource.datasheets.length == 1 && !resource.ignore}}">
            <!-- NOT EDITING -->
            <core-collapse opened="{{details}}">
                <table class="table">
                    <tr template repeat="{{file in resource.datasheets}}">
                        <td class="name" ignore?="{{file.ignore}}">
                            <span hidden?="{{!file.ignore}}" class="orange">Ignored</span>
                            <span hidden?="{{!file.metadata || file.ignore}}" class="blue">Metadata</span>
                            <span hidden?="{{!file.error}}" style="color:red">
                                Error parsing file
                            </span>
                        </td>
                        <td><span hidden?="{{!file.spectra_count || file.ignore || file.metadata}}">Spectra: {{file.spectra_count}}</span></td>
                        <td><span hidden?="{{file.ignore}}">Layout: {{file.layout}}</span></td>
                    </tr>
                </table>
            </core-collapse>

            <!-- EDITING -->
            <core-collapse opened="{{edit && !loading}}">
                <esis-ui-datasheet 
                    datasheet="{{resource.datasheets[0]}}" 
                    resourceId="{{resource.id}}" 
                    edit
                    on-update="{{onDatasheetUpdate}}"></esis-ui-datasheet>
            </core-collapse>
        </template>

        <!-- LIST OF DATASHEETS (multiple) -->
        <template bind if="{{resource.datasheets.length > 1 && !resource.ignore}}">
            <!-- NOT EDITING -->
            <core-collapse opened="{{details}}">
                <table class="table">
                    <tr>
                        <td style="font-weight:bold">Name</td>
                        <td style="font-weight:bold">Spectra</td>
                        <td style="font-weight:bold">Format</td>
                    </tr>
                    <tr template repeat="{{datasheet in resource.datasheets}}">
                        <td class="name" ignore?="{{datasheet.ignore}}">
                            {{datasheet.name}}
                            <span hidden?="{{!datasheet.sheetname}}">({{datasheet.sheetname}})</span>
                            <span hidden?="{{!datasheet.ignore}}" class="orange"> - Ignored</span>
                            <span hidden?="{{!datasheet.metadata || datasheet.ignore}}" class="blue"> - Metadata</span>
                            <span hidden?="{{!datasheet.error}}" style="color:red">
                                Error parsing file
                            </span>
                        </td>
                        <td style="color:#888">
                            <span hidden?="{{!datasheet.spectra_count || datasheet.ignore || datasheet.metadata}}">{{datasheet.spectra_count}}</span>
                        </td>
                        <td style="color:#888"><span hidden?="{{datasheet.ignore}}">{{datasheet.layout}}</span></td>
                    </tr>
                </table>
            </core-collapse>


            <!-- EDITING -->
            <core-collapse opened="{{edit && !loading}}"> 
                <div layout horizontal class="nav">
                    <div>
                        <paper-button style="float:right" on-tap="{{back}}">
                            <core-icon icon="arrow-back"></core-icon>
                        </paper-button>
                    </div>
                    <div flex style="text-align:center">
                        <select value="{{datasheetIndex}}" style="margin-top: 15px" on-change="{{onSelect}}">
                            <template repeat="{{file,i in resource.datasheets}}">
                                <option value="{{i}}">
                                    {{file.name}} {{file.sheetname}}
                                </option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <paper-button style="float:right" on-tap="{{forward}}">
                            <core-icon icon="arrow-forward"></core-icon>
                        </paper-button>
                    </div>
                </div>

                <esis-ui-datasheet 
                    datasheet="{{currentFile}}" 
                    resourceId="{{resource.id}}" 
                    edit 
                    showName
                    on-update="{{onDatasheetUpdate}}"></esis-ui-datasheet>
            </core-collapse>
        </template>

        <div hidden?="{{!resource.ignore}}">
            <span style="font-style:italic;color:#888">Ignored</span>
        </div>

    </template>
    <script>
        Polymer('esis-ui-dataresource',{
            edit : false,
            details : false,

            // is this the summary resource or full resource
            full : false,
            ds : null,

            totalSpectra : 0,

            datasheetIndex : 0,
            currentFile : null,
            observe : {
                edit : 'updateSelected',
                'resource' : 'updateCount'
            },

            editMd5 : '',
            saving : false,

            ready : function() {
                this.ds = document.querySelector('esis-datastore');
            },

            toggleEdit : function() {
                this.edit = !this.edit;
                if( this.edit ) this.details = false;
            },

            toggleDetails : function() {
                this.details = !this.details;
                if( this.details ) this.edit = false;
            },

            toggleResourceMenu : function() {
                this.$.resourceMenu.discoverDimensions();
                this.$.resourceMenu.resizeHandler();
                this.$.resourceMenu.toggle();
            },

            updateCount : function() {
                this.totalSpectra = 0;
                if( !this.resource.datasheets ) return;

                for( var i = 0; i < this.resource.datasheets.length; i++ ) {
                    if( this.resource.datasheets[i].metadata ) continue;
                    this.totalSpectra += this.resource.datasheets[i].spectra_count;
                } 
            },

            updateSelected : function(forceReload) {
                var index = parseInt(this.datasheetIndex);

                if( !this.resource.datasheets ) return;
                if( this.resource.datasheets.length <= index ) return;

                if( this.resource.datasheets[index].loaded && !forceReload) {
                    this.currentFile = this.resource.datasheets[index];
                } else {
                    this.load(this.resource.datasheets[index], function(){
                        this.currentFile = this.resource.datasheets[index];
                    }.bind(this));
                }                
            },

            onDatasheetUpdate : function() {
                this.uncacheMetadata();
                this.fire('datasheet-updated', this.resource.id);
            },

            /* any cached metadata file should be cleared out */
            uncacheMetadata : function(closeEdit) {
                if( closeEdit ) this.edit = false;

                for( var i = 0; i < this.resource.datasheets.length; i++ ) {
                    if( this.resource.datasheets[i].metadata ) {
                        this.resource.datasheets[i].loaded = false;
                    }
                }
            },

            back : function() {
                this.datasheetIndex = parseInt(this.datasheetIndex) - 1;
                if( this.datasheetIndex < 0 ) {
                    this.datasheetIndex = 0;
                    return;
                }
                this.updateSelected();
            },

            forward : function() {
                this.datasheetIndex = parseInt(this.datasheetIndex) + 1;
                if( this.datasheetIndex >= this.resource.datasheets.length ) {
                    this.datasheetIndex = this.resource.datasheets.length-1;
                    return;
                }
                this.updateSelected();
            },

            onSelect : function() {
                this.datasheetIndex = parseInt(this.datasheetIndex);
                this.updateSelected();
            },

            setAllToRow : function() {
                this.updateAllLayout('row');
            },

            setAllToColumn : function() {
                this.updateAllLayout('column');
            },

            updateAllLayout : function(layout) {
                this.saving = true;
                this.toggleResourceMenu();

                var arr = [];
                for( var i = 0; i < this.resource.datasheets.length; i++ ) {
                    arr.push({
                        id : this.resource.datasheets[i].id,
                        layout : layout
                    });
                }

                var resource = {
                    id : this.resource.id,
                    datasheets : arr
                };

                document.querySelector('esis-ckan').setParseInfo(
                    this.ds.package_id, 
                    resource,
                    function(err, resp){
                        this.saving = false;
                        if( err ) alert("Error updating datasheet :(");

                        for( var i = 0; i < resp.resources.length; i++ ) {
                            if( resp.resources[i].id != this.resource.id ) continue;
                            var r = resp.resources[i];

                            for( var key in r ) {
                                this.resource[key] = r[key];
                            }
                            break;
                        }
                        
                        this.updateSelected(true);
                    }.bind(this)
                ); 
            },

            remove : function() {
                if( !confirm("Are you sure you want to remove: "+this.resource.name+"?") ) return;

                this.removing = true;

                document.querySelector('esis-ckan').removeResource(
                    this.resource.id,
                    function(err, resp){
                        this.removing = false;

                        if( err ) return alert("Server error deleting resource");
                        this.fire('remove', this.resource.id);
                    }.bind(this)
                );
            },

            updateIgnore : function() {
                this.saving = true;
                this.toggleResourceMenu();


                var resource = {
                    id : this.resource.id,
                    ignore : this.resource.ignore,
                };

                document.querySelector('esis-ckan').setParseInfo(
                    this.ds.package_id, 
                    resource,
                    function(err, resp){
                        this.saving = false;
                        if( err ) alert("Error updating datasheet :(");

                        for( var i = 0; i < resp.resources.length; i++ ) {
                            if( resp.resources[i].id != this.resource.id ) continue;
                            var r = resp.resources[i];

                            for( var key in r ) {
                                this.resource[key] = r[key];
                            }
                            break;
                        } 
                    }.bind(this)
                ); 
            },

            save : function() {
                var datasheets = [];
                for( var i = 0; i < this.resource.datasheets; i++ ) {
                    var sheet = this.resource.datasheets[i];
                    var info = { layout : sheet.layout };

                    if( sheet.metadata ) {
                        info.metadata = true;

                    }
                }
            },

            load : function(sheet, callback) {
                if( !this.edit ) return;

                this.loading = true;

                document.querySelector('esis-ckan').getDatasheet(
                    this.ds.package_id,
                    this.resource.id,
                    sheet.id,
                    function(err, resp){
                        if( err ) return alert("Server error fetching datasheet");

                        for( var key in resp ) {
                            sheet[key] = resp[key];
                        }
                        sheet.loaded = true;
                        this.loading = false;
                        if( callback ) callback();
                    }.bind(this)
                );
            }

        })
    </script>
</polymer-element>