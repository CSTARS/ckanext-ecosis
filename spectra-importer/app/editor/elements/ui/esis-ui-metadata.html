<link rel="import" href="esis-ui-card.html"/>
<link rel="import" href="../../components/paper-checkbox/paper-checkbox.html" />

<polymer-element name="esis-ui-metadata" attributes="metadata attributeTypes">
	<template>
		<style>
			:host {
				display: block;
				margin-top: 5px;
				background-color: white;
			}
			.resource-type {
				border-bottom: 1px solid #2f9b45;
				color: #2f9b45;
				margin-top: 8px;
				padding-bottom: 3px;
			}
		</style>

		<esis-ui-card z="1" style="padding: 1px 20px 10px 20px">
			<h4>
				<!-- TODO: move this to the datasheet UI 
				<div hidden?="{{metadata.isExisting}}" class="resource-type">New Resource</div>
				<div hidden?="{{!metadata.isExisting}}" class="resource-type">Existing Resource</div>
				-->

				{{label}}
				<template bind if="{{metadata.file.sheetName.length > 0}}">
					- {{metadata.file.sheetName}}
				</template>
			</h4>

			<div>
				Join On:
				<select id="joinId" value="{{metadata.joinId}}">
					<option value=""></option>
					<template repeat="{{attr in joinAttrs}}" >
						<option value="{{attr}}">{{attr}}</option>
					</template>
				</select>

				<div horizontal layout style="margin: 30px 15px">
				    <paper-checkbox id="filenameMatch" on-tap="{{_onFilenameMatch}}"></paper-checkbox>
				    <div style="padding-left: 20px">
				     	Match on Filename
				    </div>
				</div>
				<div horizontal layout style="margin: 30px 45px" hidden?="{{!metadata.filenameMatch}}" >
				    <paper-checkbox id="looseMatch" on-tap="{{_onLooseMatch}}0" checked></paper-checkbox>
				    <div style="padding-left: 20px">
				     	<div>Exact match</div>
				     	<div style="font-size:12px;color:#888">
				     		If checked, the attribute value must match the filename exactly.  Otherwise, the filename just needs to contain the attribute value to match.
				     	</div>
				    </div>
				</div>


				<div horizontal layout style="margin: 30px 15px" hidden?="{{metadata.file.sheetName == ''}}" >
				    <paper-checkbox id="worksheetMatch" on-tap="{{_onWorksheetMatch}}"></paper-checkbox>
				    <div style="padding-left: 20px">
				     	Match on Worksheet Name
				    </div>
				</div>

				<template bind if="{{metadata.matchCount != null}}">
					<div>Matched to {{metadata.matchCount}} measurements</div>
				</template>

			</div> 
		</esis-ui-card>
	</template>
	<script>
		Polymer('esis-ui-metadata', {
			metadata : {},
			joinAttrs : [],
			label : '',

			observe : {
				'metadata.joinId' : '_updateDatastore',
			},

			update : function() {
				if( this.metadata == null ) return;

				this.joinAttrs = [];

				for( var key in this.attributeTypes ) {
					this.joinAttrs.push(key);
				}

				if( this.metadata.file && this.metadata.file.info ) {
					this.label = this.metadata.file.info.name.replace(/.*\//,'');
				} else {
					this.label = this.metadata.filename;
				}

				this.async(function(){
					this.$.joinId.value = this.metadata.joinId;
				});
			},

			_updateDatastore : function() {
				if( this.metadata.joinId == '' ) return;
				document.querySelector('esis-datastore').join(this.metadata);
			},

			_onWorksheetMatch : function() {
				this.async(function(){
					this.metadata.filenameMatch = false;
					this.$.filenameMatch.removeAttribute('checked');
					this.metadata.worksheetMatch = this.$.worksheetMatch.checked;
					this._updateDatastore();
				});
			},

			_onFilenameMatch : function() {
				this.async(function(){
					this.metadata.worksheetMatch = false;
					this.$.worksheetMatch.removeAttribute('checked');
					this.metadata.filenameMatch = this.$.filenameMatch.checked;
					this._updateDatastore();
				});	
			},

			_onLooseMatch : function() {
				this.async(function(){
					this.metadata.looseMatch = !this.$.looseMatch.checked;
					this._updateDatastore();
				});	
			}

		});
	</script>
</polymer-element>