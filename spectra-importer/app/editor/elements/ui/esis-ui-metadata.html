<link rel="import" href="esis-ui-card.html"/>
<link rel="import" href="../../components/paper-checkbox/paper-checkbox.html" />

<polymer-element name="esis-ui-metadata" attributes="resourceId metadata">
	<template>
		<style>
			:host {
				display: block;
				margin: 25px 0 0 20px;
				background-color: white;
			}
			.resource-type {
				border-bottom: 1px solid #2f9b45;
				color: #2f9b45;
				margin-top: 8px;
				padding-bottom: 3px;
			}
		</style>


		<div>
			Join On:
			<select id="joinId" value="{{metadata.matchAttribute}}">
				<option value=""></option>
				<template repeat="{{attr in joinAttrs}}" >
					<option value="{{attr}}">{{attr}}</option>
				</template>
			</select>

			<div horizontal layout style="margin: 30px 15px">
			    <paper-checkbox id="filenameMatch" on-tap="{{_onFilenameMatch}}"></paper-checkbox>
			    <div style="padding-left: 20px">
			     	Match on Filename
			    </div>
			</div>
			<div horizontal layout style="margin: 30px 45px" hidden?="{{metadata.matchType != 'filename'}}" >
			    <paper-checkbox id="looseMatch" on-tap="{{_onLooseMatch}}" ></paper-checkbox>
			    <div style="padding-left: 20px">
			     	<div>Exact match</div>
			     	<div style="font-size:12px;color:#888">
			     		If checked, the attribute value must match the filename exactly.  Otherwise, the filename just needs to contain the attribute value to match.
			     	</div>
			    </div>
			</div>


			<div horizontal layout style="margin: 30px 15px" hidden?="{{metadata.sheetname == ''}}" >
			    <paper-checkbox id="worksheetMatch" on-tap="{{_onWorksheetMatch}}"></paper-checkbox>
			    <div style="padding-left: 20px">
			     	Match on Worksheet Name
			    </div>
			</div>

			<template bind if="{{matchCount != -1}}">
				<div hidden?="{{!loadingMatchCount}}">Joining...</div>
				<div hidden?="{{loadingMatchCount}}" class="{{matchCount > 0 ? 'green' :''}}">Matched to {{matchCount}} measurements</div>
			</template>

		</div> 

	</template>
	<script>
		Polymer('esis-ui-metadata', {
			metadata : {},
			joinAttrs : [],
			label : '',

			matchCount : -1,
			loadingMatchCount : false,
			updateTimer : -1,


			observe : {
				metadata : 'update'
			},

			update : function() {
				if( this.metadata == null ) return;

				this.joinAttrs = [];

				for( var i = 0; i < this.metadata.attributes.length; i++ ) {
					var attr = this.metadata.attributes[i];
					if( attr.type == 'metadata' ) this.joinAttrs.push(attr.name);
				}

				this.joinAttrs.sort(function(a, b){
					if( a < b ) return 1;
					if( b < a ) return -1;
					return 0;
				});

				this.label = this.metadata.name;

				this.async(function(){
					this.$.joinId.value = this.metadata.matchAttribute || '';

					if( this.metadata.matchType == 'filename' ) {
						this.$.filenameMatch.setAttribute('checked','checked');
						this.$.worksheetMatch.removeAttribute('checked');
					} else if ( this.metadata.matchType == 'sheetname' ) {
						this.$.worksheetMatch.setAttribute('checked','checked');
						this.$.filenameMatch.removeAttribute('checked');
					} else {
						this.$.worksheetMatch.removeAttribute('checked');
						this.$.filenameMatch.removeAttribute('checked');
					}

					if( this.metadata.looseMatch ) {
						this.$.looseMatch.setAttribute('checked','checked');
					} else {
						this.$.looseMatch.removeAttribute('checked');
					}

					this._updateCounts();
				});
			},

			_onWorksheetMatch : function() {
				this.async(function(){
					this.$.filenameMatch.removeAttribute('checked');

					if( this.$.worksheetMatch.checked ) {
						this.metadata.matchType = 'sheetname';
					} else {
						this.metadata.matchType = 'attribute';
					}

					this._updateServer();
				});
			},

			_onFilenameMatch : function() {
				this.async(function(){
					this.$.worksheetMatch.removeAttribute('checked');

					if( this.$.filenameMatch.checked ) {
						this.metadata.matchType = 'filename';
						this.metadata.looseMatch = this.$.looseMatch.checked;
					} else {
						this.metadata.matchType = 'attribute';
					}

					this._updateServer();
				});	
			},

			_onLooseMatch : function() {
				this.async(function(){
					this.metadata.looseMatch = !this.$.looseMatch.checked;

					this._updateServer();
				});	
			},

			_updateServer : function() {
				this.loadingMatchCount = true;
				this.matchCount = 0;

				if( this.updateTimer != -1 ) clearTimeout(this.updateTimer);
				this.updateTimer = setTimeout(function(){
					this.updateTimer = -1;
					this._join();
				}.bind(this), 1000);
			},

			_join : function() {

				var matchType = this.metadata.matchType;
				if( !matchType || matchType == '' ) matchType = 'attribute';

				document.querySelector('esis-ckan').updateJoin(
					document.querySelector('esis-datastore').package_id,
					this.resourceId,
					{
						id : this.metadata.id,
						layout : 'row',
						matchAttribute : this.metadata.matchAttribute,
						matchType : matchType,
						metadata : true,
						looseMatch : this.metadata.looseMatch ? true : false
					},
					function(err, resp){
						this.loadingMatchCount = false;
						if( err ) alert('Error updating join information :(');
						console.log(resp);
						for( var key in resp ) {
							this.metadata[key] = resp[key];
						}
						this._updateCounts();
					}.bind(this)
				);
			},

			_updateCounts : function() {
				if( !this.metadata.matches ) {
					this.matchCount = -1;
					return;
				}

				this.matchCount = 0;
				for( var key in this.metadata.matches ) {
					this.matchCount += this.metadata.matches[key]
				}
			}

		});
	</script>
</polymer-element>