<link rel="import" href="esis-ui-card.html"/>
<link rel="import" href="../../components/paper-checkbox/paper-checkbox.html" />

<polymer-element name="esis-ui-metadata" attributes="metadata">
	<template>
		<style>
			:host {
				display: block;
				margin: 25px 0 0 20px;
				background-color: white;
			}
			.resource-type {
				border-bottom: 1px solid #2f9b45;
				color: #2f9b45;
				margin-top: 8px;
				padding-bottom: 3px;
			}
		</style>


		<div>
			Join On:
			<select id="joinId" value="{{metadata.matchAttribute}}">
				<option value=""></option>
				<template repeat="{{attr in joinAttrs}}" >
					<option value="{{attr}}">{{attr}}</option>
				</template>
			</select>

			<div horizontal layout style="margin: 30px 15px">
			    <paper-checkbox id="filenameMatch" on-tap="{{_onFilenameMatch}}"></paper-checkbox>
			    <div style="padding-left: 20px">
			     	Match on Filename
			    </div>
			</div>
			<div horizontal layout style="margin: 30px 45px" hidden?="{{metadata.matchType != 'filename'}}" >
			    <paper-checkbox id="looseMatch" on-tap="{{_onLooseMatch}}0" checked></paper-checkbox>
			    <div style="padding-left: 20px">
			     	<div>Exact match</div>
			     	<div style="font-size:12px;color:#888">
			     		If checked, the attribute value must match the filename exactly.  Otherwise, the filename just needs to contain the attribute value to match.
			     	</div>
			    </div>
			</div>


			<div horizontal layout style="margin: 30px 15px" hidden?="{{metadata.sheetname == ''}}" >
			    <paper-checkbox id="worksheetMatch" on-tap="{{_onWorksheetMatch}}"></paper-checkbox>
			    <div style="padding-left: 20px">
			     	Match on Worksheet Name
			    </div>
			</div>

			<template bind if="{{metadata.matchCount != null}}">
				<div>Matched to {{metadata.matchCount}} measurements</div>
			</template>

		</div> 

	</template>
	<script>
		Polymer('esis-ui-metadata', {
			metadata : {},
			joinAttrs : [],
			label : '',

			//observe : {
			//	'metadata.joinId' : '_updateDatastore',
			//},
			observe : {
				metadata : 'update'
			},

			update : function() {
				if( this.metadata == null ) return;

				this.joinAttrs = [];

				for( var i = 0; i < this.metadata.attributes.length; i++ ) {
					var attr = this.metadata.attributes[i];
					if( attr.type == 'metadata' ) this.joinAttrs.push(attr.name);
				}

				this.joinAttrs.sort(function(a, b){
					if( a < b ) return 1;
					if( b < a ) return -1;
					return 0;
				});

				this.label = this.metadata.name;

				this.async(function(){
					this.$.joinId.value = this.metadata.matchAttribute || '';
				});
			},

			_updateDatastore : function() {
				if( this.metadata.joinId == '' ) return;
				document.querySelector('esis-datastore').join(this.metadata);
			},

			_onWorksheetMatch : function() {
				this.async(function(){
					this.$.filenameMatch.removeAttribute('checked');
					this.metadata.matchType = 'sheetname';
					this._updateDatastore();
				});
			},

			_onFilenameMatch : function() {
				this.async(function(){
					this.$.worksheetMatch.removeAttribute('checked');
					this.metadata.matchType = 'filename'
					this._updateDatastore();
				});	
			},

			_onLooseMatch : function() {
				this.async(function(){
					this.metadata.looseMatch = !this.$.looseMatch.checked;
					this._updateDatastore();
				});	
			}

		});
	</script>
</polymer-element>