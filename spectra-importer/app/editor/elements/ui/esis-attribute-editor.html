<link rel="import" href="../../components/core-collapse/core-collapse.html" >
<link rel="import" href="../../components/paper-icon-button/paper-icon-button.html" >
<link rel="import" href="../../components/core-icons/hardware-icons.html" >

<polymer-element name="esis-attribute-editor" attributes="attributeTypes">
    <template>
        <style>
            span[modified] {
                font-weight: bold;
            }
            table {
                width: 100%;
                border-spacing: 0px;
                border-collapse: separate;
                border-top: 1px solid #ddd;
                border-left: 1px solid #ddd;
                background-color: white;
            }
            table td {
                padding: 10px;
                border-right: 1px solid #ddd;
                border-bottom: 1px solid #ddd;
            }
            table th {
                padding: 10px;
                border-right: 1px solid #ddd;
                border-bottom: 1px solid #ddd;
            }
            h4 {
                margin-bottom: 5px;
                border-bottom: 1px solid #eee;
            }

            .file {
                background-color: #dff0d8;
            }
            .metadata {
                background-color: #fcf8e3;
            }
            .data {
                background-color: #d9edf7;
            }

            .helper {
                font-size: 12px;
                color: #888;
                margin-bottom: 5px;
            }
            .type-flag {
                font-size: 80%;
                vertical-align: top;
                line-height: 1;
                color: #aaa;
            }
            paper-icon-button {
                color: #2f9b45;
            }
            core-collapse {
                margin-bottom: 30px;
            }
            paper-input {
                width: 100px;
                height: 40px;
            }
            paper-progress {
                width: 125px;
            }
        </style>

        <h4>
            <paper-icon-button 
                icon="hardware:{{showEditable ? 'keyboard-arrow-down' : 'keyboard-arrow-right'}}" 
                on-tap="{{_toggleEditable}}">
            </paper-icon-button>
            <span>Configurable Attributes: {{editableArray.length}}</span>
        </h4>
        <div class="helper">
            These attribute types have been infered and can be modified below
        </div>

        <core-collapse opened="{{showEditable}}">
            <div style="max-height:400px">
                <core-list id="editList" data="{{editableArray}}" height="60" style="height:400px" >
                    <template>
                        <!--<span modified?="{{modifications[info.name] != null}}">-->
                        <table style="height:60px">
                            <tr>
                                <td class="{{model.class}}" style="width:50%">
                                    <span>
                                        <esis-attribute-name name="{{model.name}}" mappedName="{{ds.inverseAttributeMap[model.name]}}" enforceSize="true"></esis-attribute-name>
                                    </span>
                                    <div class="saving" hidden?="{{!model.saving}}">Saving...</div>
                                </td><td class="{{model.class}}" style="width:25%">
                                    <paper-input 
                                        type="text" 
                                        value="{{model.units}}" 
                                        array="editable" 
                                        index="{{index}}" 
                                        on-change="{{onAttributeChange}}"
                                        style="width:125px">
                                    </paper-input>
                                </td><td class="{{model.class}}" style="width:25%">
                                    <select index="{{index}}" value="{{model.type}}" array="editable" on-change="{{onAttributeChange}}">
                                            <option value="data" selected?="{{model.type == 'data'}}">Data</option>
                                            <option value="metadata" selected?="{{model.type == 'metadata'}}">Metadata</option>
                                    </select>
                                </td>
                            </tr>
                        </div>
                    </template>
                </core-list>
            </div>
        </core-collapse>

        <h4>
            <paper-icon-button 
                icon="hardware:{{showFixed ? 'keyboard-arrow-down' : 'keyboard-arrow-right'}}" 
                on-tap="{{_toggleFixed}}">
            </paper-icon-button>
            Fixed Attributes: {{fixedArray.length}}
        </h4>
        <div class="helper">
            These attribute types have been implied by their import format.
        </div> 
        <core-collapse opened="{{showFixed}}">
            <div style="max-height:400px">
                <core-list id="fixedList" data="{{fixedArray}}" height="60" style="height:400px" >
                    <template>
                        <!--<span modified?="{{modifications[info.name] != null}}">-->
                        <table style="height:60px">
                            <tr>
                                <td class="{{model.class}}" style="width:50%">
                                    <span>
                                        <esis-attribute-name name="{{model.name}}" mappedName="{{ds.inverseAttributeMap[model.name]}}" enforceSize="true"></esis-attribute-name>
                                    </span>
                                    <div class="saving" hidden?="{{!model.saving}}">Saving...</div>
                                </td><td class="{{model.class}}" style="width:25%">
                                    <paper-input 
                                        type="text" 
                                        value="{{model.units}}" 
                                        array="fixed" 
                                        index="{{index}}" 
                                        on-change="{{onAttributeChange}}"
                                        style="width:125px">
                                    </paper-input>
                                </td><td class="{{model.class}}" style="width:25%">
                                    {{model.type}}<span class="type-flag">{{model.flag}}</span>
                                </td>
                            </tr>
                        </div>
                    </template>
                </core-list>
            </div>

            <div style="padding:10px;font-size:12px">
                <div>
                    <span class="type-flag">1</span> Attribute is from a joinable metadata file and is therefore metadata.
                </div>
                <div>
                    <span class="type-flag">4</span> Attribute is from the global metadata section of a file.
                </div>
                <div>
                    <span class="type-flag">5</span> Attribute is declared as data with the __d postfix.
                </div>
            </div>
        </core-collapse>

        <h4>
            <paper-icon-button
                icon="hardware:{{showWavelengths ? 'keyboard-arrow-down' : 'keyboard-arrow-right'}}" 
                on-tap="{{_toggleWavelengths}}">
            </paper-icon-button>
            Wavelengths: {{ds.wavelengths.length}}
        </h4>
        <div class="helper">
            These attribute types have been implied because the attribute name is numberic.
        </div>
        <core-collapse opened="{{showWavelengths}}">
            <div class="helper" id="wavelengths"></div>
        </core-collapse>


    </template>
    <script>
        Polymer('esis-attribute-editor', {

            attributeTypes : null,
            
            ds : null,

            // attributes who's types can be edited by used
            editableArray : [],
            // attributes who's types are implied by format
            fixedArray : [],


            // modifications
            modifications : null,

            // toggles
            showWavelengths : false,
            showFixed : false,
            showEditable : false,

            ready : function() {
                this.ds = document.querySelector('esis-datastore');
            },

            update : function() {
                this.editableArray = [];
                this.fixedArray = [];

                //var wavelengths = [];

                for( var i = 0; i < this.ds.schema.length; i++ ) {
                    var attr = this.ds.schema[i];

                    if( attr.declared || attr.scope == 'metadata' || attr.scope == 'file') {
                        if( attr.declared ) {
                            attr.flag = '5';
                            attr.class = 'data';
                        } else if( attr.scope == 'metadata' ) {
                            attr.flag = '1';
                            attr.class = 'metadata';
                        } else if( attr.scope == 'file' ) {
                            attr.flag = '4';
                            attr.class = 'file';
                        }

                        this.fixedArray.push(attr);
                    } else {
                        attr.class = attr.type;
                        this.editableArray.push(attr);
                    }
                }

                // WTF
                if( this.$.wavelengths ) {
                    this.$.wavelengths.innerHTML = this.ds.wavelengths.join(', ');
                }
            },

            timers : {},
            onAttributeChange : function(e) {
                var index = parseInt(e.currentTarget.getAttribute('index'));
                var array = e.currentTarget.getAttribute('array');
                
                var id = array+'-'+index;
                if( this.timers[id] && this.timers[id] != -1 ) {
                    clearTimeout(this.timers[id]);
                }

                this.timers[id] = setTimeout(function(){
                    this.timers[id] = -1;
                    this.updateAttribute(array, index);
                }.bind(this), 2000);
            },

            updateAttribute : function(array, index) {
                var attr, item;
                if( array == 'editable' ) {
                    item = this.editableArray[index];
                    attr = {
                        name : item.name,
                        units : item.units,
                        type : item.type
                    }
                } else {
                    item = this.fixedArray[index];
                    attr = {
                        name : item.name,
                        units : item.units
                    }
                }

                item.saving = true;
                document.querySelector('esis-ckan').setAttributeInfo(
                    this.ds.package_id,
                    attr,
                    function(err, resp){
                        if( err ) alert('Error saving '+attr.name+' :(');
                        item.saving = false;
                        item.class = item.type;
                    }
                );
            },

            _toggleWavelengths : function() {
                this.showWavelengths = !this.showWavelengths;
            },

            _toggleEditable : function() {
                this.showEditable = !this.showEditable;
                if( this.showEditable ) {
                    this.async(function(){
                        this.$.editList.updateSize();
                    });
                }
            },

            _toggleFixed : function() {
                this.showFixed = !this.showFixed;
                if( this.showFixed ) {
                    this.async(function(){
                        this.$.fixedList.updateSize();
                    });
                }
            }

        });
    </script>
</polymer-element>