<polymer-element name="esis-add-resource">
    <template>
        <style>
            paper-tabs {
                margin-bottom: 20px;
            }
            paper-tabs::shadow #selectionBar {
                background-color: rgb(47, 155, 69);
            }
            paper-tab::shadow #ink {
                color: rgb(47, 155, 69);
            }
            paper-checkbox {
                padding: 20px;
            }
            #dropZone {
                border: 2px dashed #bbb;
                -moz-border-radius: 5px;
                -webkit-border-radius: 5px;
                border-radius: 5px;
                padding: 25px;
                font-size: 20pt;
                color: #bbb;
                background-color: white;
                margin: 15px 0 0 0;
            }
            .processing-label {
                width: 100%;
                position: absolute;
                top: 0;
            }
            .fileinput {
                /*margin-top: 50px;*/
            }
            .fileinput.processing {
                visibility: hidden;
            }
            a {
                color : #2f9b45;
                cursor: pointer;
            }
            .next {
                margin-top: 50px;
                opacity: 0;
                transition: opacity 500ms linear;
                -webkit-transition: opacity 500ms linear;
                -moz-transition: opacity 500ms linear;
                display: none;
            }
            .next.ready {
                display: block;
                opacity: 1;
            }
            .options-card {
                margin: 10px;
                padding: 5px;
            }
            .note {
                padding: 10px;
                color: #777;
                font-size: 13px;
            }
            .options {
                background-color: #eee;
                padding: 15px 10px;
                border-radius: 3px;
                margin-bottom: 10px;
            }
            .formatHelp {
                margin: 0 15px; 
                border-left: 1px solid #2f9b45; 
                padding: 15px; 
                color: #888;
            }
        </style>


        <h4 style="margin-bottom: 0">Select files to be uploaded</h4>
        <div style="font-size:12px;color:#888; margin-bottom: 30px">
            <span>Add new files below by using the file selector or drag files over the drop zone.</span>
        </div>

        <div class="options">
            <div style="color:#888; margin: 10px 0 0px 15px">Default Data Orientation</div>

            <div style="margin-left: 20px">
                <paper-radio-group selected="{{options.type}}" role="radiogroup" style="margin-left: 10px">
                    <paper-radio-button 
                        name="column" 
                        label="My data is laid out by column" 
                        role="radio" 
                        tabindex="0" 
                        aria-checked="true" 
                        aria-label="column format" 
                        class="core-selected" 
                        checked>
                    </paper-radio-button>
                    <paper-radio-button 
                        name="row" 
                        label="My data is laid out by row" 
                        role="radio" 
                        tabindex="1" 
                        aria-checked="false" 
                        aria-label="row format">
                    </paper-radio-button>
                </paper-radio-group>

                <div style="margin-left:15px">
                    <div class="note">
                        <a on-tap="{{toggleHelp}}">Help.</a>
                    </div>
                </div>
            </div>

            <core-collapse opened="{{showHelp}}">
                <div style="margin: 30px 0 0 20px; padding-top: 10px; border-top: 1px solid #eee">
                    <esis-dataformat-help type="{{options.type}}"></esis-dataformat-help>
                </div>
            </core-collapse>
        </div>


        <template bind if="{{processing}}">
            <div style="position:relative; text-align:center">
                <div class="processing-label">
                    <h4>Uploading & Processing Files...</h4>
                    <table class="table" style="text-align: left">
                        <tr template repeat="{{file, i in staggedFiles}}">
                            <td><b>{{file.name}}</b></td>
                            <td style="color:#888">
                                <span hidden?="{{file.progress == 100 || file.aborted}}">Uploading: {{file.progress}}% @ {{file.speed}}</span>
                                <span hidden?="{{file.progress != 100 || file.aborted}}">Upload Complete. Processing...</span>
                                <span hidden?="{{!file.aborted}}" style="color:red">Aborted</span>
                            </td>
                            <td>
                                <a style="cursor:pointer" on-click="{{abort}}" index="{{i}}" hidden?="{{file.aborted || file.progress == 100}}">Abort</a>
                            </td>
                        </tr>
                    </table>
                   
                </div>
            </div>
        </template>

        <div class="fileinput {{processing ? 'processing' : ''}}">
            <div>
                
                <input type="file" style="margin:30px 0 0 15px" id="file" name="file" multiple="" on-change="{{_handleFileSelect}}" />

                <input type="file" style="display:none" id="addFileTesting" name="addFileTesting" multiple="" />
            </div>

            <div class="file-select-group" >
                <div id="dropZone"><b>OR</b> drag and drop files here</div>
            </div>
        </div>

        <div style="margin-top: 40px">
            <paper-button class="color: green" on-click="{{toggleDataTool}}">EcoSIS Data Tool</paper-button>
            <core-collapse opened="{{showDataTool}}">
                <div class="formatHelp">
                    <div>Need help packaging your data?  What to markup your data with EcoSIS metadata and controlled vocabularies so it can be easy discovered?  Use the <a href="https://github.com/CSTARS/ecosis-data-tool/releases" target="_blank">EcoSIS Data Tool</a> to markup your metadata and create a package for your dataset to easily upload using this editor.</div>
                </div>
            </core-collapse>
        </div>

        <div style="margin-top: 40px">
            <paper-button class="color: green" on-click="{{toggleTypeHelp}}">Supported File Types</paper-button>
            <core-collapse opened="{{showTypeHelp}}">
                <div class="formatHelp">
                    <div>Currently the following tabular file types will be parsed.</div>
                    <ul>
                        <li>.xls</li>
                        <li>.xlsx</li>
                        <li>.csv</li>
                        <li>.tsv (Tab Separated Value)</li>
                        <li>.spectra (parsed as .tsv)</li>
                        <li>.zip<span class="green">*</span></li>
                    </ul>
                    <div style="margin-bottom: 15px"><span class="green">*</span>Zip files will be extracted on the server. Any files contained within the zip file that have supported extension will be parsed.</div>

                    <div>Other file extensions are accepted but will not be parsed.</div>
                </div>
            </core-collapse>
        </div>

        <!-- for v2
        <div>
            Link Git Repository:
            <input type="text" value="{{gitUrl}}" />
            <button is="paper-button" on-tap="{{setGitRepo}}">Add Repo</button>
        </div>
        -->

        
    </template>
    <script>
        Polymer('esis-add-resource', {
            ds : null,
            processing : false,

            // v2
            // gitUrl : '',

            showTypeHelp : false,
            showDataTool : false,

            showHelp : false,

            options : {
                type : 'column'
            },

            staggedFiles : [],
            newResourceIds : [],

            ready : function() {                
                this.ds = document.querySelector('esis-datastore');
                this.$.dropZone.addEventListener('dragover', this._handleDragOver.bind(this), false);
                this.$.dropZone.addEventListener('drop', this._handleFileSelect.bind(this), false);

                // for webdriver (integration testing)
                this.expose();
            },

            /**
            For v2
            setGitRepo : function() {
                var resource = {
                    package_id : this.ds.package_id,
                    name : 'Git Repo',
                    url : this.gitUrl
                };
                

                document.querySelector('esis-ckan').addUrlResource(resource, function(err, resp){
                    console.log(err);
                    console.log(resp);
                });
            },
            **/

            _handleDragOver : function (evt) {
                evt.stopPropagation();
                evt.preventDefault();
                evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
            },

            _handleFileSelect : function(evt) {
                evt.stopPropagation();
                evt.preventDefault();

                this.processing = true;

                var files = evt.dataTransfer ? evt.dataTransfer.files : evt.target.files; // FileList object.
                this.staggedFiles = [];
                this.newResourceIds = [];
                for( var i = 0; i < files.length; i++ ) {
                    this.staggedFiles.push({
                        file : files[i],
                        name : files[i].name,
                        aborted : false,
                        xhr : null,
                        progress : 0,
                        type : this.options.type
                    });
                }

                var type = this.options.type;

                this._uploadFiles(type, 0);
            },

            _onUploadComplete : function() {
                // set default layout and parse workspace
                document.querySelector('esis-ckan').setDefaultLayout(
                    this.ds.package_id, this.newResourceIds, this.options.type,
                    function(err, resp) {
                        if( err ) return console.log('Error setting default resource layout :(');

                        this.$.file.value = '';
                        document.querySelector('esis-dataset-loader').runAfterResourceAdd(resp);
                        this.fire('resource-add');
                        this.processing = false;
                    }.bind(this)
                )
            },

            _uploadFiles : function(type, index) {
                if( this.staggedFiles.length == index ) {
                    // now tell server to parse resources with given type
                    this._onUploadComplete();
                    return;
                }

                var staggedFile = this.staggedFiles[index];

                if( staggedFile.aborted ) {
                    index++;
                    this._uploadFiles(type, index);
                    return;
                }


                var file = this.staggedFiles[index].file;
                var reader = new FileReader();


                reader.onload = function(e) {
                    staggedFile.xhr = document.querySelector('esis-ckan').addResource(
                        this.ds.package_id,
                        {
                            contents : e.target.result,
                            mimetype : file.type,
                            filename : file.name
                        },
                        function(err, resp) {
                            if( err ) console.log('Error adding resource: '+file.name);

                            // save this, when we are done, we will set default parse type
                            this.newResourceIds.push(resp.result.id);

                            index++
                            this._uploadFiles(type, index);
                        }.bind(this),
                        function(progress, speed) {
                            this.staggedFiles[index].speed = speed;
                            this.staggedFiles[index].progress = progress;
                        }.bind(this)
                    );
                    
                }.bind(this);
                reader.readAsArrayBuffer(file);        
            },

            abort : function(e) {
                var index = parseInt(e.currentTarget.getAttribute('index'));
                var staggedFile = this.staggedFiles[index];

                if( staggedFile.progress == 100 ) return;

                staggedFile.aborted = true;

                if( staggedFile.xhr ) {
                    staggedFile.xhr.abort();
                    index++;
                    this._uploadFiles(this.options.type, index);
                }
            },

            toggleHelp : function() {
                this.showHelp = !this.showHelp;
            },

            toggleTypeHelp : function() {
                this.showTypeHelp = !this.showTypeHelp;
            },

            toggleDataTool : function() {
                this.showDataTool = !this.showDataTool;
            },

            expose : function() {
                this.$.addFileTesting.parentNode.removeChild(this.$.addFileTesting);

                // expose file input for tests
                document.body.appendChild(this.$.addFileTesting);
                this.$.addFileTesting.addEventListener('change', this._handleFileSelect.bind(this), false);
            }
        });
    </script>
</polymer-element>