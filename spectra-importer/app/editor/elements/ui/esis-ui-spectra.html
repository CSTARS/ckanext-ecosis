<polymer-element name="esis-ui-spectra" attributes="show resourceId datasheet">
    <template>
        <style>
            .help {
                color: #888;
                font-size: 12px;
            }
        </style>    

        <template bind if="{{loading}}">
            <div class="green">Loading Spectra #{{index+1}}...</div>
            <paper-progress indeterminate style="width:100%"></paper-progress>
        </template>

        <div hidden?="{{loading}}">
            <div hidden?="{{currentSpectra.usda_code_status != 1}}" style="padding: 20px 10px">
                <h4 style="color: red">No 'USDA Code' attribute set.</h4>
                <div class="help">It is highly recommended that you set the <a href="http://plants.usda.gov/" target="_blank">USDA plant codes</a> for your dataset so EcoSIS can properly fill out the plant information</div>
            </div>

            <div hidden?="{{currentSpectra.usda_code_status != 2}}" style="padding: 20px 10px">
                <h4 style="color: red">Invalid USDA Code.</h4>
                <div class="help">EcoSIS does not recognize the <a href="http://plants.usda.gov/" target="_blank">USDA plant code</a> <b>{{data['USDA Code']}}</b>.  Please provide a correct code so EcoSIS can properly fill out the plant information.</div>
            </div>

            <div style="text-align:right" hidden?="{{indexes.length <= 1}}">
                Spectra #
                <select on-change="{{setIndex}}">
                    <template repeat="{{i in indexes}}">
                        <option value="{{i}}">{{i+1}}</option>
                    </template>
                </select>
            </div>

            <esis-ui-chart data="{{data}}" options="{{chartOptions}}" height="500"></esis-ui-chart>

            <table class="table">
                <tr template repeat="{{attr in attrs}}">
                    <td class="{{attr.isUSDACode ? 'green' : ''}}"><b>{{attr.name}}</b></td>
                    <td style="color: #888">{{attr.value}}</td>
                </tr>
            </table>

            <div hidden?="{{currentSpectra.usda_code_status != 3}}" style="padding: 20px 10px">
                Attributes in <span class="green">green</span> were filled in from the given <a href="http://plants.usda.gov/" target="_blank">USDA plant code.</a>
            </div>
        </div>

    </template>
    <script>
        Polymer('esis-ui-spectra', {
            loading : false,
            show : false,

            index : 0,
            data : [[]],
            attrs : [],
            indexes : [],
            spectraCache : {},

            currentSpectra : {},

            plantAttrs : ['Common Name', 'Accepted Symbol', 'Genus', 'Synonym Symbol', 'Scientific Name', 'Category'],

            chartOptions : {
                explorer : {}
            },

            observe : {
                datasheet : 'updateDatasheet',
                index : 'update',
                show : 'update'
            },

            updateDatasheet : function() {
                this.spectraCache = {};
                this.indexes = [];
                this.index = 0;

                for( var i = 0; i < this.datasheet.spectra_count; i++ ) {
                    this.indexes.push(i);
                }
                this.update();
            },

            clearCache : function() {
                this.spectraCache = {};
                this.show = false;
            },

            update : function() {
                if( !this.show ) return;

                if( this.spectraCache[this.index] ) {
                    this._renderSpectra(this.spectraCache[this.index]);
                    return;
                }

                this.loading = true;

                document.querySelector('esis-ckan').getSpectra(
                    document.querySelector('esis-datastore').package_id,
                    this.resourceId,
                    this.datasheet.id,
                    this.index,
                    function(err, resp) {
                        this.loading = false;
                        if( err ) return alert('Error loading spectra: '+this.index);
                        this.spectraCache[this.index] = resp;
                        this._renderSpectra(resp);
                    }.bind(this)
                )
            },

            _renderSpectra : function(spectra) {
                this.currentSpectra = spectra;

                var re1Wave = /^-?\d+\.?\d*/;
                var re2Wave = /^-?\d*\.\d+/; 

                this.data = [];
                for( var i = 0; i < spectra.datapoints.length; i++ ) {
                    if( re1Wave.test(spectra.datapoints[i].key) || re2Wave.test(spectra.datapoints[i].key) ) {
                        this.data.push([
                            parseFloat(spectra.datapoints[i].key),
                            parseFloat(spectra.datapoints[i].value)
                        ])
                    }
                }

                this.data.sort(function(a, b){
                    if( a[0] > b[0] ) return 1;
                    if( a[0] < b[0] ) return -1;
                    return 0;
                });

                this.data.splice(0, 0, ['Wavelength', '']);

                this.attrs = [];
                for( var attrName in spectra ) {
                    if( attrName == 'datapoints' || attrName == 'usda_code_status') continue;
                    this.attrs.push({
                        name: attrName, 
                        value: spectra[attrName],
                        isUSDACode : ( this.plantAttrs.indexOf(attrName) > -1 ) ? true : false
                    });
                }

            },

            setIndex : function(e) {
                this.index = parseInt(e.currentTarget.value);
            }

        })
    </script>
</polymer-element>