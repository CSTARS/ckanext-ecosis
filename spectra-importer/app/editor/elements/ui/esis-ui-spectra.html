<link rel="import" href="esis-ui-card.html" />

<polymer-element name="esis-ui-spectra" attributes="spectra">
	<template>
		<style>
			.card {
				margin: 10px 5px;
				padding: 5px;
				border: 1px solid #ccc;
				border-radius: 3px;
			}
			table tr th {
				text-align: left;
			}
			h4 {
				margin: 5px;
			}
			table {
				width: 100%;
			}
			table td {
				padding: 6px 2px;
			}
		</style>

		<div class="card">
			<h4 style="color: #888">From - {{spectra.filename}}</h4>

			<table style="width:100%">
				<tr template repeat="{{item in metadata.file}}">
					<td><span class="bs-label success-label">{{item.key}}</span></td><td>{{item.value}}</td>
				</tr>
				<tr template repeat="{{item in metadata.joined}}">
					<td><span class="bs-label warning-label">{{item.key}}</span></td><td>{{item.value}}</td>
				</tr>
				<tr template repeat="{{item in metadata.spectra}}">
					<td><span class="bs-label info-label">{{item.key}}</span></td><td>{{item.value}}</td>
				</tr>
			</table>

			<div id="chart" style="height:400px"></div>
		</div>
	</template>
	<script>
		Polymer('esis-ui-spectra', {
			spectra : {},

			metadata : {
				file : [],
				joined : [],
				spectra : []
			},

			dt : null,
			chart : null,

			observe : {
				spectra : '_update',
			},

			ready : function() {
				this.chart = new google.visualization.LineChart(this.$.chart);
			},

			_update : function() {
				this.metadata = {
					file : [],
					joined : [],
					spectra : []
				}
				if( !this.spectra ) return;
				if( !this.spectra.metadata ) return;

				var attrMap = document.querySelector('esis-datastore').attributeMap;
				var flipMap = {};
				// flip the map;
				for( var key in attrMap ) {
					if( attrMap[key] != '' ) flipMap[attrMap[key]] = key;
				}

				var key;
				for( key in this.spectra.metadata.file ) {
					this.metadata.file.push({key:this._getLabel(key, flipMap), value:this.spectra.metadata.file[key]});
				}
				for( key in this.spectra.metadata.joined ) {
					this.metadata.joined.push({key:this._getLabel(key, flipMap), value:this.spectra.metadata.joined[key]});
				}
				for( key in this.spectra.metadata.spectra ) {
					this.metadata.spectra.push({key:this._getLabel(key, flipMap), value:this.spectra.metadata.spectra[key]});
				}

				this.dt = new google.visualization.DataTable();
				var rows = [];

				this.dt.addColumn('number', 'Wavelength');
				this.dt.addColumn('number', '')

				for( var i = 0; i < this.spectra.data.length; i++ ) {
			  		rows.push([
			  			parseFloat(this.spectra.data[i][0]),
			  			parseFloat(this.spectra.data[i][1])
			  		]);
				}

				rows.sort(function(a, b){
		       		if( a[0] > b[0] ) return 1;
		       		if( a[0] < b[0] ) return -1;
		       		return 0;
		    	});

		      	this.dt.addRows(rows);

		      	setTimeout(function(){
		      		this._drawChart();
		      	}.bind(this), 200);
			},

			_getLabel : function(key, attrMap) {
				if( attrMap[key] ) {
					 return (esis.metadata[attrMap[key]] ? attrMap[key] : '*'+attrMap[key]) + ' (' +
					 		(esis.metadata[key] ? key : '*'+key) + ')';
				}
				return esis.metadata[key] ? key : '*'+key;
			},

			show : function() {
				this._update();
			},

			_drawChart : function() {

		      // Set chart options
		      var options = {
		            width : $(this.$.chart).width(),
		            height : 400,
		            legend : {
		            	position : 'none'
		            },
		            animation:{
				        duration: 1000,
				        easing: 'out'
				    }
		      };

		      // Instantiate and draw our chart, passing in some options.
		      this.chart.draw(this.dt, options);
			}
		});
	</script>
</polymer-element>