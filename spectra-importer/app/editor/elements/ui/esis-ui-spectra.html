<polymer-element name="esis-ui-spectra" attributes="show resourceId datasheet">
    <template>
        <style>
            table {
                width: 100%;
            }
            table td {
                padding: 3px;
            }
        </style>

        <template bind if="{{loading}}">
            <div class="green">Loading Spectra...</div>
            <paper-progress indeterminate style="width:100%"></paper-progress>
        </template>

        <div hidden?="{{loading}}">
            <div style="text-align:right" hidden?="{{indexes.length <= 1}}">
                Spectra #
                <select on-change="{{setIndex}}">
                    <template repeat="{{i in indexes}}">
                        <option value="{{i}}">{{i+1}}</option>
                    </template>
                </select>
            </div>

            <esis-ui-chart data="{{data}}" options="{{chartOptions}}" height="500"></esis-ui-chart>


            <table>
                <tr template repeat="{{attr in attrs}}">
                    <td><b>{{attr.name}}</b></td>
                    <td style="color: #888">{{attr.value}}</td>
                </tr>
            </table>
        </div>

    </template>
    <script>
        Polymer('esis-ui-spectra', {
            loading : false,
            show : false,

            index : 0,
            data : [[]],
            attrs : [],
            indexes : [],
            spectraCache : {},

            chartOptions : {
                explorer : {}
            },

            observe : {
                datasheet : 'updateDatasheet',
                index : 'update',
                show : 'update'
            },

            updateDatasheet : function() {
                this.spectraCache = {};
                this.indexes = [];
                this.index = 0;

                for( var i = 0; i < this.datasheet.spectra_count; i++ ) {
                    this.indexes.push(i);
                }
                this.update();
            },

            update : function() {
                if( !this.show ) return;

                if( this.spectraCache[this.index] ) {
                    this._renderSpectra(this.spectraCache[this.index]);
                    return;
                }

                this.loading = true;

                document.querySelector('esis-ckan').getSpectra(
                    document.querySelector('esis-datastore').package_id,
                    this.resourceId,
                    this.datasheet.id,
                    this.index,
                    function(err, resp) {
                        this.loading = false;
                        if( err ) return alert('Error loading spectra: '+this.index);
                        this.spectraCache[this.index] = resp;
                        this._renderSpectra(resp);
                    }.bind(this)
                )
            },

            _renderSpectra : function(spectra) {
                var re1Wave = /^-?\d+\.?\d*/;
                var re2Wave = /^-?\d*\.\d+/; 

                this.data = [];
                for( var i = 0; i < spectra.datapoints.length; i++ ) {
                    if( re1Wave.test(spectra.datapoints[i].key) || re2Wave.test(spectra.datapoints[i].key) ) {
                        this.data.push([
                            parseFloat(spectra.datapoints[i].key),
                            parseFloat(spectra.datapoints[i].value)
                        ])
                    }
                }

                this.data.sort(function(a, b){
                    if( a[0] > b[0] ) return 1;
                    if( a[0] < b[0] ) return -1;
                    return 0;
                });

                this.data.splice(0, 0, ['Wavelength', '']);

                this.attrs = [];
                for( var attrName in spectra ) {
                    if( attrName == 'datapoints' ) continue;
                    this.attrs.push({
                        name: attrName, 
                        value: spectra[attrName]
                    });
                }
            },

            setIndex : function(e) {
                this.index = parseInt(e.currentTarget.value);
            }

        })
    </script>
</polymer-element>