<polymer-element name="esis-attribute-ordering" attributes="attributeTypes">
    <template>
        <style>
            .input-wrapper {
                margin: 10px 10px 50px 10px;
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 6px;
            }
            .help {
                color: #888;
                font-size: 12px;
            }
            paper-input::shadow .focusedColor {
                background-color: #2f9b45;
                color: #2f9b45;
            }
            h4 {
                margin-bottom: 5px;
            }
            paper-progress {
                width: 100%;
            }
        </style>

        <div style="background-color: #eee; border-radius: 6px; margin:10px 0; padding: 10px">
            All of the following inputs are optional.
        </div>

        <h4>Dataset Ordering</h4>
        <div class="help">
            Is this a time series dataset or a dataset that has any other form of ordering?  If so, select the attribute to order by as well as the type of sort that should be performed.  You can also provide a textual description of what this ordering is.
        </div>
        <div class="input-wrapper">
            Order By:
            <select value="{{ds.datasetAttributes.sort_on}}" on-change="{{onChange}}">
                <option value=""></option>
                <template repeat="{{attr in attributeArray}}">
                    <option value="{{attr.name}}" selected?="{{attr.name == ds.datasetAttributes.sort_on}}">{{attr.name}}</option>
                </template>
            </select>

            <div hidden?="{{ds.datasetAttributes.sort_on == ''}}">
                <div style="margin-top:10px">
                    Order Type: 
                    <select value="{{ds.datasetAttributes.sort_type}}" on-change="{{onChange}}">
                        <option value="string">Default (String)</option>
                        <option value="datetime">Date</option>
                        <option value="numeric">Numeric</option>
                    </select>
                </div>
                <div class="help" hidden?="{{ds.datasetAttributes.sort_type != 'datetime'}}" style="padding: 5px">
                    Use <a href="http://www.w3.org/TR/NOTE-datetime" target="_blank">ISO-8601</a> for which the format is: YYYY-MM-DDTHH:mm:ss.sssZ. <a href="http://xkcd.com/1179/" target="_blank">Why?</a>
                </div>

                <paper-input 
                    multiline 
                    rows="3" 
                    floatingLabel 
                    label="Description" 
                    value="{{ds.datasetAttributes.sort_description}}" 
                    on-change="{{onChange}}">
                </paper-input>
            </div>
        </div>
        
        <h4>Geographic Location</h4>
        <div class="help">
            Select the attribute below that provides a geolocation for this dataset.
        </div>
        <div class="input-wrapper">
            <div style="margin-bottom: 10px">
                Format:
                <select value="{{ds.datasetAttributes.locationType}}" on-change="{{onChange}}">
                    <option value="geojson">GeoJson</option>
                    <option value="latlng">Lat / Lng</option>
                </select>
            </div>

            <template bind if="{{!ds.datasetAttributes.locationType || ds.datasetAttributes.locationType == 'geojson'}}">
                Location:
                <select value="{{ds.datasetAttributes.location}}" on-change="{{onChange}}">
                    <option value=""></option>
                    <template repeat="{{attr in attributeArray}}">
                        <option value="{{attr.name}}" selected?="{{attr.name == ds.datasetAttributes.location}}">{{attr.name}}</option>
                    </template>
                </select>
                <div style="padding:10px" class="help">The selected location attribute should be in <a href="http://geojson.org/" target="_blank">GeoJSON</a> format using <a href="http://spatialreference.org/ref/epsg/4326/" target="_blank">EPSG: 4326</a></div>
            </template>

            <template bind if="{{ds.datasetAttributes.locationType == 'latlng'}}">
                <div style="margin-bottom: 10px">
                    Latitude:
                    <select value="{{ds.datasetAttributes.locationLat}}" on-change="{{onChange}}">
                        <option value=""></option>
                        <template repeat="{{attr in attributeArray}}">
                            <option value="{{attr.name}}" selected?="{{attr.name == ds.datasetAttributes.locationLat}}">{{attr.name}}</option>
                        </template>
                    </select>
                </div>
                <div>
                    Longitude:
                    <select value="{{ds.datasetAttributes.locationLng}}" on-change="{{onChange}}">
                        <option value=""></option>
                        <template repeat="{{attr in attributeArray}}">
                            <option value="{{attr.name}}" selected?="{{attr.name == ds.datasetAttributes.locationLng}}">{{attr.name}}</option>
                        </template>
                    </select>
                </div>

                <div style="padding:10px" class="help">The selected lat/lng attributes should be in <a href="http://spatialreference.org/ref/epsg/4326/" target="_blank">EPSG: 4326</a></div>
            </template>
        </div>

        <div hidden?="{{!saving}}">
            <div class="green">Updating...</div>
            <paper-progress indeterminate></paper-progress>
        </div>

    </template>
    <script>
        Polymer('esis-attribute-ordering', {
            attributeArray : [],
            saving : false,
            ds : null,
            timer : -1,

            ready : function() {
                this.ds = document.querySelector('esis-datastore');
            },

            update : function() {
                this.attributeArray = [];

                for( var i = 0; i < this.ds.schema.length; i++ ) {
                    var attr = this.ds.schema[i];
                    if( attr.type == 'metadata' ) this.attributeArray.push(attr);
                }

                this.attributeArray.sort(function(a, b){
                    if( a.name > b.name ) return 1;
                    if( a.name < b.name ) return -1;
                    return 0;
                });

            },

            onChange : function() {
                if( this.timer != -1 ) clearTimeout(this.timer);
                this.timer = setTimeout(function() {
                    this.timer = -1;
                    this.save();
                }.bind(this), 2000);
            },

            save : function() {
                this.saving = true;
                document.querySelector('esis-ckan').setDatasetAttributes(
                    this.ds.package_id,
                    this.ds.datasetAttributes,
                    function(err, resp) {
                        this.saving = false;
                        if( err ) return alert('Error saving :(');
                    }.bind(this)
                )
            }


        });
    </script>
</polymer-element>