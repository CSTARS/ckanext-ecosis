
<link rel="import" href="../components/paper-dialog/paper-dialog.html">


<polymer-element name="esis-dataset-creator">
    <template>
        <link rel="stylesheet" href="../components/animate-css/animate.min.css">
        <style>
            paper-fab {
                color: #2f9b45;
                background-color: white;
                position: absolute;
                right: 10px;
                top: -55px;
                cursor: pointer;
            }
            paper-fab:hover {
                background-color: #eee;
            }
        </style>

        <paper-fab icon="{{ds.data.private ? 'cloud-off' : 'cloud-upload'}}" on-tap="{{show}}" hidden?="{{hide}}" class="animated rollIn" disabled?="{{ds.data.private}}"></paper-fab>
        
        <paper-dialog id="dialog" layered backdrop transition="paper-transition-bottom" autoCloseDisabled="true">
            <div hidden?="{{uploading}}">
                <esis-verify-dataset on-finalize="{{create}}" on-cancel="{{_cancel}}"></esis-verify-dataset>
            </div>
            <div hidden?="{{!uploading}}" style="min-width: 300px; min-height:250px">
                <h4>{{ds.editMode ? 'Updating' : 'Creating'}} Dataset...</h4>
                <div>{{statusText}}</div>
            </div>
        </paper-dialog>
    </template>
    <script>
        Polymer('esis-dataset-creator', {
            hide : true,
            ds : {},
            ckan : {},

            counts : {
                totalResources : 0,
                measurementResources : 0,
                metadataResources : 0,
                measurements : 0
            },

            joinOrder : ['joined','file','measurement'],
            // metadata names can't overwrite these attributes
            protectedKeys : ['_id', 'ecosis', 'datapoints'],

            observe : {
                'ds.data.name' : '_updateVisibility',
                'ds.deleted' : '_updateVisibility',
                'ds.files' : '_updateVisibility'
            },

            // local memory cache for usda common names
            commonCache : {},

            uploading : false,
            statusText : '',

            // make number of spectra to upload at one time
            MAX_DATA_UPLOAD_COUNT : 200,

            ready : function() {
                this.ds = document.querySelector('esis-datastore');
                this.ckan = document.querySelector('esis-ckan');
            },

            show : function() {
                this.$.dialog.toggle();
            },

            _updateVisibility : function() {
                if( (this.ds.data.name != '' && this.ds.resources.length > 0) || this.ds.editMode ) {
                    this.hide = false;
                } else {
                    this.hide = true;
                }
            },

            _cancel : function() {
                this.$.dialog.toggle();
            },

            // create a new ckan package
            create : function() {
                this.uploading = true,
                this.statusText = 'Pushing dataset to search (please wait, this may take a moment)...';

                document.querySelector('esis-ckan').pushToSearch(
                    this.ds.package_id,
                    function(err, resp){
                        this.uploading = false;
                        if( err ) alert('Error pushing dataset to search :(');
                        else alert('Success!');
                    }.bind(this)
                );
            }
            
        });
    </script>
</polymer-element>