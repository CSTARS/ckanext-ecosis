<polymer-element name="esis-group-by">
	<template>
		<style>
			.input-wrapper {
				margin: 20px;
			}
			paper-input::shadow .focusedColor {
				background-color: #2f9b45;
				color: #2f9b45;
			}
		</style>

		<div style="font-size: 14px; color: #888">
			Group your data by a certain attribute so related spectra within this dataset can easily be found in search.  Examples for this grouping include time series data, or data that is spatially related.  To group, first select the attribute in your dataset to group on.  This attribute should have the same value for all spectra in that group.  Next, provide a sort attribute.  For time, this would be the time attribute the spectra was taken at.  Finally, you can provide a description of this group to let others know what this grouping is.  Ex: "Spectra time series at 1 minute intervals"
		</div>

		<div class="input-wrapper">
			Group By:
			<select value="{{ds.group.by}}" on-change="{{_group}}">
				<option value=""></option>
				<template repeat="{{attr in ds.knownAttributes}}">
					<option value="{{attr}}">{{attr}}</option>
				</template>
			</select>
		</div>

		<div class="input-wrapper">
			Sort On:
			<select value="{{ds.group.sort_on}}">
				<option value=""></option>
				<template repeat="{{attr in ds.knownAttributes}}">
					<option value="{{attr}}">{{attr}}</option>
				</template>
			</select>
		</div>

		<div class="input-wrapper">
			<paper-input multiline rows="3" floatingLabel label="Description" value="{{ds.group.description}}" ></paper-input>
		</div>

		<template bind if="{{groups.length > 0}}">
			<div style="padding-bottom: 10px">Grouping Results: </div>
			<template repeat="{{group in groups}}">
				<div style="padding-left: 15px"><b>{{group.key}}:</b> {{group.value}}</div>
			</template>
		</template>


	</template>
	<script>
		Polymer('esis-group-by', {
			files : [],
			menuItem : null,
			ds : {},

			groups : [],

			observe : {
				'ds.knownAttributes' : '_updateVisibility',
				'ds.group.by' : '_updateButton',
				'ds.group.sort_on' : '_updateButton'
			},

			ready : function() {
				 window.addEventListener('polymer-ready', function(e) {
				 	this.async(function(){
				 		this.ds = document.querySelector('esis-datastore');
				 	});
				}.bind(this));
			},

			_updateVisibility : function() {
				if( this.ds.knownAttributes.length > 0 ) {
					this.menuItem.style.display = 'block';
				} else {
					this.menuItem.style.display = 'none';
				}
			},

			_group : function() {
				var result = {};
				for( var i = 0; i < this.ds.datasheets.length; i++ ) {
					if( this.ds.datasheets[i].isMetadata ) continue;
					var sheet = this.ds.datasheets[i];

					for( var j = 0; j < sheet.spectra.length; j++ ) {
						var attr = sheet.spectra[j].getMetadataAttr(this.ds.group.by);
						if( !attr ) continue;
						if( result[attr] ) result[attr] += 1;
						else result[attr] = 1;
					}
				}

				this.groups = [];
				for( var key in result ) {
					this.groups.push({key: key, value: result[key]});
				}
			},

			_updateButton : function() {
				if( this.ds.group.by == '' && this.ds.group.sort_on == '' ) return;
				this.menuItem.setSecondaryHtml('Group By: '+this.ds.group.by+'<br /> Sort On: '+this.ds.group.sort_on);
			}

		});
	</script>
</polymer-element>