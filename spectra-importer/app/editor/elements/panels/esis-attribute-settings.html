<link rel="import" href="../ui/esis-attribute-editor.html" />
<link rel="import" href="../ui/esis-attribute-ordering.html" />

<polymer-element name="esis-attribute-settings">
	<template>
		<style>
			h4 {
				border-bottom: 1px solid #eee;
				padding-bottom: 5px;
			}
			paper-tabs::shadow #selectionBar {
				background-color: rgb(47, 155, 69);
			}
			paper-tab::shadow #ink {
				color: rgb(47, 155, 69);
			}
		</style>

		<paper-tabs selected="{{currentTab}}">
			<paper-tab>Schema</paper-tab>
			<paper-tab>Dataset</paper-tab>
			<paper-tab>Map Names</paper-tab>
		</paper-tabs>

		<div hidden?="{{currentTab != 0}}">
			<esis-attribute-editor id="editor" attributeTypes="{{attributeTypes}}"></esis-attribute-editor>
		</div>

		<div hidden?="{{currentTab != 2}}">
	    	<div style="background-color: #eee; border-radius: 6px; margin:10px 0; padding: 10px">If your metadata attribute names do not match <a>this</a> list, you can download the attribute map file.  Fill out the file and then upload in the box to the right.  You can reuse this file, so you only have to fill it out once for your data.  Just make sure to set the attribute map for each dataset you add.</div>

	    	<div horizontal layout style="margin-top:25px">
	    		<div flex>
	    			<a class="btn btn-default" target="_blank" href="/metadata_map">Download Map Template</a>
	    		</div>
	    		<div flex>
	    			Upload Map: <input type="file" style="margin-top:5px" id="map" name="map" on-change="{{_processMap}}">
	    		</div>
	    	</div>

	    	<template bind if="{{attrMapList.length > 0}}">
	    		<h4 style="margin-top:50px">Current Name Mappings</h4>
	    		<template repeat="{{item, i in attrMapList}}">
	    			<div layout horizontal>
	    				<div flex><b>{{item.c1[0]}}:</b> <span style="color:#888">{{item.c1[1]}}</span></div>
	    				<div flex><b>{{item.c2[0]}}:</b> <span style="color:#888">{{item.c2[1]}}</span></div>
	    			</div>
	    		</template>
	    	</template>
	    </div>

	    <div hidden?="{{currentTab != 1}}">
	    	<esis-attribute-ordering id="ordering" attributeTypes="{{attributeTypes}}"></esis-attribute-ordering>
	    </div>

	</template>
	<script>
		Polymer('esis-attribute-settings', {
			datasheets : [],

			map : {},
			inverseMap : {},
			attrMapList : [],
			menuItem : null,

			attributeTypes : null,
			ds : null,

			currentTab : 0,

			observe : {
				'ds.datasheets' : '_updateVisibility',
				'ds.existing.data' : '_updateVisibility'
			},

			ready : function() {

				this.ds = document.querySelector('esis-datastore');

				this.ds.addEventListener('attribute-map-update', function(){
					this.map = this.ds.attributeMap;
				 	this._updateAttrMapList();
				}.bind(this));

				window.addEventListener('polymer-ready', function(e) {
				 	this.async(function(){
				 		this.files = this.ds.files;
				 		this.map = this.ds.attributeMap;
				 		this._updateAttrMapList();
				 	});
				 	this._updateVisibility();
				}.bind(this));
			},

			// fired when element is attached.  For this element we should render the attribute type control
			onShow : function() {
				this.attributeTypes = this.ds.getAllAttributeTypes();
				this.$.editor.update();
				this.$.ordering.update();
			},

			_updateVisibility : function() {
				if( this.ds.datasheets.length > 0 || this.ds.existing.data.length > 0 ) {
					this.menuItem.style.display = 'block';
				} else {
					this.menuItem.style.display = 'none';
				}
			},

			_processMap : function(e) {
				e.stopPropagation();
				e.preventDefault();

				var files = e.dataTransfer ? e.dataTransfer.files : e.target.files;
				if( files.length == 0 ) return;

				var reader = new FileReader();
				var contents, parts;

				reader.onload = function(e) {
					var newMap = {};
					contents = e.target.result.split('\n');

					for( var i = 0; i < contents.length; i++ ) {
						if( contents[i].indexOf('=') > -1 ) {
							parts = contents[i].split('=');
							newMap[parts[0]] = parts[1];
							//if( parts[1].length > 0 ) inverseMap[parts[1]] = parts[0];
						}
					}

					this.$.map.value = '';
					this._updateAttrMapList(newMap);
				}.bind(this);

				reader.readAsText(files[0]);
			},

			_updateAttrMapList : function(newMap) {
				this.attrMapList = [];

				var c = 0, item = {};
				var map = newMap || this.map;

				for( var key in map ) {
					if( map[key] && map[key].length > 0 ) {
						if( c % 2 != 0 ) {
							item['c2'] = [key, map[key]];
							this.attrMapList.push(item);
						} else {
							item = { c1 : [key, map[key]]};
						}
						c++;
					}
				}

				if( newMap ) {
					this.ds.attributeMap = newMap;
					this.ds.inverseAttributeMap = {};

					for( var key in newMap ) {
						if( newMap[key] != '' ) this.ds.inverseAttributeMap[newMap[key]] = key;
					}
				}
				this.menuItem.setSecondaryHtml(c+' Attributes Mapped');
			}

		});
	</script>
</polymer-element>