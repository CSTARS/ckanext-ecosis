<link rel="import" href="../../components/paper-checkbox/paper-checkbox.html" />
<link rel="import" href="../../components/paper-radio-group/paper-radio-group.html" />
<link rel="import" href="../../components/core-collapse/core-collapse.html" />
<link rel="import" href="../../components/paper-button/paper-button.html" />
<link rel="import" href="../ui/esis-ui-file.html" />
<link rel="import" href="../ui/esis-dataformat-help.html" />

<polymer-element name="esis-add-resource">
    <template>
        <link rel="stylesheet" href="../../components/animate-css/animate.min.css" no-shim>

        <style>
            paper-tabs {
                margin-bottom: 20px;
            }
            paper-tabs::shadow #selectionBar {
                background-color: rgb(47, 155, 69);
            }
            paper-tab::shadow #ink {
                color: rgb(47, 155, 69);
            }
            paper-checkbox {
                padding: 20px;
            }
            #dropZone {
                border: 2px dashed #bbb;
                -moz-border-radius: 5px;
                -webkit-border-radius: 5px;
                border-radius: 5px;
                padding: 25px;
                font-size: 20pt;
                color: #bbb;
                background-color: white;
                margin: 15px 0 0 0;
            }
            .processing-label {
                position: absolute;
                top: 0;
            }
            .fileinput {
                /*margin-top: 50px;*/
            }
            .fileinput.processing {
                visibility: hidden;
            }
            a {
                color : #2f9b45;
                cursor: pointer;
            }
            .next {
                margin-top: 50px;
                opacity: 0;
                transition: opacity 500ms linear;
                -webkit-transition: opacity 500ms linear;
                -moz-transition: opacity 500ms linear;
                display: none;
            }
            .next.ready {
                display: block;
                opacity: 1;
            }
            .options-card {
                margin: 10px;
                padding: 5px;
            }
            .note {
                padding: 10px;
                color: #777;
                font-size: 13px;
            }
            .options {
                background-color: #eee;
                padding: 15px 10px;
                border-radius: 3px;
                margin-bottom: 10px;
            }
        </style>


        <h4 style="margin-bottom: 0">Select files to be uploaded</h4>
        <div style="font-size:12px;color:#888; margin-bottom: 30px">
            <span>Add new files below by using the file selector or drag files over the drop zone.</span>
        </div>

        <div class="options">
            <div style="color:#888; margin: 10px 0 0px 15px">Default Data Format</div>

            <div style="margin-left: 20px">
                <paper-radio-group selected="{{options.type}}" role="radiogroup" style="margin-left: 10px">
                    <paper-radio-button 
                        name="column" 
                        label="My data is laid out by column" 
                        role="radio" 
                        tabindex="0" 
                        aria-checked="true" 
                        aria-label="column format" 
                        class="core-selected" 
                        checked>
                    </paper-radio-button>
                    <paper-radio-button 
                        name="row" 
                        label="My data is laid out by row" 
                        role="radio" 
                        tabindex="1" 
                        aria-checked="false" 
                        aria-label="row format">
                    </paper-radio-button>
                </paper-radio-group>

                <div style="margin-left:15px">
                    <div class="note">
                        <a on-tap="{{toggleHelp}}">Help.</a>
                    </div>
                </div>
            </div>

            <core-collapse opened="{{showHelp}}">
                <div style="margin: 30px 0 0 20px; padding-top: 10px; border-top: 1px solid #eee">
                    <esis-dataformat-help type="{{options.type}}"></esis-dataformat-help>
                </div>
            </core-collapse>
        </div>


        <template bind if="{{processing}}">
            <div style="position:relative; text-align:center">
                <div class="processing-label">
                    <h4>Uploading Files...</h4>
                    <template repeat="{{file in staggedFiles}}">
                        <div>{{file.name}} {{file.progress}}%</div>
                    </template>
                </div>
            </div>
        </template>

        <div class="fileinput {{processing ? 'processing' : ''}}">
            <div>
                
                <input type="file" style="margin:30px 0 0 15px" id="file" name="file" multiple="" on-change="{{_handleFileSelect}}" />

                <input type="file" style="display:none" id="addFileTesting" name="addFileTesting" multiple="" />
            </div>

            <div class="file-select-group" >
                <div id="dropZone"><b>OR</b> drag and drop files here</div>
            </div>
        </div>

        <!-- for v2
        <div>
            Link Git Repository:
            <input type="text" value="{{gitUrl}}" />
            <button is="paper-button" on-tap="{{setGitRepo}}">Add Repo</button>
        </div>
        -->


        <!--
        <span class="next {{ds.files.length > 0 ? 'ready' : ''}}">
            <core-icon icon="arrow-forward" style="color:#888;vertical-align:bottom"></core-icon> Once you are done adding files
            <ul>
                <li><a on-tap='{{_gotoDatasheets}}'>Configure the datasheets</a></li>
                <li>Then <a on-tap='{{_gotoAttrSetting}}'>configure the datasets attribute schema</a></li>
                <li>Finally <a on-tap='{{_gotoInspect}}'>inspect the parsed spectra.</a></li>
            </ul>
        </span>
        -->
        
    </template>
    <script>
        Polymer('esis-add-resource', {
            ds : null,
            processing : false,

            // v2
            // gitUrl : '',

            showHelp : false,

            options : {
                type : 'column'
            },

            staggedFiles : [],
            newResourceIds : [],

            ready : function() {                
                this.ds = document.querySelector('esis-datastore');
                this.$.dropZone.addEventListener('dragover', this._handleDragOver.bind(this), false);
                this.$.dropZone.addEventListener('drop', this._handleFileSelect.bind(this), false);

                // for webdriver (integration testing)
                this.expose();
            },

            /**
            For v2
            setGitRepo : function() {
                var resource = {
                    package_id : this.ds.package_id,
                    name : 'Git Repo',
                    url : this.gitUrl
                };
                

                document.querySelector('esis-ckan').addUrlResource(resource, function(err, resp){
                    console.log(err);
                    console.log(resp);
                });
            },
            **/

            _handleDragOver : function (evt) {
                evt.stopPropagation();
                evt.preventDefault();
                evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
            },

            _handleFileSelect : function(evt) {
                evt.stopPropagation();
                evt.preventDefault();

                this.processing = true;

                var files = evt.dataTransfer ? evt.dataTransfer.files : evt.target.files; // FileList object.
                this.staggedFiles = [];
                this.newResourceIds = [];
                for( var i = 0; i < files.length; i++ ) {
                    this.staggedFiles.push({
                        file : files[i],
                        name : files[i].name,
                        progress : 0
                    });
                }

                var type = this.options.type;

                this._uploadFiles(type, 0, function(){

                    // set default layout and parse workspace
                    document.querySelector('esis-ckan').setDefaultLayout(
                        this.ds.package_id, this.newResourceIds, this.options.type,
                        function(err, resp) {
                            if( err ) return console.log('Error setting default resource layout :(');

                            this.$.file.value = '';
                            document.querySelector('esis-dataset-loader').runAfterResourceAdd(resp);
                            this.fire('resource-add');
                            this.processing = false;
                        }.bind(this)
                    )
                }.bind(this));
            },

            _uploadFiles : function(type, index, callback) {
                if( this.staggedFiles.length == index ) {
                    // now tell server to parse resources with given type
                    callback();
                    return;
                }

                var file = this.staggedFiles[index].file;
                var reader = new FileReader();


                reader.onload = function(e) {
                    document.querySelector('esis-ckan').addResource(
                        this.ds.package_id,
                        {
                            contents : e.target.result,
                            mimetype : file.type,
                            filename : file.name
                        },
                        function(err, resp) {
                            if( err ) console.log('Error adding resource: '+file.name);

                            // save this, when we are done, we will set default parse type
                            this.newResourceIds.push(resp.result.id);

                            index++
                            this._uploadFiles(type, index, callback);
                        }.bind(this),
                        function(progress) {
                            this.staggedFiles[index].progress = progress;
                        }.bind(this)
                    )
                    
                }.bind(this);
                reader.readAsArrayBuffer(file);        
            },

            _gotoInspect : function() {
                window.location.hash = 'parsed-spectra';
            },

            _gotoDatasheets : function() {
                this.selectedTab = 2;
            },

            _gotoAttrSetting : function() {
                window.location.hash = 'attribute-settings';
            },

            toggleHelp : function() {
                this.showHelp = !this.showHelp;
            },

            _updateDatasheet : function() {
                if( typeof this.selectedSheetIndex == 'string' ) this.selectedSheetIndex = parseInt(this.selectedSheetIndex);
                this.selectedSheet = this.newDatasheets[this.selectedSheetIndex];
            },

            _previousDatasheet : function() {
                if( typeof this.selectedSheetIndex == 'string' ) this.selectedSheetIndex = parseInt(this.selectedSheetIndex);
                this.selectedSheetIndex--;
            },

            _nextDatasheet : function() {
                if( typeof this.selectedSheetIndex == 'string' ) this.selectedSheetIndex = parseInt(this.selectedSheetIndex);
                this.selectedSheetIndex++;
            },

            expose : function() {
                this.$.addFileTesting.parentNode.removeChild(this.$.addFileTesting);

                // expose file input for tests
                document.body.appendChild(this.$.addFileTesting);
                this.$.addFileTesting.addEventListener('change', this._handleFileSelect.bind(this), false);
            }


        });
    </script>
</polymer-element>