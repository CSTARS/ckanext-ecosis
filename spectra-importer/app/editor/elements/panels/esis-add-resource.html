<link rel="import" href="../../components/paper-checkbox/paper-checkbox.html" />
<link rel="import" href="../../components/paper-radio-group/paper-radio-group.html" />
<link rel="import" href="../../components/core-collapse/core-collapse.html" />
<link rel="import" href="../../components/paper-button/paper-button.html" />
<link rel="import" href="../ui/esis-ui-file.html" />

<polymer-element name="esis-add-resource">
	<template>
		<link rel="stylesheet" href="../../components/animate-css/animate.min.css" no-shim>

		<style>
			paper-checkbox {
				padding: 20px;
			}
			#dropZone {
				border: 2px dashed #bbb;
				-moz-border-radius: 5px;
				-webkit-border-radius: 5px;
				border-radius: 5px;
				padding: 25px;
				font-size: 20pt;
				color: #bbb;
				background-color: white;
				margin: 20px 0 0 50px;
			}
			.processing-label {
				position: absolute;
				top: 0;
			}
			.fileinput.processing {
				visibility: hidden;
			}
			a {
				color : #2f9b45;
				cursor: pointer;
			}
			.new-resources {
				margin: 50px 0;
				padding: 10px;
				background-color: #eee;
				border-radius: 3px;
			}
			.new-resources h4 {
				color: #888;
			}
			.next {
				opacity: 0;
				transition: opacity 500ms linear;
				-webkit-transition: opacity 500ms linear;
				-moz-transition: opacity 500ms linear;
				display: none;
			}
			.next.ready {
				display: block;
				opacity: 1;
			}
			.options-card {
				margin: 10px;
				padding: 5px;
			}
		</style>

		<div style="font-size:14px;color:#888">
			<span>Add new files below by using the file selector or drag files over the drop zone.</span><br /><br />
			<span class="next {{ds.files.length > 0 ? 'ready' : ''}}" style="font-weight:bold; background-color:#f8f8f8; padding:5px; border-radius: 3px">
		    	<core-icon icon="arrow-forward" style="color:#888;vertical-align:middle"></core-icon> Once you are done adding files, <a on-tap='{{_gotoInspect}}'>Click Here</a> to inspect the parsed spectra.
		    </span>
		</div>

		<paper-button label="File Import Options" on-tap="{{toggleOptions}}" raisedButton></paper-button>
		<core-collapse opened="{{showOptions}}">
			<esis-ui-card class="options-card">
				<div horizontal layout>
				    <paper-checkbox checked="{{parseZip}}"></paper-checkbox>
				    <div vertical layout>
				     	<h4>Extract Zip Files</h4>
				     	<div style="color:#888">If a zip file is found, should its contents be imported as individual file resources?  By default the spectra will be parsed, but the zip will be uploaded intact.</div>
				    </div>
				</div>

				<div style="margin-left: 20px">
					<h4>Tabular data layout</h4>
					<paper-radio-group class="blue" selected="auto" role="radiogroup" style="margin-left: 10px">
				     	<paper-radio-button name="auto" label="Horizontal" role="radio" tabindex="0" aria-checked="true" aria-label="Auto" class="core-selected" checked=""></paper-radio-button>
				    	<paper-radio-button name="5ghz" label="Vertical" role="radio" tabindex="0" aria-checked="false" aria-label="5 GHz only" class=""></paper-radio-button>
				    </paper-radio-group>
				</div>
			</esis-ui-card>
		</core-collapse>

		<template bind if="{{processing}}">
	    	<div style="position:relative; text-align:center">
		    	<div class="processing-label">
		    		<h4>Processing Files...</h4>
		    	</div>
		    </div>
	    </template>

		<div class="fileinput {{processing ? 'processing' : ''}}">
			<div style="margin-left: 20px">
				<h4>Select files to be imported</h4>
				<input type="file" style="margin:5px 0 0 33px" id="file" name="file" multiple="" on-change="{{_handleFileSelect}}">
			</div>

			<div class="file-select-group" >
	        	<div id="dropZone"><b>OR</b> drag and drop files here</div>
	    	</div>
	    </div>

	    <template bind if="{{ds.files.length > 0}}">
	    	<div class="new-resources">
		    	<h4>New Files</h4>
		    	<template repeat="{{file in ds.files}}">
		    		<esis-ui-file file="{{file}}"></esis-ui-file>
		    	</template>
		    </div>
	    </template>

	    <span class="next {{ds.files.length > 0 ? 'ready' : ''}}">
	    	<core-icon icon="arrow-forward" style="color:#888;vertical-align:bottom"></core-icon> Once you are done adding files, <a on-tap='{{_gotoInspect}}'>Click Here</a> to inspect the parsed spectra.
	    </span>
    	
		
	</template>
	<script>
		Polymer('esis-add-resource', {
			menuItem : null,
			ds : null,
			processing : false,
			parseZip : false,

			showOptions : false,

			observe : {
				'ds.files' : '_updatePreview',
				'ds.data.title' : '_updateVisibility'
			},

			ready : function() {
				this.ds = document.querySelector('esis-datastore');
				this.$.dropZone.addEventListener('dragover', this._handleDragOver.bind(this), false);
				this.$.dropZone.addEventListener('drop', this._handleFileSelect.bind(this), false);
			},

			_updateVisibility : function() {
				if( this.ds.data.title.length > 0 ) {
					this.menuItem.style.display = 'block';
				} else {
					this.menuItem.style.display = 'none';
				}
			},

			_handleDragOver : function (evt) {
		  		evt.stopPropagation();
		  		evt.preventDefault();
		  		evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
		  	},

		  	_handleFileSelect : function(evt) {
			    evt.stopPropagation();
			    evt.preventDefault();

			    this.processing = true;

			    var files = evt.dataTransfer ? evt.dataTransfer.files : evt.target.files; // FileList object.

			    setTimeout(function(){
				    for (var i = 0, f; f = files[i]; i++) {
				    	this.ds.addFile(f, this.parseZip);
			            //esis.structures.importer.addFile(f, $('#parseZip').is(':checked'));
				    }

				    setTimeout(function(){
			    		this.processing = false;
			    		this.$.file.value = '';
				    }.bind(this), 500);
			    }.bind(this), 150);

			    
			    // once they add spectra, we only want them to update the spectra.json file
			    // via the add resources button and not the special 'update group by' button.
			    //esis.app.groupBy.hideUpdateButton();
		  	},

		  	_gotoInspect : function() {
		  		window.location.hash = '#parsed-spectra';
		  	},

		  	_updatePreview : function() {
		  		this.menuItem.setSecondaryHtml(this.ds.files.length+' File(s) Stagged');
		  	},

		  	toggleOptions : function() {
		  		this.showOptions = !this.showOptions;
		  	}
		});
	</script>
</polymer-element>