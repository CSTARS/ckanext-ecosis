<polymer-element name="esis-current-resources">
	<template>
		<style>
			table {
				width: 100%;
				border-spacing: 0px;
			}
			table th {
				text-align: left;
				border-bottom: 1px solid #ccc;
			}
			table tr:nth-child(even) {
				background-color: #eee;
			}
			table td {
				padding: 5px;
			}
			paper-icon-button {
				margin-top: 100px;
				background-color: rgb(210, 63, 49) !important;
				color: white;
			}
		</style>

		<div hidden?="{{!loading}}" style="margin-bottom:25px">
			Loading spectral package...<br />
			<span style="font-size:12px;color:#888">Resource Type and Parsed Spectra below will be incomplete till package is loaded.</span>
		</div>

		<table>
			<tr>
				<th>Filename</th><th>Resource Type</th><th>Parsed Spectra</th><th></th>
			</tr>
			<tr template repeat="{{res in resources}}">
				<td>{{res.name}}</td>
				<td>{{res.type}}</td>
				<td>{{res.count}}</td>
				<td><esis-ui-delete-button rid="{{res.id}}" label="{{res.name}}" on-delete="{{_deleteResource}}"></esis-ui-delete-button></td>
			</tr>
		</table>

		<paper-icon-button icon="warning" label="Delete Dataset" style="margin-top" on-click="{{_delete}}" raisedButton></paper-icon-button>
	</template>
	<script>
		Polymer('esis-current-resources',{
			menuItem : null,
			ds : {},
			loader : {},

			resources : [],

			loading : false,

			observe : {
				'ds.deleted' : '_update',
				'ds.existing.dataset' : '_update',
				'ds.existing.resources' : '_update',
				'ds.editMode' : '_updateVisibility'
			},

			ready : function() {
				this.ds = document.querySelector('esis-datastore');
				this.loader = document.querySelector('esis-dataset-loader');


				if( !this.loader.spectraPackageLoaded ) {
					this.loader.addEventListener('get-spectral-resource-progress', function(e){
						this.loading = true;
						this._updatePreview(e.detail);
					}.bind(this));

					this.loader.addEventListener('get-spectral-resource-complete', function(e){
						this.loading = false;
					}.bind(this));
				}
				
			},

			_update : function() {
				this._updateVisibility();

				this.async(function(){
					this._updateUI();
				});
			},

			_updateUI : function() {
				this.resources = [];

				for( var i = 0; i < this.ds.existing.resources.length; i++ ) {
					this.resources.push(this._groupData(this.ds.existing.resources[i]));
				}
			},

			_groupData : function(res) {

				var ui = {
					name : res.name,
					id   : res.id,
					type : 'Generic',
					count : 'NA'
				};

				var spCount = this._isData(res.id) 

				if( spCount > -1 ) {
					ui.count = spCount;
					ui.type = 'Spectra';
				} else if( this._isMetdata(res.id) ) {
					ui.type = 'Metadata';
				}

				return ui;
			},

			_isMetdata : function(id) {
				for( var i = 0; i < this.ds.existing.metadata.length; i++ ) {
					if( this.ds.existing.metadata[i].resource_id == id ) return true;
				}
				return false;
			},

			_isData : function(id) {
				for( var i = 0; i < this.ds.existing.data.length; i++ ) {
					if( this.ds.existing.data[i].resource_id == id ) return this.ds.existing.data[i].spectra_count;
				}
				return -1;
			},

			_updateVisibility : function() {
				this._updatePreview();
				if( !this.ds.editMode ) {
					this.menuItem.style.display = 'none';
					return;
				}

				if( this.ds.existing.resources.length > 0) {
					this.menuItem.style.display = 'block';
				} else {
					this.menuItem.style.display = 'none';
				}
			},

			_updatePreview : function(progress) {
				var html = this.ds.existing.resources.length+' Resource(s)';
				if( progress != null ) {
					html += '<br />Loading spectra package... '+progress+'%';
				}

		  		this.menuItem.setSecondaryHtml(html);
		  	},

		  	_deleteResource : function(e) {
		  		var id = e.currentTarget.getAttribute('rid');
		  		this.ds.removeResource(id);
		  	},

		  	_delete : function() {
		  		if( confirm('Are you sure your want to remove this dataset?') ) {
		  			if( confirm('Are you REALLY sure your want to remove this dataset?!?') ) {
		  				document.querySelector('esis-ckan').deletePackage(
		  					this.ds.package_id, 
		  					function(err, resp) {
		  						alert('package deleted');
		  						window.location = '/dataset';
		  					}
		  				);
		  			}
		  		}
		  	}
		});
	</script>
<polymer-element>