<link rel="import" href="../../components/paper-tabs/paper-tabs.html" />
<link rel="import" href="../ui/esis-ui-measurement.html" />
<link rel="import" href="../ui/esis-ui-datasheet.html" />

<polymer-element name="esis-inspect">
	<template>
		<style>
			paper-tabs::shadow #selectionBar {
				background-color: rgb(47, 155, 69);
			}
			paper-tab::shadow #ink {
				color: rgb(47, 155, 69);
			}
			a {
				color : #2f9b45;
				cursor: pointer;
			}
			.next {
				margin-top: 10px;
				padding: 10px;
				background-color: #f8f8f8;
				border-radius: 6px;
			}
			.s-selector {
				margin: 25px 0 10px 0;
				padding: 5px;
			}
			ul li {
				padding: 3px;
			}
		</style>

		<div style="color:#888;font-size:14px;margin-bottom:40px">
			<div>This panel shows the current state of your newely added spectra.  Please verify your spectral data looks correct.</div>
		</div>


		<div style="padding:15px">
			<div>
				<h2>
					<div layout horizontal>
						<div>
							{{measurements.length}} Spectra Found
						</div>
						<div flex style="text-align:right">
							<span class="s-selector">
								<span style="vertical-align:top">Select Spectra:</span> <paper-input style="width: 75px;font-size: 14px" inputValue="{{selectedIndex}}"></paper-input>
							</span>
						</div>
					</div>
				</h2>

				<a on-tap="{{goToAttrSettings}}" style="display:block;margin-top:10px">
                    <core-icon icon="settings"></core-icon> Configure Attributes
                </a>

				<esis-ui-measurement id="measurementUI" measurement="{{selectedSpectra}}" attrTypes="{{attrTypes}}"></esis-ui-measurement>
			</div>
		</div>

	</template>
	<script>
		Polymer('esis-inspect', {
			
			menuItem : null,

			attrTypes : {},

			spectraDatasheets : [],
			datasheets : [],
			measurements    : [],
			attachedHandlers : [],

			selectedSpectra : {},
			selectedIndex : 1,

			observe : {
				datasheets : '_update',
				selectedIndex : '_selectSpectra'
			},

			ready : function() {
				 window.addEventListener('polymer-ready', function(e) {
				 	this.async(function(){
				 		this.datasheets = document.querySelector('esis-datastore').datasheets;
				 	});
				}.bind(this));
			},

			_update : function() {
				this.async(function(){
					this.measurements = [];
					this.measurementDatasheets = [];

					for( var i = 0; i < this.datasheets.length; i++ ) {
						var f = this.datasheets[i];
						if( f.ignore ) continue;

						// listen for updates, make sure we only attach once
						if( this.attachedHandlers.indexOf(f) == -1 ) {
							this.attachedHandlers.push(f);
							f.addEventListener('datasheet-updated', function(){
								this._update();
							}.bind(this));
						}

						if( !f.isMetadata ) {
							this.measurementDatasheets.push(f);
						}

						for( var j = 0; j < f.measurements.length; j++ ) {
							this.measurements.push(f.measurements[j]);
						}
					}

					if( this.measurements.length > 0 ) {
						this.selectedSpectra = this.measurements[0];
					} else {
						this.selectedSpectra = {};
					}

					this._updateVisibility();
					this.menuItem.setSecondaryHtml(this.measurements.length+' Spectra Found');
				});
			},

			_updateVisibility : function() {
				var display = 'none';
				for( var i = 0; i < this.datasheets.length; i++ ) {
					if( this.datasheets[i].measurements.length > 0 ) {
						display = 'block';
						break;
					}
				}
				this.menuItem.style.display = display;
			},

			onShow : function() {
				this.attrTypes = document.querySelector('esis-datastore').getAllAttributeTypes();
				this._update();
				this.$.measurementUI.show();
			},

			_selectSpectra : function() {
				var index = parseInt(this.selectedIndex);
				if( index < 1 ) {
					index = 1;
					this.selectedIndex = 1;
				} else if ( index > this.measurements.length ) {
					index = this.measurements.length;
					this.selectedIndex = index;
				}

				this.selectedSpectra = this.measurements[index - 1];
			},

			_gotoAttrMap : function() {
				window.location.hash = '#attribute-map';
			},

			_gotoJoin : function() {
				window.location.hash = '#join';
			},

			_gotoGroup : function() {
				window.location.hash = '#group-by';
			},

			_goToAttrSettings : function() {
				window.location.hash = 'attribute-settings'
			}

		});
	</script>
</polymer-element>