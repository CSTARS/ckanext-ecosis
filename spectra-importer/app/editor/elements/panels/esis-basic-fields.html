<polymer-element name="esis-basic-fields">
	<template>
		<style>
			.form-wrap {
				padding: 15px 5px;
				margin: 15px 5px;
			}
			paper-input::shadow .focusedColor {
				background-color: #2f9b45;
				color: #2f9b45;
			}
			a {
				color : #2f9b45;
				cursor: pointer;
			}
			.gitInfo {
				margin: 30px;
				font-size: 12px;
				color: #888;
				font-style: italic;
			}
		</style>

		<div style="font-size: 14px; color: #888">
			<div style="color:#333; font-weight: bold; padding-bottom: 15px">Welcome {{user.username}}.</div>
			Fill out the basic information for your dataset.  Then you can add resource files such as metadata or spectra.<br />First time adding data?  Checkout the <a href="http://tutorial.ecospectra.org/" target="_blank">screencast and tutorial.</a>
		</div>

		<div class="form-wrap">
			<div hidden?="{{!ds.editMode}}">
				<div><b>Title:</b> {{ds.data.title}}</div>
				<div style="font-size:12px;color:#888;font-style:italic">
					URL: {{baseUrl}}{{ds.data.name}}
				</div>
			</div>
			<div hidden?="{{ds.editMode}}" > 
				<paper-input-decorator floatingLabel label="Title" >
					<input type="text" value="{{ds.data.title}}" />
				</paper-input-decorator>
				<div hidden?="{{!verifingName}}" style="color:#888;margin-left:20px;font-size:12px;padding:5px">
					Verifying name...
				</div>
				<div hidden?="{{validName || verifingName}}" style="color:red;margin-left:20px;font-size:12px;padding:5px">
					Invalid name.  A dataset with this name already exists.
				</div>
				<div style="margin-left:20px" hidden?="{{verifingName}}" >
					URL: {{baseUrl}}<span style="color: {{validName ? '#2f9b45' : 'red'}}">{{ds.data.name}}</span>
				</div>
				<div style="margin-left:20px" hidden?="{{!verifingName}}" >
					URL: {{baseUrl}}<span style="color: #888">{{ds.data.name}}</span>
				</div>
			</div>
		</div>

		<div class="form-wrap">
			<paper-input-decorator floatingLabel label="Description" style="width: 350px">
			    <textarea rows="3" value="{{ds.data.notes}}" ></textarea>
			</paper-input-decorator>
		</div>

		<div class="form-wrap">
			<esis-ui-token-input id="keywords" on-update="{{_setKeywords}}"></esis-ui-token-input>
		</div>

		<div class="form-wrap">
			License: <br />
			<template bind if="{{licenses.length == 0}}">
				Loading...
			</template>
			<select id="license" hidden?="{{licenses.length == 0}}" value="{{ds.data.license_id}}">
       			<template repeat="{{item in licenses}}">
       				<option value="{{item.id}}">{{item.title}}</option>
       			</template>
    		</select>
		</div>

		<div class="form-wrap">
			Organization: <br />
			<template bind if="{{organizations.length == 0}}">
				Loading...
			</template>
			<select id="organizations" hidden?="{{organizations.length == 0}}" value="{{ds.data.owner_org}}">
       			<template repeat="{{item in organizations}}">
       				<option value="{{item.id}}">{{item.display_name}}</option>
       			</template>
    		</select>
		</div>

		<div class="form-wrap" >
			Visibility: <br />
			<select id="visible" on-change="{{_updateVisibility}}" disabled?="{{!ds.data.owner_org || ds.data.owner_org == ''}}">
				<option value="false">Public</option>
				<option value="true">Private</option>
			</select>
			<div hidden?="{{ds.data.owner_org != ''}}" style="font-size:12px; color:#888; font-style:italic">
				You must select an organization if you wish to set the dataset to private, otherwise the dataset must be public.
			</div>
		</div>

		<div class="form-wrap">
			<paper-input type="text" value="{{ds.data.version}}" floatingLabel label="Version"></paper-input>
		</div>

		<div class="form-wrap">
			<paper-input type="text" floatingLabel label="Author" value="{{ds.data.author}}"></paper-input>
			<paper-input type="text" floatingLabel label="Author Email" value="{{ds.data.author_email}}"></paper-input>
		</div>

		<div class="form-wrap">
			<paper-input type="text" value="{{ds.data.maintainer}}" floatingLabel label="Maintainer" ></paper-input>
			<paper-input type="text" value="{{ds.data.maintainer_email}}" floatingLabel label="Maintainer Email" ></paper-input>
		</div>

		<template bind if="{{!ds.editMode && !creating && ds.data.title.length > 2}}">
			<paper-button class="btn-green" raised on-click="{{create}}">Create Dataset</paper-button>
		</template>
		<template bind if="{{creating}}">
			Creating Dataset...
		</template>

		<template bind if="{{ds.editMode}}">
			<core-icon icon="arrow-forward" style="color:#888;vertical-align:bottom"></core-icon> Now <a on-tap="{{_addResources}}">add resources</a> to your dataset.

			<div style="margin-top: 30px;" >
				<esis-ui-delete-button 
	                on-delete="{{_delete}}" label="Dataset">
	            </esis-ui-delete-button>
			</div>
		</template>

		<template bind if="{{git.branch != 'master'}}">
			<div class="gitInfo">
				<div><b>Branch:</b> {{git.branch}}</div>
				<div><b>Version:</b> {{git.version}}</div>
				<div><b>Commit:</b> {{git.commit}}</div>
			</div>
		</template>

	</template>
	<script>
		Polymer('esis-basic-fields', {
			ds : {},
			ckan : {},

			creating : false,

			validName : true,
			verifingName : false,

			menuItem : null,
			baseUrl : '',

			visible : true,

			// if we are creating a dataset and the dataset add button has been clicked
			// from inside an organization
			group : '',

			licenses : [],
			organizations : [],

			verifyNameTimer : -1,

			user : {},

			git : {
				branch : '',
			},

			observe : {
				'ds.data.title' : '_cleanTitle',
				'ds.data.owner_org' : '_onOrgChange',
				'ds.data.name' : '_verifyName',
				'ds.data.license_id' : '_updateLicenseName',
				'ds.data.hidden' : '_setVisibility',
				'ds.data.tags' : '_updateTokens',
				'ds.data.notes' : '_updateServer',
				'ds.data.version' : '_updateServer',
				'ds.data.maintainer' : '_updateServer',
				'ds.data.maintainer_email' : '_updateServer',
				'ds.data.author' : '_updateServer',
				'ds.data.author_email' : '_updateServer',
				'user' : 'updateOrgs'
			},

			ready : function() {
				this.user = esis.activeUser;
				this.baseUrl = esis.host+'/dataset/';

				this.group = this._getVar('group');

				this.ds = document.querySelector('esis-datastore');
				this.ckan = document.querySelector('esis-ckan');

				$.get(esis.host+'/api/3/action/license_list', function(resp){
					this.licenses = resp.result;
				}.bind(this));

				/*$.get(esis.host+'/api/3/action/organization_list?all_fields=true', function(resp){
					this.organizations = resp.result;
					this.organizations.splice(0,0, {
						id : '',
						display_name : 'No Organization'
					});
					
					if( this.group ) this.ds.data.owner_org = this.group;

				}.bind(this));*/
				this.updateOrgs();


				$.get(esis.host+'/spectra/gitInfo', function(resp){
					this.git = resp;
				}.bind(this));
			},

			updateOrgs : function() {
				if( !this.user.organizations ) return;
				this.organizations = $.extend(true, [], this.user.organizations);
				this.organizations.splice(0,0, {
					id : '',
					display_name : 'No Organization'
				});
				if( this.group ) this.ds.data.owner_org = this.group;
			},

			_verifyName : function() {
				if( this.ds.data.name == '' || this.ds.editMode ) return;

				if( this.verifyNameTimer != -1 ) clearTimeout(this.verifyNameTimer);
				this.verifingName = true;

				this.verifyNameTimer = setTimeout(function(){
					this.ckan.getPackage(this.ds.data.name, function(err, resp){
						this.verifingName = false;
						if( err && err.error && err.error.message == "Not found" ) {
							this.validName = true;
						} else {
							this.validName = false;
						}
					}.bind(this));
				}.bind(this), 500);
			},

			_cleanTitle : function() {
				this.ds.data.name = this.ds.data.title.toLowerCase().replace(/[^a-z0-9]/g,'-');
				if( this.ds.data.title == '' ) return;
				this.menuItem.setSecondaryHtml('<b>Dataset:</b> '+this.ds.data.title);
				this._updateServer();
			},

			
			updateTimer : -1,
			_updateServer : function() {
				if( !this.ds.loaded || !this.ds.editMode ) return;

				if( this.updateTimer != -1 ) clearTimeout(this.updateTimer);

				this.updateTimer = setTimeout(function(){
					this.updateTimer = -1;
					this._actuallyUpdateServer();
				}.bind(this), 3000);
			},

			_actuallyUpdateServer : function() {
				// make sure we have the correct package state
				document.querySelector('esis-ckan').getPackage(
					this.ds.data.name,
					function(err, resp) {
						if( err ) return alert('Failed to fetch for dataset update :(');
						if( !resp ) return alert('Failed to fetch for dataset update dataset :(');

						var metadata = resp;
						for( var key in this.ds.data ) {
							metadata[key] = this.ds.data[key];
						}

						document.querySelector('esis-ckan').updatePackage(
							metadata,
							function(err, resp) {
								this.creating = false;
								if( err ) return alert('Failed to update dataset :(');
								if( !resp ) return alert('Failed to update dataset :(');
								if( !resp.id ) return alert('Failed to update dataset :(');

							}.bind(this)
						);
					}.bind(this)
				);
			},

			_onOrgChange : function() {
				if( this.ds.data.owner_org == '' ) {
					this.ds.owner_org_name = '';
					this.ds.data.private = false;
				} else {
					var opt = this.$.organizations.querySelector('option:checked');
					if( opt ) this.ds.owner_org_name = opt.innerHTML;	
				}
				this._updateServer();
			},

			_addResources : function() {
				window.location.hash = "#resources";
			},

			_setKeywords : function(e) {
				this.ds.data.tags = e.detail;
				this._updateServer();
			},

			_updateTokens : function() {
				for( var i = 0; i < this.ds.data.tags.length; i++ ) {
					this.$.keywords.addToken({value:this.ds.data.tags[i].display_name});
				}
				this._updateServer();
			},

			_updateLicenseName : function() {
				var opt = this.$.license.querySelector('option:checked');
				if( opt ) this.ds.data.license_title = opt.innerHTML;
				this._updateServer();
			},

			_updateVisibility : function() {
				if( this.$.visible.value == 'false' ) this.ds.data.hidden = true;
				else this.ds.data.hidden = false;
				this._updateServer();
			},

			_setVisibility : function() {
				this.$.visible.value = (this.ds.hidden)+'';
				this._updateServer();
			},

			create : function() {
				this.creating = true;
				document.querySelector('esis-ckan').createPackage(
					this.ds.data,
					function(err, resp) {
						this.creating = false;
						if( err ) return alert('Failed to create dataset :(');
						if( !resp ) return alert('Failed to create dataset :(');
						if( !resp.id ) return alert('Failed to create dataset :(');

						this.ds.editMode = true;
						this.ds.package_id = resp.id;
						console.log(resp)
					}.bind(this)
				);
			},

			_delete : function() {
		  		if( confirm('Are you sure your want to remove this dataset?') ) {
		  			if( confirm('Are you REALLY sure your want to remove this dataset?!?') ) {
		  				document.querySelector('esis-ckan').deletePackage(
		  					this.ds.package_id, 
		  					function(err, resp) {
		  						alert('package deleted');
		  						window.location = '/dataset';
		  					}
		  				);
		  			}
		  		}
		  	},

		  	_getVar : function(variable) {
       			var query = window.location.search.substring(1);
       			var vars = query.split("&");
       			for (var i = 0; i < vars.length; i++) {
               		var pair = vars[i].split("=");
               		if( pair[0] == variable ) return pair[1];
       			}
       			return null;
			}

		});
	</script>
</polymer-element>