<link rel="import" href="../../components/paper-tabs/paper-tabs.html" />
<link rel="import" href="../ui/esis-ui-measurement.html" />
<link rel="import" href="../ui/esis-ui-datasheet.html" />

<polymer-element name="esis-parsed-spectra">
	<template>
		<style>
			paper-tabs::shadow #selectionBar {
				background-color: rgb(47, 155, 69);
			}
			paper-tab::shadow #ink {
				color: rgb(47, 155, 69);
			}
			a {
				color : #2f9b45;
				cursor: pointer;
			}
			.next {
				margin-top: 10px;
				padding: 10px;
				background-color: #f8f8f8;
				border-radius: 6px;
			}
			.s-selector {
				margin: 25px 0 10px 0;
				padding: 5px;
			}
			ul li {
				padding: 3px;
			}
		</style>

		<div style="color:#888;font-size:14px;margin-bottom:40px">
			<div>This panel shows the current state of your newely added spectra.  Please verify your spectral data looks correct.</div>

			<div class="next">
				<h4><core-icon icon="arrow-forward" style="color:#888;vertical-align:bottom"></core-icon> Possible next steps include:</h4>
				<ul>
					<li><a on-tap="{{_gotoAttrMap}}">Set Attribute Map</a> - If you have custom fields below (marked with an '*') that map to Ecosis metadata fields, please upload a attribute map file.</li>
					<li><a on-tap="{{_gotoJoin}}">Join Auxiliary Metadata</a> - If you uploaded your metadata in a separate file you will need to join the metadata to your spectra.</li>
					<li><a on-tap="{{_gotoGroup}}">Set Dataset Group</a> - If your dataset has logical groups users should know about (ex: time series, spatially related) you can define those groups here.</li>
				</ul>
			</div>
		</div>


		<esis-ui-card style="padding:15px">
			<div>
				<h2>{{measurements.length}} Spectra Found</h2>
				<div>
					<span class="bs-label success-label">File Level Metadata</span> 
					<span class="bs-label info-label">Spectra Level Metadata</span> 
					<span class="bs-label warning-label">Linked Metadata</span> <br>
					<div style="color:#888;padding:8px;font-size:14px">* Custom non-ecosis field</div>
				</div>

				<div class="s-selector">
					Select Spectra: 
					<select id="spectraSelector" on-change="{{_selectSpectra}}">
						<template repeat="{{sp,i in measurements}}">
							<option value="{{i}}">{{i+1}}</option>
						</template>
					</select>
				</div>

				<esis-ui-measurement id="measurementUI" measurement="{{selectedSpectra}}"></esis-ui-measurement>
			</div>
		</esis-ui-card>

	</template>
	<script>
		Polymer('esis-parsed-spectra', {
			
			menuItem : null,

			spectraDatasheets : [],
			datasheets : [],
			measurements    : [],
			attachedHandlers : [],

			selectedSpectra : {},

			observe : {
				datasheets : '_update'
			},

			ready : function() {
				 window.addEventListener('polymer-ready', function(e) {
				 	this.async(function(){
				 		this.datasheets = document.querySelector('esis-datastore').datasheets;
				 	});
				}.bind(this));
			},

			_update : function() {
				this.async(function(){
					this.measurements = [];
					this.measurementDatasheets = [];

					for( var i = 0; i < this.datasheets.length; i++ ) {
						var f = this.datasheets[i];

						// listen for updates, make sure we only attach once
						if( this.attachedHandlers.indexOf(f) == -1 ) {
							this.attachedHandlers.push(f);
							f.addEventListener('datasheet-updated', function(){
								this._update();
							}.bind(this));
						}

						if( !f.isMetadata ) {
							this.measurementDatasheets.push(f);
						}

						for( var j = 0; j < f.measurements.length; j++ ) {
							this.measurements.push(f.measurements[j]);
						}
					}

					if( this.measurements.length > 0 ) {
						this.selectedSpectra = this.measurements[0];
					}

					this._updateVisibility();
					this.menuItem.setSecondaryHtml(this.measurements.length+' Spectra Found');
				});
			},

			_updateVisibility : function() {
				var display = 'none';
				for( var i = 0; i < this.datasheets.length; i++ ) {
					if( this.datasheets[i].measurements.length > 0 ) {
						display = 'block';
						break;
					}
				}
				this.menuItem.style.display = display;
			},

			onShow : function() {
				this._update();
				this.$.measurementUI.show();
			},

			_selectSpectra : function() {
				this.selectedSpectra = this.measurements[parseInt(this.$.spectraSelector.value)];
			},

			_gotoAttrMap : function() {
				window.location.hash = '#attribute-map';
			},

			_gotoJoin : function() {
				window.location.hash = '#join';
			},

			_gotoGroup : function() {
				window.location.hash = '#group-by';
			}

		});
	</script>
</polymer-element>