<link rel="import" href="esis-metadata.html"/>
<link rel="import" href="esis-measurement.html"/>

<polymer-element name="esis-datasheet">
	<template></template>
	<script>
		Polymer('esis-datasheet',{
			// parent esis-file element
			//file : {},

			// parsed datasheet contents
			contents : {},

			measurements : [],
			metadata : {},

			ckanId : '',

			// spectra or timeseries... really this is what format the data is presented in
			dataType : '',

			// we will try and detect this flag.  but let users select if we get it wrong
			isMetadata : false,

			// was this generated from existing datasheet (one that has already been added)
			isExisting : false,

			// map of known attribute names to the attribute type and flag
			attributeTypes : null,

			editMode : false,

			// bindable flag for UI
			updating : true,

			label : '',

			observe : {
				contents : '_update',
				dataType : '_extract',
				isMetadata : '_extract'
			},

			// what information needs to be stored here?
			// we need to be able to know what data attributes are file and what 
			// are part of tabular context...
			attributeTypes : null,

			ready : function() {
				this.measurements = [];
				this.metadata = {};
				this.contents = {};
				this.attributeTypes = {};
			},

			// run the extractor again
			// most likely called when the dataType changes
			_extract : function(oldVal, newVal) {
				if( oldVal === '' ) return;
				this.updating = true;

				setTimeout(function(){
					var extractor = document.querySelector('esis-extractor');
					var resp = extractor.run((this.isMetadata ? 'metadata' : this.dataType), this.contents.array);
					
					// TODO: how do we want to handle resp.error?

					this.contents.metadata = resp.metadata;
					this.contents.measurements = resp.measurements;
					this.attributeTypes = resp.attributeTypes;
					this.contents.joindata = resp.joindata;

					this._update();
				}.bind(this), 250);
			},


			_update : function() {
				this.updating = true;
				this._setTitle();

				this.measurements = [];

				if( this.contents.measurements && this.contents.measurements.length > 0 ) {
					for( var i = 0; i < this.contents.measurements.length; i++ ) {

						var sp = document.createElement('esis-measurement');

						sp.datapoints = this.contents.measurements[i].datapoints;
						sp.metadata.measurement = this.contents.measurements[i].metadata;
						sp.filename = this.contents.info.name.replace(/.*\//,'');
						sp.sheetname = this.contents.sheetName;

						if( this.contents.metadata ) {
							for( var key in this.contents.metadata ) {
								sp.metadata.contents[key] = this.contents.metadata[key];
							}
						}

						this.measurements.push(sp);
					}

					//
				} else if( this.contents.joindata && this.contents.joindata.length > 0 ) {
					
					this.metadata = document.createElement('esis-metadata');
					this.metadata.contents = this.contents;
					this.metadata.metadata = this.contents.joindata;
					this.isMetadata = true;
				}

				this.updating = false;
				this.fire('datasheet-updated');
			},

			setResourceId : function(resourceId) {
				this.resourceId = resourceId;
				for( var i = 0; i < this.measurements.length; i++ ) {
					this.measurements[i].resourceId = resourceId;
				}
				this.metadata.resourceId = resourceId;
			},

			joinAttributes : function() {
				if( !this.isMetadata ) return [];
				return this.metadata.joinAttributes();
			},

			_setTitle : function() {
				if( !this.contents ) return;
				if( Object.keys(this.contents).length == 0 ) return;

				var name = this.contents.name || this.contents.info.name;
				this.label = name.replace(/.*\//,'');
				if( this.contents.sheetName && this.contents.sheetName != '' ) this.label += ' - '+this.contents.sheetName;
				if( this.label.length == 0 || this.label == ' ' ) this.label = name;
			}
		});
	</script>
</polymer-element>