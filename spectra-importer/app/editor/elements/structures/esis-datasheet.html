<link rel="import" href="esis-metadata.html"/>
<link rel="import" href="esis-measurement.html"/>

<polymer-element name="esis-datasheet">
	<template></template>
	<script>
		Polymer('esis-datasheet',{
			// parent esis-file element
			//file : {},

			// parsed datasheet contents
			contents : {},

			measurements : [],
			metadata : {},

			ckanId : '',

			dataType : '',

			// we will try and detect this flag.  but let users select if we get it wrong
			isMetadata : false,

			// was this generated from existing datasheet (one that has already been added)
			isExisting : false,

			editMode : false,

			label : '',

			observe : {
				contents : '_update',
				dataType : '_extract'
			},

			knownAttributes : [],

			ready : function() {
				this.measurements = [];
				this.metadata = {};
				this.contents = {};
			},

			// run the extractor again
			_extract : function(oldVal, newVal) {
				if( oldVal == '' ) return;

				setTimeout(function(){
					var extractor = document.querySelector('esis-extractor');
					var resp = extractor.run((this.isMetadata ? 'metadata' : this.dataType), this.contents.array);
					
					this.contents.metadata = resp.metadata;
					this.contents.measurements = resp.measurements;
					this._update();
				}.bind(this), 250);
			},

			_update : function() {
				this._setTitle();

				this.measurements = [];

				if( this.contents.measurements && this.contents.measurements.length > 0 ) {
					for( var i = 0; i < this.contents.measurements.length; i++ ) {

						var sp = document.createElement('esis-measurement');

						sp.datapoints = this.contents.measurements[i].data;
						sp.metadata.measurement = this.contents.measurements[i].metadata;
						sp.filename = this.contents.info.name.replace(/.*\//,'');
						sp.sheetname = this.contents.sheetName;

						if( this.contents.metadata ) {
							for( var key in this.contents.metadata ) {
								sp.metadata.contents[key] = this.contents.metadata[key];
							}
						}

						this._updateKnownAttributes(sp);
						this.measurements.push(sp);
					}

					this.fire('measurement-updated', this.knownAttributes);
				} else if( this.contents.joindata && this.contents.joindata.length > 0 ) {
					
					this.metadata = document.createElement('esis-metadata');
					this.metadata.contents = this.contents;
					this.metadata.metadata = this.contents.joindata;
					this.isMetadata = true;
				}
			},

			setResourceId : function(resourceId) {
				this.resourceId = resourceId;
				for( var i = 0; i < this.measurements.length; i++ ) {
					this.measurements[i].resourceId = resourceId;
				}
				this.metadata.resourceId = resourceId;
			},

			_updateKnownAttributes : function(measurement) {
				var list = measurement.getAttributes();

				for( var i = 0; i < list.length; i++ ) {
					if( this.knownAttributes.indexOf(list[i]) == -1 ) {
						this.knownAttributes.push(list[i]);
					}
				}
			},

			joinAttributes : function() {
				if( !this.isMetadata ) return [];
				return this.metadata.joinAttributes();
			},

			_setTitle : function() {
				if( !this.contents ) return;
				if( Object.keys(this.contents).length == 0 ) return;

				var name = this.contents.name || this.contents.info.name;
				this.label = name.replace(/.*\//,'');
				if( this.contents.sheetName && this.contents.sheetName != '' ) this.label += ' - '+this.contents.sheetName;
				if( this.label.length == 0 || this.label == ' ' ) this.label = name;
			}
		});
	</script>
</polymer-element>