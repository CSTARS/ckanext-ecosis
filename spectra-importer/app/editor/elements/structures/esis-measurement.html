<polymer-element name="esis-measurement">
	<template></template>
	<script>
		Polymer('esis-measurement', {
			datapoints : [],
			metadata : {},

			filename : '',
			sheetname : '',

			error : null,
			resourceId : '',
			joinOrder : ['joined', 'file', 'measurement'],
			
			spectra_id : '',

			ready : function() {
				this.data = [];
				this.metadata = {
					measurement : {},
					file : {},
					joined : {}
				}
			},

			// newType should be 'data' or 'metadata'
			switchAttributeType : function(attr, newType) {
				// move from metadata to datapoints array
				if( newType == 'data' && this.metadata.measurement && this.metadata.measurement[attr] ) {
					this.datapoints.push({
						key : attr,
						value : this.metadata.measurement[attr]
					});
					delete this.metadata.measurement[attr];

				// move from datapoints array to metadata
				} else {
					var index = this.getDataPointIndex(attr);
					if( index == -1 ) return;

					if( !this.metadata.measurement ) this.measurement.measurement = {};
					this.measurement.measurement[this.datapoints[index].key] = this.datapoints[index].value;
					this.datapoints.splice(index, 1);
				}
			},

			getDataPointIndex : function(attr) {
                for( var i = 0; i < this.datapoints.length; i++ ) {
                    if( this.datapoints[i].key == attr ) return i;
                }
                return -1;
            },

			getAttributes : function() {
				var attrs = [], type, i, key;

				for( i = 0; i < this.joinOrder.length; i++ ) {
					type = this.metadata[this.joinOrder[i]];
					for( key in type ) {
						if( attrs.indexOf(key) == -1 ) attrs.push(key);
					}
				}

				return attrs;
			},

			// shortend so we don't colid on ns
			getMetadataAttr : function(attr) {
				for( var i = 0; i < this.joinOrder.length; i++ ) {
					if( this.metadata[this.joinOrder[i]][attr] ) {
						return this.metadata[this.joinOrder[i]][attr];
					}
				}
				return null;
			},

			mergeMetadata : function() {
				var md = {};
				for( var i = 0; i < this.joinOrder.length; i++ ) {
					for( var key in this.metadata[this.joinOrder[i]] ) {
						md[key] = this.metadata[this.joinOrder[i]][key];
					}
				}
				return md;
			},

			updateUid : function()  {
				var uid = document.querySelector('esis-datastore').measurementDisambiguator;

				var field = '';
				if( uid && uid.length > 0 ) {
					for( var i = 0; i < this.joinOrder.length; i++ ) {
						if( this.metadata[this.joinOrder[i]][field] ) {
							field = this.metadata[this.joinOrder[i]][field];
							break;
						}
					}
				}

				if( uid.length > 0 ) {
					this.measurement_id = md5(JSON.stringify(this.datapoints)+field);
				} else {
					this.measurement_id = md5(JSON.stringify(this.datapoints));
				}
			}

		});
	</script>
</polymer-element>